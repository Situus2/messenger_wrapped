<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Messenger Wrapped 2025 - Wersja PrzeglƒÖdarkowa</title>
    
    <!-- Premium Font -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;500;700;800&display=swap" rel="stylesheet">
    
    <!-- JSZip for ZIP handling -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <!-- PyScript -->
    <link rel="stylesheet" href="https://pyscript.net/releases/2024.1.1/core.css" />
    <script type="module" src="https://pyscript.net/releases/2024.1.1/core.js"></script>

    <style>
        :root {
            --bg-deep: #000000;
            --text-white: #ffffff;
            --text-muted: rgba(255, 255, 255, 0.6);
            
            /* Kolory Premium Neon */
            --accent-1: #2E3DE3;
            --accent-2: #FF0080;
            --accent-3: #7928CA;
            --accent-gradient: linear-gradient(135deg, #FF0080 0%, #7928CA 100%);
            
            --glass-bg: rgba(20, 20, 20, 0.65);
            --glass-border: rgba(255, 255, 255, 0.1);
            --glass-highlight: rgba(255, 255, 255, 0.05);
            --glass-input: rgba(255, 255, 255, 0.03);
            --item-hover: rgba(255, 255, 255, 0.12);
            --item-selected: rgba(46, 61, 227, 0.3);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--bg-deep);
            color: var(--text-white);
            height: 100dvh;
            width: 100vw;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* --- T≈ÅO AURORA --- */
        .aurora-container {
            position: absolute; inset: 0; z-index: 0; overflow: hidden; background: #000;
        }
        .aurora-blob {
            position: absolute; border-radius: 50%; filter: blur(90px); opacity: 0.5;
            animation: drift 20s infinite alternate cubic-bezier(0.4, 0, 0.2, 1);
        }
        .blob-1 { width: 90vw; height: 90vw; background: var(--accent-1); top: -30%; left: -20%; animation-duration: 25s; }
        .blob-2 { width: 80vw; height: 80vw; background: var(--accent-2); bottom: -20%; right: -20%; animation-delay: -5s; }
        .blob-3 { width: 60vw; height: 60vw; background: var(--accent-3); top: 30%; left: 30%; animation-delay: -10s; opacity: 0.3; }

        @keyframes drift {
            0% { transform: translate(0, 0) scale(1); }
            100% { transform: translate(30px, -50px) scale(1.1); }
        }

        .noise {
            position: absolute; inset: 0; z-index: 1; opacity: 0.08; pointer-events: none;
            background: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
        }

        /* --- FRAME --- */
        .app-frame {
            position: relative; width: 100%; height: 100%; z-index: 10;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 24px;
        }
        @media (min-width: 500px) {
            .app-frame {
                max-width: 720px; max-height: 900px;
                height: 85vh; border-radius: 40px; border: 8px solid #1a1a1a;
                box-shadow: 0 0 0 1px #333, 0 40px 100px rgba(0,0,0,0.8);
                background: #000; overflow: hidden;
            }
            .aurora-container { border-radius: 32px; }
            .app-frame .aurora-container { position: absolute; inset: 0; }
        }

        /* --- CONTENT --- */
        .content-wrapper {
            position: relative; z-index: 2; width: 100%;
            display: flex; flex-direction: column; gap: 20px;
            opacity: 0; transform: translateY(20px);
            animation: fadeIn 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        @keyframes fadeIn { to { opacity: 1; transform: translateY(0); } }

        h1 { font-size: 3rem; font-weight: 800; line-height: 1; margin-bottom: 10px; letter-spacing: -1.5px; text-align: center; }
        .brand-gradient { background: var(--accent-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        .privacy-badge {
            display: flex; align-items: center; justify-content: center; gap: 8px;
            background: rgba(46, 227, 100, 0.1); border: 1px solid rgba(46, 227, 100, 0.3);
            color: #2ee364; padding: 10px 16px; border-radius: 50px;
            font-size: 0.8rem; font-weight: 600; margin: 0 auto 20px auto; width: fit-content;
        }

        /* --- UPLOAD ZONE --- */
        .upload-card {
            background: var(--glass-bg);
            backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px);
            border: 1px solid var(--glass-border); border-top: 1px solid var(--glass-highlight);
            border-radius: 32px; padding: 30px;
            text-align: center;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .drop-zone {
            border: 2px dashed rgba(255,255,255,0.2);
            border-radius: 20px;
            padding: 40px 20px;
            margin: 20px 0;
            background: var(--glass-input);
            transition: all 0.3s ease;
            cursor: pointer; position: relative;
        }
        .drop-zone:hover, .drop-zone.dragover {
            border-color: #FF0080; background: rgba(255, 0, 128, 0.05);
        }

        .upload-icon { font-size: 3rem; margin-bottom: 15px; display: block; filter: drop-shadow(0 0 10px rgba(255,255,255,0.3)); }
        
        .file-input {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer;
        }

        .btn-main {
            width: 100%; padding: 18px;
            background: #fff; color: #000;
            border: none; border-radius: 16px;
            font-size: 1.1rem; font-weight: 800; letter-spacing: 0.5px;
            cursor: pointer; transition: transform 0.2s, opacity 0.2s;
            opacity: 0.5; pointer-events: none;
        }
        .btn-main.ready { opacity: 1; pointer-events: auto; background: var(--accent-gradient); color: #fff; box-shadow: 0 0 30px rgba(255,0,128,0.4); }
        .btn-main:active { transform: scale(0.96); }

        .helper-text { font-size: 0.85rem; color: var(--text-muted); margin-top: 15px; line-height: 1.5; }
        .link { color: #fff; text-decoration: underline; cursor: pointer; font-weight: 600; }

        /* --- INSTRUCTION MODAL --- */
        .modal-overlay {
            position: absolute; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(15px);
            z-index: 100; display: none; /* JS toggles flex */
            flex-direction: column; align-items: center; justify-content: center;
            opacity: 0; transition: opacity 0.3s ease;
        }
        .modal-overlay.open { opacity: 1; }
        
        .modal-card {
            width: 90%; max-width: 380px; max-height: 80%; overflow-y: auto;
            background: rgba(25, 25, 25, 0.9); border: 1px solid var(--glass-border);
            border-radius: 28px; padding: 25px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.8);
            transform: scale(0.95); transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .modal-overlay.open .modal-card { transform: scale(1); }

        .step-item {
            display: flex; gap: 15px; margin-bottom: 20px; align-items: flex-start;
        }
        .step-num {
            background: var(--glass-input); color: #FF0080;
            width: 30px; height: 30px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-weight: 800; flex-shrink: 0; border: 1px solid rgba(255, 0, 128, 0.3);
        }
        .step-content { font-size: 0.9rem; line-height: 1.5; color: #ddd; }
        .step-content strong { color: #fff; }

        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .btn-close {
            background: var(--glass-input); border: none; color: #fff;
            width: 32px; height: 32px; border-radius: 50%; cursor: pointer;
            font-size: 1.2rem; display: flex; align-items: center; justify-content: center;
        }

        /* --- LOADING OVERLAY --- */
        .loader-overlay {
            position: absolute; inset: 0; background: rgba(0,0,0,0.9); backdrop-filter: blur(10px);
            z-index: 200; display: none; flex-direction: column; align-items: center; justify-content: center;
        }
        .spinner {
            width: 50px; height: 50px; border: 4px solid rgba(255,255,255,0.1); border-top: 4px solid #FF0080;
            border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- CHAT SELECTION STYLES --- */
        .select-view { display: none; width: 100%; flex-direction: column; height: 100%; }
        
        .header-section {
            margin-bottom: 20px; text-align: center;
            animation: slideDown 0.6s cubic-bezier(0.16, 1, 0.3, 1);
            position: relative; z-index: 20;
        }
        h2.select-title { font-size: 1.8rem; font-weight: 800; margin-bottom: 5px; color: #fff; }
        p.select-subtitle { color: var(--text-muted); font-size: 0.9rem; margin-bottom: 20px; }

        .search-box {
            position: relative; width: 100%;
        }
        .search-input {
            width: 100%; padding: 14px 14px 14px 45px;
            background: var(--glass-input); border: 1px solid var(--glass-border);
            border-radius: 16px; color: #fff; font-size: 1rem; font-family: inherit;
            outline: none; transition: border-color 0.2s, background 0.2s;
            backdrop-filter: blur(10px);
        }
        .search-input::placeholder { color: rgba(255,255,255,0.5); }
        .search-input:focus { border-color: var(--accent-2); background: rgba(255,255,255,0.15); }
        .search-icon {
            position: absolute; left: 14px; top: 50%; transform: translateY(-50%);
            opacity: 0.7; font-size: 1.1rem; color: #fff;
        }

        .chat-list-container {
            flex: 1; overflow-y: auto;
            margin-bottom: 20px;
            padding-right: 5px;
            position: relative; z-index: 20;
            scrollbar-width: thin; scrollbar-color: rgba(255,255,255,0.2) transparent;
        }
        .chat-list-container::-webkit-scrollbar { width: 4px; }
        .chat-list-container::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 4px; }

        .chat-item {
            display: flex; align-items: center; gap: 15px;
            padding: 12px 16px; margin-bottom: 8px;
            background: var(--glass-input);
            border: 1px solid transparent; border-radius: 18px;
            cursor: pointer; transition: all 0.2s ease;
            opacity: 0;
            animation: fadeInItem 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }
        .chat-item:hover { background: var(--item-hover); transform: translateX(2px); }
        .chat-item.selected {
            background: var(--item-selected);
            border-color: var(--accent-1);
            box-shadow: 0 0 20px rgba(46, 61, 227, 0.2);
        }

        .avatar {
            width: 48px; height: 48px; border-radius: 50%;
            background: linear-gradient(135deg, #444, #222);
            display: flex; align-items: center; justify-content: center;
            font-weight: 700; font-size: 1.1rem; color: #fff;
            flex-shrink: 0; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .chat-info { flex: 1; min-width: 0; }
        .chat-name { 
            font-weight: 700; font-size: 1rem; margin-bottom: 3px; 
            color: #ffffff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .chat-meta { font-size: 0.8rem; color: var(--text-muted); display: flex; gap: 8px; }

        .select-indicator {
            width: 20px; height: 20px; border-radius: 50%;
            border: 2px solid rgba(255,255,255,0.3);
            display: flex; align-items: center; justify-content: center;
            transition: all 0.2s; flex-shrink: 0;
        }
        .chat-item.selected .select-indicator {
            border-color: var(--accent-2); background: var(--accent-2);
        }
        .select-indicator::after {
            content: '‚úì'; font-size: 0.7rem; color: #fff; opacity: 0; transform: scale(0); transition: all 0.2s;
        }
        .chat-item.selected .select-indicator::after { opacity: 1; transform: scale(1); }

        .footer-section { text-align: center; position: relative; z-index: 20; }
        .btn-next {
            width: 100%; padding: 18px;
            background: var(--accent-gradient); color: #fff;
            border: none; border-radius: 100px;
            font-size: 1.1rem; font-weight: 800; cursor: pointer;
            box-shadow: 0 0 30px rgba(255, 0, 128, 0.3);
            opacity: 0.5; pointer-events: none; filter: grayscale(0.8);
            transition: all 0.3s;
        }
        .btn-next.active { opacity: 1; pointer-events: auto; filter: grayscale(0); transform: translateY(-2px); }
        .btn-next:active { transform: scale(0.97); }

        @keyframes slideDown { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes fadeInItem { 0% { opacity: 0; transform: translateY(15px); } 100% { opacity: 1; transform: translateY(0); } }

        /* --- EXIT ANIMATION (From wybor_osob.html) --- */
        .app-frame.exit-active .header-section,
        .app-frame.exit-active .chat-list-container,
        .app-frame.exit-active .footer-section,
        .app-frame.exit-active .upload-card, /* Support upload view exit too if needed */
        .app-frame.exit-active h1,
        .app-frame.exit-active .helper-text {
            opacity: 0;
            filter: blur(15px);
            transform: scale(0.95) translateY(30px);
            transition: all 1.2s cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        /* Kaskadowe znikanie */
        .app-frame.exit-active .header-section { transition-delay: 0ms; }
        .app-frame.exit-active .chat-list-container { transition-delay: 100ms; }
        .app-frame.exit-active .footer-section { transition-delay: 200ms; }

        .app-frame.exit-active .aurora-blob {
            transform: scale(2.5) rotate(10deg);
            filter: blur(60px);
            opacity: 0.6;
            transition: all 2s ease-in-out;
        }

        .reveal-sparkle {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0) rotate(-45deg);
            font-size: 6rem;
            z-index: 300;
            opacity: 0;
            pointer-events: none;
            transition: all 1s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .app-frame.exit-active .reveal-sparkle {
            transform: translate(-50%, -50%) scale(1) rotate(0deg);
            opacity: 1;
            transition-delay: 300ms; /* Pojawia siƒô gdy reszta znika */
        }

    </style>
</head>
<body>

    <div class="app-frame" id="mainFrame">
        <!-- T≈Ço -->
        <div class="aurora-container">
            <div class="aurora-blob blob-1"></div>
            <div class="aurora-blob blob-2"></div>
            <div class="aurora-blob blob-3"></div>
            <div class="noise"></div>
        </div>

        <div class="reveal-sparkle">‚ú®</div>

        <!-- VIEW 1: UPLOAD -->
        <div class="content-wrapper" id="uploadView">
            <div style="text-align: center; margin-bottom: 10px;">
                <div style="font-size: 4rem; margin-bottom: 10px;">üëã</div>
                <h1>Stw√≥rz swoje<br><span class="brand-gradient">WRAPPED</span></h1>
            </div>

            <div class="upload-card">
                <div class="privacy-badge">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
                    <span>Dane sƒÖ prywatne (GitHub Pages)</span>
                </div>

                <p style="font-size: 0.95rem; color: var(--text-muted); margin-bottom: 10px;">
                    Plik jest analizowany lokalnie przez PyScript.<br>Nic nie opuszcza Twojej przeglƒÖdarki.
                </p>

                <div class="drop-zone" id="dropZone">
                    <input type="file" id="fileInput" class="file-input" accept=".json,.zip">
                    <span class="upload-icon">üìÇ</span>
                    <h3 id="dropText" style="font-weight: 700;">Wybierz plik ZIP lub JSON</h3>
                    <p style="font-size: 0.8rem; color: var(--text-muted); margin-top: 5px;">
                        z historiƒÖ czatu
                    </p>
                </div>

                <button class="btn-main" id="generateBtn">Analizuj Plik üîé</button>
            </div>

            <div style="text-align: center; margin-top: 10px;">
                <p class="helper-text">Jak pobraƒá dane? <br><span class="link" id="openHelp">Zobacz instrukcjƒô</span></p>
            </div>
        </div>

        <!-- VIEW 2: SELECT PERSON (Initially Hidden) -->
        <div class="select-view" id="selectView">
            <!-- Nag≈Ç√≥wek -->
            <div class="header-section">
                <h2 class="select-title">Wybierz rozmowƒô</h2>
                <p class="select-subtitle">Znaleziono <span id="chatCount">0</span> czat√≥w w pliku</p>
                
                <div class="search-box">
                    <span class="search-icon">üîç</span>
                    <input type="text" class="search-input" id="searchInput" placeholder="Szukaj imienia i nazwiska...">
                </div>
            </div>

            <!-- Lista Czat√≥w -->
            <div class="chat-list-container" id="chatList">
                <!-- Tutaj JS wstawi elementy -->
            </div>

            <!-- Przycisk Dalej -->
            <div class="footer-section">
                <button class="btn-next" id="nextBtn">Generuj Wrapped üöÄ</button>
            </div>
        </div>

        <!-- INSTRUKCJA MODAL -->
        <div class="modal-overlay" id="helpModal">
            <div class="modal-card">
                <div class="modal-header">
                    <h2 style="font-size: 1.5rem; margin: 0;">Jak pobraƒá dane?</h2>
                    <button class="btn-close" id="closeHelp">√ó</button>
                </div>
                
                <div class="step-item">
                    <div class="step-num">1</div>
                    <div class="step-content">
                        Pobierz swoje dane z Facebooka w formacie <strong>JSON</strong>.
                    </div>
                </div>

                <div class="step-item">
                    <div class="step-num">2</div>
                    <div class="step-content">
                        Rozpakuj pobrany plik ZIP (opcjonalnie, teraz obs≈Çugujemy te≈º ZIP!).
                    </div>
                </div>

                <div class="step-item">
                    <div class="step-num">3</div>
                    <div class="step-content">
                        Znajd≈∫ folder <code>messages/inbox/</code> lub wrzuƒá ca≈Çy plik ZIP tutaj.
                    </div>
                </div>

            </div>
        </div>

        <!-- LOADER -->
        <div class="loader-overlay" id="loader">
            <div class="spinner"></div>
            <h3 style="font-weight: 700;">Przetwarzanie...</h3>
            <p style="color: var(--text-muted); font-size: 0.9rem; margin-top: 5px;" id="loaderStatus">Przygotowywanie ≈õrodowiska Python...</p>
        </div>

    </div>

    <script>
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const dropText = document.getElementById('dropText');
        const generateBtn = document.getElementById('generateBtn');
        const loader = document.getElementById('loader');
        const loaderStatus = document.getElementById('loaderStatus');
        
        // Views
        const uploadView = document.getElementById('uploadView');
        const selectView = document.getElementById('selectView');
        const mainFrame = document.getElementById('mainFrame');

        // Select View Elements
        const chatListEl = document.getElementById('chatList');
        const searchInput = document.getElementById('searchInput');
        const nextBtn = document.getElementById('nextBtn');
        const chatCountEl = document.getElementById('chatCount');

        // Global State
        window.allChats = [];
        window.selectedChatId = null;
        
        // Modal logic
        const helpModal = document.getElementById('helpModal');
        const openHelp = document.getElementById('openHelp');
        const closeHelp = document.getElementById('closeHelp');

        openHelp.addEventListener('click', () => {
            helpModal.style.display = 'flex';
            setTimeout(() => helpModal.classList.add('open'), 10);
        });

        const closeModal = () => {
            helpModal.classList.remove('open');
            setTimeout(() => helpModal.style.display = 'none', 300);
        }

        closeHelp.addEventListener('click', closeModal);
        helpModal.addEventListener('click', (e) => {
            if(e.target === helpModal) closeModal();
        });

        // Drag & Drop
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault(); dropZone.classList.remove('dragover');
            if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
        });

        fileInput.addEventListener('change', () => {
            if (fileInput.files.length) handleFile(fileInput.files[0]);
        });

        function handleFile(file) {
            dropText.innerText = file.name;
            dropText.style.color = "#fff";
            generateBtn.classList.add('ready');
            
            // Expose file to window for PyScript
            window.selectedFile = file;
        }

        generateBtn.addEventListener('click', async () => {
            if (!generateBtn.classList.contains('ready')) return;
            if (!window.processFilePython) {
                alert("≈örodowisko Python jeszcze siƒô ≈Çaduje. Poczekaj chwilƒô.");
                return;
            }

            loader.style.display = 'flex';
            loaderStatus.innerText = "Wczytywanie pliku...";
            
            try {
                const file = window.selectedFile;
                // Read file in JS to avoid NotReadableError/permission issues in Pyodide
                const buffer = await file.arrayBuffer();
                const uint8Arr = new Uint8Array(buffer);
                
                loaderStatus.innerText = "Przekazywanie do Pythona...";
                // Pass data and filename
                await window.processFilePython(uint8Arr, file.name);
            } catch (e) {
                console.error(e);
                alert("B≈ÇƒÖd odczytu pliku: " + e.message);
                loader.style.display = 'none';
            }
        });

        // --- JS Logic for Select View ---
        
        window.showSelectView = (chats) => {
            uploadView.style.display = 'none';
            selectView.style.display = 'flex';
            loader.style.display = 'none';
            
            window.allChats = chats;
            renderList();
        };
        
        window.triggerExitAnimation = () => {
            mainFrame.classList.add('exit-active');
        };

        function getInitials(name) {
            return name.split(' ').map(n => n[0]).join('').substring(0,2).toUpperCase();
        }

        function renderList(filter = "") {
            chatListEl.innerHTML = "";
            
            const filtered = window.allChats.filter(c => c.name.toLowerCase().includes(filter.toLowerCase()));
            chatCountEl.innerText = filtered.length; 

            filtered.forEach((chat, index) => {
                const el = document.createElement('div');
                el.className = `chat-item ${window.selectedChatId === chat.id ? 'selected' : ''}`;
                el.style.animationDelay = `${index * 0.05}s`;
                el.onclick = () => selectChat(chat.id);

                // Use simple hash for color consistency if not provided
                const colors = [
                    "linear-gradient(135deg, #FF9A9E 0%, #FECFEF 100%)",
                    "linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%)",
                    "linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%)",
                    "linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%)"
                ];
                const color = colors[chat.id.length % colors.length];
                
                const formattedCount = chat.count > 1000 
                    ? (chat.count / 1000).toFixed(1) + 'k msg' 
                    : chat.count + ' msg';

                el.innerHTML = `
                    <div class="avatar" style="background: ${color}">
                        ${getInitials(chat.name)}
                    </div>
                    <div class="chat-info">
                        <div class="chat-name">${chat.name}</div>
                        <div class="chat-meta">
                            <span>üí¨ ${formattedCount}</span>
                        </div>
                    </div>
                    <div class="select-indicator"></div>
                `;
                chatListEl.appendChild(el);
            });
            
            if(filtered.length === 0) {
                chatListEl.innerHTML = `<div style="text-align:center; margin-top:30px; color:rgba(255,255,255,0.4)">Nie znaleziono "${filter}"</div>`;
            }
        }

        function selectChat(id) {
            window.selectedChatId = id;
            const items = document.querySelectorAll('.chat-item');
            items.forEach(el => el.classList.remove('selected'));
            
            renderList(searchInput.value);
            
            const chat = window.allChats.find(c => c.id === id);
            if(chat) {
                nextBtn.classList.add('active');
                nextBtn.innerText = `Generuj dla: ${chat.name} üöÄ`;
            }
        }

        searchInput.addEventListener('input', (e) => {
            renderList(e.target.value);
        });

        nextBtn.addEventListener('click', () => {
            if(!window.selectedChatId) return;
            
            loader.style.display = 'flex';
            loaderStatus.innerText = "Generowanie raportu...";
            
            // Call Python to generate report for selected ID
            window.generateReportPython(window.selectedChatId);
        });

    </script>

    <!-- Konfiguracja PyScript -->
    <script type="py" config="pyscript.toml">
        import asyncio
        import json
        import re
        from js import document, window, Uint8Array, JSZip
        from pathlib import Path
        from zoneinfo import ZoneInfo
        from pyodide.ffi import to_js
        
        # Import local project files
        from messenger_wrapped_dm.parser import load_messages
        from messenger_wrapped_dm.metrics import compute_metrics
        from messenger_wrapped_dm.report import build_html

        # Global storage for ZIP content
        zip_content_map = {} # chat_id -> list of file paths in zip
        zip_data_obj = None # JSZip object

        def get_random_color():
            import random
            colors = [
                "linear-gradient(135deg, #FF9A9E 0%, #FECFEF 100%)",
                "linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%)",
                "linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%)",
                "linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%)",
                "linear-gradient(135deg, #f093fb 0%, #f5576c 100%)",
                "linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)",
                "linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)",
                "linear-gradient(135deg, #fa709a 0%, #fee140 100%)"
            ]
            return random.choice(colors)

        def fix_mojibake(text):
            if not text: return ""
            try:
                return text.encode('latin1').decode('utf-8')
            except:
                return text

        async def process_file(content_js, filename):
            global zip_data_obj, zip_content_map
            try:
                document.getElementById("loaderStatus").innerText = f"Przetwarzanie {filename}..."
                
                # content_js is a Uint8Array from JS
                
                if filename.lower().endswith('.zip'):
                    document.getElementById("loaderStatus").innerText = "Rozpakowywanie ZIP..."
                    
                    zip_data_obj = JSZip.new()
                    # JSZip can handle JS Uint8Array directly
                    await zip_data_obj.loadAsync(content_js)
                    
                    chat_groups = {}
                    
                    # Iterate files
                    files = []
                    # JSZip forEarch is a bit tricky in PyScript, convert to list of keys
                    keys = zip_data_obj.files.keys()
                    for filename in keys:
                        if filename.lower().endswith('.json') and not filename.startswith('.'):
                            # Skip system files
                            if 'autofill_information' in filename or 'secrets' in filename:
                                continue
                            files.append(filename)
                    
                    document.getElementById("loaderStatus").innerText = f"Znaleziono {len(files)} plik√≥w JSON..."
                    await asyncio.sleep(0.1)

                    for jf in files:
                        try:
                            # Read content to get message count and name
                            file_data = await zip_data_obj.file(jf).async_("string")
                            data = json.loads(file_data)
                            msg_count = len(data.get('messages', []))
                            
                            if msg_count == 0: continue

                            # Determine name
                            # Path structure: messages/inbox/Name_123/message_1.json
                            path_parts = jf.split('/')
                            raw_name = "Unknown"
                            
                            # Try to extract name from folder
                            if len(path_parts) > 1:
                                folder_name = path_parts[-2]
                                raw_name = re.sub(r'_\d+$', '', folder_name)
                            else:
                                raw_name = Path(jf).stem
                            
                            clean_title = fix_mojibake(raw_name)
                            
                            if clean_title not in chat_groups:
                                chat_groups[clean_title] = {'files': [], 'count': 0}
                            
                            chat_groups[clean_title]['files'].append(jf)
                            chat_groups[clean_title]['count'] += msg_count
                            
                        except Exception as e:
                            print(f"Error parsing {jf}: {e}")
                            continue
                            
                    # Build list for UI
                    chats = []
                    import uuid
                    zip_content_map = {}
                    
                    for title, info in chat_groups.items():
                        chat_id = str(uuid.uuid4())
                        zip_content_map[chat_id] = info['files']
                        
                        chats.append({
                            'id': chat_id,
                            'name': title,
                            'count': info['count'],
                            'color': get_random_color()
                        })
                    
                    chats.sort(key=lambda x: x['count'], reverse=True)
                    
                    # Switch UI
                    window.showSelectView(to_js(chats))
                    
                else:
                    # JSON FILE
                    # Convert JS Uint8Array to Python bytes
                    content_bytes = content_js.to_bytes()
                    
                    temp_path = Path("/tmp_msg.json")
                    temp_path.write_bytes(content_bytes)
                    await generate_from_path(temp_path)

            except Exception as e:
                document.getElementById("loader").style.display = "none"
                window.alert(f"B≈ÇƒÖd: {str(e)}")
                print(f"Error: {e}")

        async def generate_report_zip(chat_id):
            global zip_data_obj, zip_content_map
            try:
                target_files = zip_content_map.get(chat_id)
                if not target_files:
                    raise Exception("Chat ID not found")
                
                document.getElementById("loaderStatus").innerText = "≈ÅƒÖczenie wiadomo≈õci..."
                
                # Merge files into one list of messages
                all_messages = []
                
                for file_path in target_files:
                    content_str = await zip_data_obj.file(file_path).async_("string")
                    # Save to temp file for parser
                    temp_p = Path(f"/tmp_{Path(file_path).name}")
                    temp_p.write_text(content_str, encoding="utf-8")
                    
                    msgs, _ = load_messages(temp_p)
                    all_messages.extend(msgs)
                
                if not all_messages:
                    raise Exception("Brak wiadomo≈õci")
                    
                await generate_metrics_and_render(all_messages)

            except Exception as e:
                document.getElementById("loader").style.display = "none"
                window.alert(f"B≈ÇƒÖd generowania: {str(e)}")

        async def generate_from_path(path):
            msgs, skipped = load_messages(path)
            await generate_metrics_and_render(msgs)

        async def generate_metrics_and_render(messages):
            document.getElementById("loaderStatus").innerText = "Obliczanie statystyk..."
            await asyncio.sleep(0.1)

            metrics = compute_metrics(
                messages,
                tz=ZoneInfo("Europe/Warsaw"),
                min_response_seconds=1.0,
                max_response_seconds=12 * 3600
            )
            
            document.getElementById("loaderStatus").innerText = "Generowanie raportu..."
            await asyncio.sleep(0.1)

            final_html = build_html(metrics)
            
            # Hide Loader
            document.getElementById("loader").style.display = "none"
            
            # Trigger Exit Animation
            window.triggerExitAnimation()
            
            # Wait for animation (1.6s)
            await asyncio.sleep(1.6)
            
            document.open()
            document.write(final_html)
            document.close()

        # Expose functions to JS
        window.processFilePython = process_file
        window.generateReportPython = generate_report_zip
    </script>
</body>
</html>