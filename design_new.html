<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Messenger Wrapped 2025 Ultimate</title>
    
    <!-- Premium Font -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;500;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --bg-deep: #000000;
            --text-white: #ffffff;
            --text-muted: rgba(255, 255, 255, 0.6);
            
            /* Kolory Premium Neon */
            --accent-1: #2E3DE3;
            --accent-2: #FF0080;
            --accent-3: #7928CA;
            --accent-gradient: linear-gradient(135deg, #FF0080 0%, #7928CA 100%);
            
            --glass-bg: rgba(20, 20, 20, 0.65);
            --glass-border: rgba(255, 255, 255, 0.1);
            --glass-highlight: rgba(255, 255, 255, 0.05);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--bg-deep);
            color: var(--text-white);
            height: 100dvh;
            width: 100vw;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* --- T≈ÅO AURORA (PRZYWR√ìCONE) --- */
        .aurora-container {
            position: absolute; inset: 0; z-index: 0; overflow: hidden; background: #000;
        }
        .aurora-blob {
            position: absolute; border-radius: 50%; filter: blur(80px); opacity: 0.5;
            animation: drift 20s infinite alternate cubic-bezier(0.4, 0, 0.2, 1);
        }
        .blob-1 { width: 90vw; height: 90vw; background: var(--accent-1); top: -20%; left: -20%; animation-duration: 25s; }
        .blob-2 { width: 80vw; height: 80vw; background: var(--accent-2); bottom: -10%; right: -10%; animation-delay: -5s; }
        .blob-3 { width: 60vw; height: 60vw; background: var(--accent-3); top: 30%; left: 30%; animation-delay: -10s; opacity: 0.4; }

        @keyframes drift {
            0% { transform: translate(0, 0) scale(1); }
            100% { transform: translate(30px, -50px) scale(1.1); }
        }

        .noise {
            position: absolute; inset: 0; z-index: 1; opacity: 0.08; pointer-events: none;
            background: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
        }

                /* --- T≈ÅO ELEMENTY P≈ÅYWAJƒÑCE --- */
                .floating-layer {
                    position: absolute; inset: 0; overflow: hidden; pointer-events: none; z-index: 1;
                    transition: opacity 0.5s;
                }
                .floating-layer.hidden { opacity: 0; }
                
                .bg-el {
                    position: absolute; opacity: 0; /* JS zrobi fade in */
                    animation: floatBG linear infinite;
                }
                /* ... existing styles ... */
        
                /* --- DEKORACJE EKRANU TYTU≈ÅOWEGO --- */
                .title-deco {
                    position: absolute; pointer-events: none; opacity: 0.08; z-index: 0;
                    filter: blur(2px);
                }
                .deco-1 { top: 15%; left: 5%; width: 120px; transform: rotate(-15deg); }
                .deco-2 { bottom: 20%; right: -10%; width: 180px; transform: rotate(10deg); }
                .deco-3 { top: 40%; right: 10%; width: 60px; opacity: 0.15; }
                
                /* --- FRAME --- */        .app-frame {
            position: relative; width: 100%; height: 100%; z-index: 10;
            display: flex; flex-direction: column;
            background: rgba(0,0,0,0.01);
        }
        @media (min-width: 500px) {
            .app-frame {
                max-width: 480px; max-height: 860px;
                height: 85vh; border-radius: 40px; border: 8px solid #1a1a1a;
                box-shadow: 0 0 0 1px #333, 0 40px 100px rgba(0,0,0,0.8);
                background: #000; overflow: hidden;
            }
            .aurora-container { border-radius: 32px; }
            .app-frame .aurora-container { position: absolute; inset: 0; }
        }

        /* --- NAWIGACJA --- */
        .nav-header {
            position: absolute; top: 0; left: 0; width: 100%; padding: 20px 12px; z-index: 20;
            display: flex; gap: 4px;
        }
        .progress-bar {
            flex: 1; height: 3px; background: rgba(255,255,255,0.2); border-radius: 4px; overflow: hidden;
        }
        .progress-fill {
            height: 100%; width: 0%; background: #fff; border-radius: 4px;
            transition: width 0.1s linear;
            box-shadow: 0 0 10px rgba(255,255,255,0.5);
        }
        .progress-bar.filled .progress-fill { width: 100%; }
        .progress-bar.active .progress-fill { width: 100%; }

        /* --- SLAJDY --- */
        .slide {
            position: absolute; inset: 0; padding: 70px 16px 30px;
            display: flex; flex-direction: column; justify-content: center;
            opacity: 0; pointer-events: none;
            transition: opacity 0.6s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .slide.active { opacity: 1; pointer-events: auto; }

        .anim-item { opacity: 0; transform: translateY(30px); transition: all 0.8s cubic-bezier(0.16, 1, 0.3, 1); }
        .slide.active .anim-item { opacity: 1; transform: translateY(0); }
        .d-1 { transition-delay: 0.05s; } .d-2 { transition-delay: 0.15s; } .d-3 { transition-delay: 0.25s; }

        /* --- TYPOGRAFIA --- */
        .label { font-size: 0.75rem; font-weight: 700; letter-spacing: 1.5px; text-transform: uppercase; color: var(--text-muted); margin-bottom: 8px; display: block; }
        h1 { font-size: 2.5rem; font-weight: 800; line-height: 1.05; letter-spacing: -1px; margin-bottom: 20px; }
        h2 { font-size: 1.8rem; font-weight: 700; margin-bottom: 10px; }
        
        .brand-gradient { background: var(--accent-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .huge-stat { 
            font-size: 4rem; font-weight: 800; letter-spacing: -2px; line-height: 1; margin: 15px 0 5px 0; 
            background: linear-gradient(to right, #fff, #b4b4b4); -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }

        /* --- KARTY --- */
        .glass-card {
            background: var(--glass-bg);
            backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px);
            border: 1px solid var(--glass-border); border-top: 1px solid var(--glass-highlight);
            border-radius: 28px; padding: 24px; margin-top: 15px;
            box-shadow: 0 20px 50px -10px rgba(0,0,0,0.6);
            position: relative; overflow: hidden;
        }
        
        .stat-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.08); }
        .stat-row:last-child { border-bottom: none; }
        .row-icon { font-size: 1.4rem; margin-right: 15px; width: 30px; text-align: center; }
        .row-content { flex: 1; }
        .row-value { font-weight: 700; font-size: 1.1rem; }
        .sub-text { font-size: 0.8rem; color: var(--text-muted); }

        /* --- ELEMENTY SPECJALNE (UROZMAICENIE) --- */
        .chart-wrapper { height: 220px; width: 100%; position: relative; margin: 20px 0; }
        
        .bar-bg { background: rgba(255,255,255,0.1); height: 8px; border-radius: 4px; overflow: hidden; display: flex; margin-top: 10px; }
        .bar-fill-1 { background: var(--accent-1); height: 100%; }
        .bar-fill-2 { background: var(--accent-2); height: 100%; }
        
        /* Media Grid */
        .media-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 10px; }
        .media-item { 
            background: rgba(255,255,255,0.05); border-radius: 16px; padding: 15px 10px; 
            text-align: center; border: 1px solid rgba(255,255,255,0.05);
        }
        .media-icon { font-size: 1.5rem; margin-bottom: 5px; display: block; }
        
        /* --- PODIUM (NEW) --- */
        .podium-container {
            display: flex; justify-content: center; align-items: flex-end; gap: 10px;
            height: 250px; margin: 20px 0 40px; position: relative;
        }
        .podium-column {
            display: flex; flex-direction: column; align-items: center; justify-content: flex-end;
            width: 80px; position: relative;
        }
        .podium-bar {
            width: 100%; border-radius: 12px 12px 0 0;
            background: linear-gradient(to bottom, rgba(255,255,255,0.15), rgba(255,255,255,0.05));
            border: 1px solid rgba(255,255,255,0.2); border-bottom: none;
            display: flex; align-items: flex-end; justify-content: center;
            padding-bottom: 10px; font-weight: 800; font-size: 1.5rem; color: rgba(255,255,255,0.3);
            transform-origin: bottom; transform: scaleY(0);
        }
        .slide.active .podium-bar {
            animation: growUp 1s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }
        .bar-2 { height: 120px; animation-delay: 0.2s !important; background: linear-gradient(to bottom, rgba(46, 61, 227, 0.3), rgba(46, 61, 227, 0.1)); border-color: var(--accent-1); }
        .bar-1 { height: 160px; animation-delay: 0.4s !important; background: linear-gradient(to bottom, rgba(255, 0, 128, 0.3), rgba(255, 0, 128, 0.1)); border-color: var(--accent-2); box-shadow: 0 0 30px rgba(255,0,128,0.2); }
        .bar-3 { height: 90px; animation-delay: 0.6s !important; background: linear-gradient(to bottom, rgba(255,255,255,0.1), rgba(255,255,255,0.02)); }
        
        .podium-emoji {
            font-size: 3.5rem; margin-bottom: 10px; opacity: 0; transform: translateY(20px);
            filter: drop-shadow(0 10px 20px rgba(0,0,0,0.5));
        }
        .slide.active .podium-emoji {
            animation: popIn 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }
        .pe-2 { animation-delay: 0.8s !important; }
        .pe-1 { animation-delay: 1.0s !important; font-size: 4.5rem; margin-bottom: 15px; }
        .pe-3 { animation-delay: 1.2s !important; }

        @keyframes growUp { 0% { transform: scaleY(0); } 100% { transform: scaleY(1); } }
        @keyframes popIn { 0% { opacity: 0; transform: translateY(20px) scale(0.5); } 100% { opacity: 1; transform: translateY(0) scale(1); } }

        /* --- STEROWANIE --- */
        .tap-zone { position: absolute; top: 0; bottom: 0; width: 40%; z-index: 50; cursor: pointer; }
        .tap-left { left: 0; } .tap-right { right: 0; }
        
        .btn-replay {
            margin-top: 10px; padding: 16px 32px; background: #fff; color: #000;
            border: none; border-radius: 100px; font-weight: 800; cursor: pointer;
            transition: transform 0.2s; width: 100%;
        }
        .btn-replay:active { transform: scale(0.95); }
        .btn-secondary {
            background: transparent; color: #fff; border: 1px solid rgba(255,255,255,0.3);
            margin-top: 10px;
        }

        /* --- MODAL POBIERANIA --- */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.85);
            backdrop-filter: blur(10px); z-index: 1000;
            display: none; justify-content: center; align-items: center;
            padding: 20px;
        }
        .modal-overlay.active { display: flex; }
        .modal-content {
            background: #111; border: 1px solid var(--glass-border);
            border-radius: 32px; width: 100%; max-width: 400px;
            padding: 24px; color: #fff;
            max-height: 90vh; overflow-y: auto;
            position: relative;
        }
        .modal-close {
            position: absolute; top: 20px; right: 20px; font-size: 1.5rem;
            cursor: pointer; opacity: 0.5;
        }
        .modal-title { font-size: 1.5rem; font-weight: 800; margin-bottom: 20px; text-align: center; }
        
        .download-options { display: flex; flex-direction: column; gap: 12px; }
        .opt-card {
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
            border-radius: 20px; padding: 16px; cursor: pointer; transition: all 0.2s;
        }
        .opt-card:hover { background: rgba(255,255,255,0.1); border-color: var(--accent-1); }
        .opt-card.selected { border-color: var(--accent-2); background: rgba(255,0,128,0.1); }
        
        .opt-header { display: flex; align-items: center; gap: 12px; font-weight: 700; margin-bottom: 4px; }
        .opt-icon { font-size: 1.2rem; }
        .opt-desc { font-size: 0.8rem; color: var(--text-muted); }

        .jpg-selector {
            margin-top: 15px; display: none;
            border-top: 1px solid rgba(255,255,255,0.1); padding-top: 15px;
        }
        .jpg-selector.active { display: block; }
        
        .grid-selector {
            display: grid; grid-template-columns: 1fr 1fr; gap: 8px;
            margin-top: 10px; max-height: 200px; overflow-y: auto;
            padding-right: 5px;
        }
        .grid-item {
            display: flex; align-items: center; gap: 8px; font-size: 0.75rem;
            background: rgba(255,255,255,0.03); padding: 8px; border-radius: 10px;
            cursor: pointer;
        }
        .grid-item input { cursor: pointer; }

        .description-box {
            margin-top: 20px; font-size: 0.85rem; color: var(--text-muted);
            text-align: center; line-height: 1.4; padding: 0 10px;
        }

        .btn-confirm-dl {
            margin-top: 20px; width: 100%; padding: 16px;
            background: var(--accent-gradient); border: none; border-radius: 100px;
            color: #fff; font-weight: 800; cursor: pointer; font-size: 1rem;
            box-shadow: 0 10px 20px rgba(255,0,128,0.2);
        }
        .btn-confirm-dl:disabled { opacity: 0.5; cursor: not-allowed; }

    </style>
</head>
<body>

    <div class="app-frame">

        <!-- T≈Ço -->
        <div class="aurora-container">
            <div class="aurora-blob blob-1"></div>
            <div class="aurora-blob blob-2"></div>
            <div class="aurora-blob blob-3"></div>
            <div class="noise"></div>
        </div>

        <!-- P≈ÅYWAJƒÑCE T≈ÅO -->
        <div class="floating-layer" id="bgFloating"></div>

        <!-- Interfejs -->
        <div class="nav-header" id="navHeader"></div>
        <div class="tap-zone tap-left" id="btnPrev"></div>
        <div class="tap-zone tap-right" id="btnNext"></div>

        <!-- 1. INTRO (KLASYCZNY UK≈ÅAD) -->
        <section class="slide active">
            <!-- Dekoracje T≈Ça -->
            <svg class="title-deco deco-1" viewBox="0 0 100 100" fill="white"><path d="M50 0C22.4 0 0 20 0 45C0 59.4 6.2 72.2 16.4 81.3C15.9 84.4 14.7 91.9 10.6 96.6C16.8 95.8 28.5 91.8 34.3 87.2C39.2 88.9 44.5 90 50 90C77.6 90 100 70 100 45C100 20 77.6 0 50 0Z" /></svg>
            <svg class="title-deco deco-2" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="1.5"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/></svg>
            <div class="title-deco deco-3" style="font-size: 3rem;">üëã</div>

            <div class="anim-item d-1">
                <h2 style="color: var(--text-muted); font-size: 1.2rem;">Cze≈õƒá!</h2>
                <h1>MESSENGER<br><span class="brand-gradient">WRAPPED</span><br>2025</h1>
            </div>
            <div class="anim-item d-2 glass-card">
                <p style="font-size: 1.1rem; color: #fff; opacity: 0.9;">Ten rok by≈Ç pe≈Çen powiadomie≈Ñ.</p>
                <div class="huge-stat" id="introTotal">0</div>
                <div class="label" style="margin-top: 0;">Wiadomo≈õci ≈ÇƒÖcznie</div>
            </div>
        </section>

        <!-- 2. KTO ILE PISA≈Å (WYKRES) -->
        <section class="slide">
            <div class="anim-item d-1">
                <span class="label">Rywalizacja</span>
                <h1>Bitwa na<br>s≈Çowa</h1>
            </div>
            <div class="anim-item d-2 chart-wrapper" style="height: 200px;">
                <canvas id="chartVersus"></canvas>
            </div>
            <div class="anim-item d-3 glass-card" style="text-align: center; border-color: var(--accent-1);">
                <p class="sub-text">Zwyciƒôzca</p>
                <h3 id="winnerName" class="brand-gradient" style="font-size: 2.5rem; margin: 5px 0;">User</h3>
                <p class="sub-text">Napisa≈Ç(a) <strong style="color:#fff" id="winnerPct">0%</strong> wiadomo≈õci.</p>
            </div>
        </section>

        <!-- 3. PORY DNIA (MINIMALISTYCZNY) -->
        <section class="slide">
            <div class="anim-item d-1">
                <span class="label">Aktywno≈õƒá</span>
                <h1>Zegar<br>Biologiczny</h1>
            </div>
            <div class="anim-item d-2 chart-wrapper" style="height: 250px;">
                <canvas id="chartTime"></canvas>
            </div>
            <div class="anim-item d-3 glass-card" style="display:flex; align-items:center; gap:15px;">
                <div style="font-size: 2rem; background: rgba(255,255,255,0.1); width: 60px; height: 60px; border-radius: 50%; display: flex; align-items:center; justify-content:center;">‚è∞</div>
                <div>
                    <div class="label" style="margin:0">Ulubiona pora</div>
                    <div class="row-value" id="peakHour" style="font-size: 1.5rem;">20:00 - 21:00</div>
                </div>
            </div>
        </section>

        <!-- 3.5. DNI TYGODNIA (NEW) -->
        <section class="slide">
            <div class="anim-item d-1">
                <span class="label">Kalendarz</span>
                <h1>Rutyna<br>Tygodnia</h1>
            </div>
            <div class="anim-item d-2 chart-wrapper" style="height: 250px;">
                <canvas id="chartWeekdays"></canvas>
            </div>
            <div class="anim-item d-3 glass-card" style="text-align: center;">
                <p class="sub-text">Ulubiony dzie≈Ñ:</p>
                <h2 id="favDay" style="color: var(--accent-3);">PiƒÖtek</h2>
            </div>
        </section>

        <!-- 4. NOCNY TRYB (UROZMAICENIE: WIƒòKSZA TYPOGRAFIA) -->
        <section class="slide">
            <div class="anim-item d-1">
                <span class="label">00:00 - 05:00</span>
                <h1>Nocne<br>Polaki üåö</h1>
            </div>
            <div class="anim-item d-2 glass-card">
                <div style="text-align: center; margin-bottom: 20px;">
                    <div class="huge-stat" style="font-size: 4.5rem;" id="nightPct">0%</div>
                    <p class="sub-text">Wiadomo≈õci wys≈Çanych, gdy miasto spa≈Ço.</p>
                </div>
                
                <hr style="border:0; border-top:1px solid rgba(255,255,255,0.1); margin: 20px 0;">
                
                <div class="stat-row">
                    <span class="row-icon">ü¶â</span>
                    <div class="row-content">
                        <div class="row-value" id="nightKingName" style="color: var(--accent-2);">Ty</div>
                        <div class="sub-text">G≈Ç√≥wny Nocny Marek</div>
                    </div>
                    <div style="font-weight:bold; font-size: 1.2rem;" id="nightKingCount">0 msg</div>
                </div>
            </div>
        </section>

        <!-- 5. LAST SEEN CHAMPION -->
        <section class="slide">
            <div class="anim-item d-1">
                <span class="label">Dobranoc</span>
                <h1>Last Seen<br>Champion</h1>
            </div>
            <div class="anim-item d-2 glass-card" style="text-align: center; padding: 40px 20px;">
                <div style="font-size: 4rem; margin-bottom: 10px;">üò¥</div>
                <h2 id="lastSeenName" style="font-size: 2.2rem; margin: 0; color: #fff;">User</h2>
                <p style="margin-top: 10px; font-size: 1rem; color: var(--text-muted);">Najczƒô≈õciej ko≈Ñczy dzie≈Ñ</p>
                
                <div class="bar-bg" style="margin-top: 30px; height: 12px;">
                    <div class="bar-fill-1" id="lsBar1" style="width: 50%"></div>
                    <div class="bar-fill-2" id="lsBar2" style="width: 50%"></div>
                </div>
                <div style="display:flex; justify-content:space-between; font-size:0.75rem; margin-top:5px; opacity:0.6;">
                    <span>Ty</span>
                    <span>Ona</span>
                </div>
            </div>
        </section>

        <!-- 6. DYNAMIKA (PODZIA≈Å NA SEKCJE) -->
        <section class="slide">
            <div class="anim-item d-1">
                <span class="label">Refleks</span>
                <h1>Szybcy i<br>W≈õciekli</h1>
            </div>
            <div class="anim-item d-2 glass-card">
                <!-- Most Replied To -->
                <div style="margin-bottom: 25px;">
                    <span class="label" style="color: var(--accent-1);">Flash Response</span>
                    <p style="font-size: 1rem; margin-bottom: 10px;">
                        <strong style="color: #fff; font-size: 1.2rem;" id="fastReplyWinner">Ona</strong> odpisuje szybciej!
                    </p>
                    <div class="bar-bg">
                        <div class="bar-fill-1" style="width: 75%"></div> 
                    </div>
                    <div class="sub-text" style="margin-top: 5px;">75% Twoich wiadomo≈õci dostaje b≈ÇyskawicznƒÖ odpowied≈∫.</div>
                </div>

                <hr style="border:0; border-top:1px dashed rgba(255,255,255,0.15); margin: 20px 0;">

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div style="background: rgba(255,255,255,0.05); padding: 10px; border-radius: 12px; text-align: center;">
                        <div class="sub-text">Tw√≥j czas</div>
                        <div style="font-weight: 700; font-size: 1.2rem; color: #fff;" id="avgTime1">4 min</div>
                    </div>
                    <div style="background: rgba(255,255,255,0.05); padding: 10px; border-radius: 12px; text-align: center;">
                        <div class="sub-text">Jej czas</div>
                        <div style="font-weight: 700; font-size: 1.2rem; color: #fff;" id="avgTime2">2 min</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 7. STYL ROZMOWY (NEW) -->
        <section class="slide">
            <div class="anim-item d-1">
                <span class="label">Komunikacja</span>
                <h1>Styl<br>Rozmowy</h1>
            </div>
            <div class="anim-item d-2 glass-card">
                <!-- Average Length -->
                <div style="margin-bottom: 25px;">
                    <span class="label" style="color: var(--accent-3);">Gadatliwo≈õƒá</span>
                    <p style="font-size: 1rem; margin-bottom: 10px;">
                        <strong style="color: #fff; font-size: 1.2rem;" id="yapMaster">User</strong> pisze esejami.
                    </p>
                    <div style="display: flex; justify-content: space-between; margin-top: 15px;">
                        <div style="text-align: center;">
                            <div class="sub-text" id="alName1">Ty</div>
                            <div style="font-weight: 700; font-size: 1.5rem;" id="avgLenVal1">0</div>
                            <div class="sub-text" style="font-size: 0.7rem;">s≈Ç√≥w/msg</div>
                        </div>
                        <div style="text-align: center;">
                            <div class="sub-text" id="alName2">Ona</div>
                            <div style="font-weight: 700; font-size: 1.5rem;" id="avgLenVal2">0</div>
                            <div class="sub-text" style="font-size: 0.7rem;">s≈Ç√≥w/msg</div>
                        </div>
                    </div>
                </div>

                <hr style="border:0; border-top:1px dashed rgba(255,255,255,0.15); margin: 20px 0;">

                <!-- Starters -->
                <div>
                    <span class="label" style="color: var(--accent-1);">Inicjatywa</span>
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <div>
                            <p class="sub-text">Kto zaczyna?</p>
                            <div style="font-weight: 700; font-size: 1.3rem; margin-top: 5px;" id="starterKing">Ty</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 0.9rem;"><span id="starterVal1">0</span> vs <span id="starterVal2">0</span></div>
                            <div class="sub-text">rozpoczƒôtych rozm√≥w</div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 8. SLOWNIK (NEW) -->
        <section class="slide">
            <div class="anim-item d-1">
                <span class="label">S≈Çownik</span>
                <h1>Ulubione<br>Zwroty</h1>
            </div>
            <div class="anim-item d-2 glass-card">
                <p class="sub-text" style="margin-bottom: 20px;">Wasze najczƒôstsze powiedzonka:</p>
                
                <div style="display: flex; flex-direction: column; gap: 15px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px;">
                        <div style="font-weight: 700; font-size: 1.2rem; color: #fff;">1. "<span id="vocabPhrase1">...</span>"</div>
                        <div style="font-size: 0.9rem; color: var(--accent-1); font-weight: bold;" id="vocabCount1">0</div>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px;">
                        <div style="font-weight: 700; font-size: 1.1rem; color: rgba(255,255,255,0.9);">2. "<span id="vocabPhrase2">...</span>"</div>
                        <div style="font-size: 0.9rem; color: var(--accent-2); font-weight: bold;" id="vocabCount2">0</div>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="font-weight: 700; font-size: 1rem; color: rgba(255,255,255,0.8);">3. "<span id="vocabPhrase3">...</span>"</div>
                        <div style="font-size: 0.9rem; color: var(--accent-3); font-weight: bold;" id="vocabCount3">0</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 9. EMOJI (UROZMAICENIE: PODIUM) -->
        <section class="slide">
            <div class="anim-item d-1">
                <span class="label">Bez s≈Ç√≥w</span>
                <h1>Top Emoji</h1>
            </div>
            <div class="anim-item d-2 podium-container">
                <!-- 2nd Place (Left) -->
                <div class="podium-column">
                    <div class="podium-emoji pe-2" id="emo2">ü•à</div>
                    <div class="podium-bar bar-2">2</div>
                </div>
                <!-- 1st Place (Center) -->
                <div class="podium-column">
                    <div class="podium-emoji pe-1" id="emo1">ü•á</div>
                    <div class="podium-bar bar-1">1</div>
                </div>
                <!-- 3rd Place (Right) -->
                <div class="podium-column">
                    <div class="podium-emoji pe-3" id="emo3">ü•â</div>
                    <div class="podium-bar bar-3">3</div>
                </div>
            </div>
            <div class="anim-item d-3 glass-card" style="text-align: center;">
                <p class="sub-text">Najczƒô≈õciej u≈ºywana:</p>
                <h2 id="favEmojiName" style="color: var(--accent-2);">Czerwone Serce</h2>
            </div>
        </section>

        <!-- 8. MEDIA (UROZMAICENIE: SIATKA/GRID) -->
        <section class="slide">
            <div class="anim-item d-1">
                <span class="label">Galeria</span>
                <h1>Multimedia</h1>
            </div>
            <div class="anim-item d-2 glass-card">
                <div class="media-grid">
                    <div class="media-item">
                        <span class="media-icon">üì∏</span>
                        <div style="font-weight: 700;" id="mediaPhoto">0</div>
                        <div style="font-size: 0.7rem; opacity: 0.7;">Foto/Wideo</div>
                    </div>
                    <div class="media-item">
                        <span class="media-icon">üé§</span>
                        <div style="font-weight: 700;" id="mediaVoice">0</div>
                        <div style="font-size: 0.7rem; opacity: 0.7;">G≈Çosowe</div>
                    </div>
                    <div class="media-item">
                        <span class="media-icon">üîó</span>
                        <div style="font-weight: 700;" id="mediaLink">0</div>
                        <div style="font-size: 0.7rem; opacity: 0.7;">Linki</div>
                    </div>
                </div>
            </div>
            <p class="anim-item d-3 sub-text" style="text-align: center; margin-top: 20px;">
                <span id="mediaKing" style="color: #fff; font-weight: 700;">Ty</span> wys≈Ça≈Çe≈õ(a≈õ) wiƒôcej spamu.
            </p>
        </section>

        <!-- 9. VIBE CHECK -->
        <section class="slide">
            <div class="anim-item d-1">
                <span class="label">Analiza</span>
                <h1>Vibe Check ‚ú®</h1>
            </div>
            <div class="anim-item d-2 chart-wrapper" style="height: 300px;">
                <canvas id="chartRadar"></canvas>
            </div>
            <div class="anim-item d-2" style="display: flex; justify-content: center; gap: 20px; font-size: 0.8rem; margin-top: 10px;">
                <div style="color: var(--accent-1);">‚óè <span id="vibeUser1">A</span></div>
                <div style="color: var(--accent-2);">‚óè <span id="vibeUser2">B</span></div>
            </div>
            <div class="anim-item d-3 glass-card" style="padding: 15px; margin-top: 20px;">
                <p style="text-align: center; font-size: 0.95rem; color: #fff;">
                    Wasza relacja to g≈Ç√≥wnie <strong id="vibeMain" style="color: var(--accent-3);">Humor i Wsparcie</strong>.
                </p>
            </div>
        </section>

        <!-- 10. OUTRO -->
        <section class="slide">
            <div class="anim-item d-1" style="text-align: center;">
                <h1 style="font-size: 4rem; margin-bottom: 10px;">2025</h1>
                <p style="color: var(--text-muted); font-size: 1.1rem;">Dziƒôki za ka≈ºdƒÖ wiadomo≈õƒá.</p>
            </div>
            <div class="anim-item d-2" style="text-align: center; margin-top: 30px; width: 100%;">
                <button class="btn-replay" onclick="location.reload()">Jeszcze raz ‚Ü∫</button>
                <button class="btn-replay" style="background: var(--accent-gradient); color: #fff; margin-top: 10px;" onclick="openDownloadModal()">Pobierz Wrapped üì•</button>
                <button class="btn-replay btn-secondary" onclick="window.location.href='wybor_osob.html'">Wybierz inny czat üë§</button>
            </div>
        </section>

    </div>

    <!-- MODAL POBIERANIA -->
    <div class="modal-overlay" id="downloadModal">
        <div class="modal-content">
            <div class="modal-close" onclick="closeDownloadModal()">√ó</div>
            <div class="modal-title">Pobierz Wrapped</div>
            
            <div class="download-options">
                <div class="opt-card" id="optHtml" onclick="selectDownloadType('html')">
                    <div class="opt-header">
                        <span class="opt-icon">üåê</span>
                        <span>Plik HTML</span>
                    </div>
                    <div class="opt-desc">Interaktywna wersja (jeden plik)</div>
                </div>
                
                <div class="opt-card" id="optJpg" onclick="selectDownloadType('jpg')">
                    <div class="opt-header">
                        <span class="opt-icon">üñºÔ∏è</span>
                        <span>Obrazy JPG</span>
                    </div>
                    <div class="opt-desc">Wysoka jako≈õƒá, idealne do social medi√≥w</div>
                    
                    <div class="jpg-selector" id="jpgSelector">
                        <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.8rem;">
                            <span>Wybierz slajdy:</span>
                            <span style="color: var(--accent-1); cursor: pointer;" onclick="toggleAllSlides(event)">Zaznacz wszystkie</span>
                        </div>
                        <div class="grid-selector" id="slideGrid">
                            <!-- JS will populate this -->
                        </div>
                    </div>
                </div>
            </div>

            <div class="description-box">
                HTML pozwala na interaktywne oglƒÖdanie na telefonie i komputerze. JPG pozwala na wstawienie do social medi√≥w i oglƒÖdanie w galerii.
            </div>

            <button class="btn-confirm-dl" id="btnConfirmDl" onclick="startDownload()">Pobierz teraz</button>
        </div>
    </div>

    <!-- Script Block Placeholder for Python -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script>
        const storedStats = localStorage.getItem('wrappedStats');
        if (!storedStats) {
            alert('Brak danych. Wroc do wyboru czatu.');
            window.location.href = 'wybor_osob.html';
            throw new Error('Missing stats');
        }

        const stats = storedStats ? JSON.parse(storedStats) : null;
        if (!stats) {
            alert('Blad danych. Wroc do wyboru czatu.');
            window.location.href = 'wybor_osob.html';
            throw new Error('Invalid stats');
        }

        const slides = document.querySelectorAll('.slide');
        const navHeader = document.getElementById('navHeader');
        let currentIdx = 0;

        // Ensure navHeader is empty before adding bars (prevents duplicates)
        navHeader.innerHTML = '';
        slides.forEach((_, i) => {
            const bar = document.createElement('div');
            bar.className = 'progress-bar';
            bar.innerHTML = '<div class="progress-fill"></div>';
            navHeader.appendChild(bar);
        });
        const bars = document.querySelectorAll('.progress-bar');

        function showSlide(index) {
            if (index < 0) index = 0;
            if (index >= slides.length) index = slides.length - 1;
            currentIdx = index;
            
            // Toggle Background Floating Elements (Only on Slide 0)
            const bgLayer = document.getElementById('bgFloating');
            if(bgLayer) {
                if(index === 0) bgLayer.classList.remove('hidden');
                else bgLayer.classList.add('hidden');
            }

            slides.forEach((s, i) => s.classList.toggle('active', i === index));
            bars.forEach((b, i) => {
                b.classList.remove('active', 'filled');
                if (i < index) b.classList.add('filled');
                if (i === index) b.classList.add('active');
            });
        }

        document.getElementById('btnNext').addEventListener('click', () => showSlide(currentIdx + 1));
        document.getElementById('btnPrev').addEventListener('click', () => showSlide(currentIdx - 1));
        document.addEventListener('keydown', e => {
            if(e.key === "ArrowRight") showSlide(currentIdx + 1);
            if(e.key === "ArrowLeft") showSlide(currentIdx - 1);
        });

        function setupCanvas(canvas) {
            const parent = canvas.parentElement;
            const rect = parent ? parent.getBoundingClientRect() : canvas.getBoundingClientRect();
            const scale = window.devicePixelRatio || 1;
            canvas.width = rect.width * scale;
            canvas.height = rect.height * scale;
            canvas.style.width = rect.width + "px";
            canvas.style.height = rect.height + "px";
            canvas.style.display = "block";
            const ctx = canvas.getContext('2d');
            ctx.setTransform(scale, 0, 0, scale, 0, 0);
            return ctx;
        }

        function drawHorizontalBars(canvas, labels, values, colors) {
            const ctx = setupCanvas(canvas);
            const w = canvas.getBoundingClientRect().width;
            const h = canvas.getBoundingClientRect().height;
            const paddingX = 20;
            const topPadding = 12;
            const bottomPadding = 28;
            const maxVal = Math.max(...values, 1);
            const barHeight = (h - topPadding - bottomPadding) / values.length;
            ctx.clearRect(0, 0, w, h);
            ctx.font = "16px 'Plus Jakarta Sans', sans-serif";
            ctx.textAlign = "left";
            ctx.textBaseline = "middle";
            values.forEach((val, i) => {
                const y = topPadding + i * barHeight + barHeight * 0.2;
                const height = barHeight * 0.6;
                const width = ((w - paddingX * 2) * val) / maxVal;
                ctx.fillStyle = colors[i % colors.length];
                ctx.beginPath();
                const radius = Math.max(6, height / 2);
                ctx.moveTo(paddingX + radius, y);
                ctx.lineTo(paddingX + width - radius, y);
                ctx.quadraticCurveTo(paddingX + width, y, paddingX + width, y + radius);
                ctx.lineTo(paddingX + width, y + height - radius);
                ctx.quadraticCurveTo(paddingX + width, y + height, paddingX + width - radius, y + height);
                ctx.lineTo(paddingX + radius, y + height);
                ctx.quadraticCurveTo(paddingX, y + height, paddingX, y + height - radius);
                ctx.lineTo(paddingX, y + radius);
                ctx.quadraticCurveTo(paddingX, y, paddingX + radius, y);
                ctx.fill();
                ctx.fillStyle = "#fff";
                const labelY = Math.min(y + height + 14, h - 6);
                ctx.fillText(labels[i], paddingX, labelY);
            });
        }

        function drawBarChart(canvas, values) {
            const ctx = setupCanvas(canvas);
            const w = canvas.getBoundingClientRect().width;
            const h = canvas.getBoundingClientRect().height;
            const padding = 14;
            const maxVal = Math.max(...values, 1);
            const barWidth = (w - padding * 2) / values.length;
            ctx.clearRect(0, 0, w, h);
            values.forEach((val, i) => {
                const height = ((h - padding * 2) * val) / maxVal;
                const x = padding + i * barWidth + barWidth * 0.1;
                const y = h - padding - height;
                const width = barWidth * 0.8;
                ctx.fillStyle = "#fff";
                ctx.beginPath();
                ctx.moveTo(x, y + 3);
                ctx.lineTo(x, y + height);
                ctx.lineTo(x + width, y + height);
                ctx.lineTo(x + width, y + 3);
                ctx.quadraticCurveTo(x + width, y, x + width - 3, y);
                ctx.lineTo(x + 3, y);
                ctx.quadraticCurveTo(x, y, x, y + 3);
                ctx.fill();
            });
        }

        function drawVerticalBarChart(canvas, labels, values) {
            const ctx = setupCanvas(canvas);
            const w = canvas.getBoundingClientRect().width;
            const h = canvas.getBoundingClientRect().height;
            const paddingX = 14;
            const paddingY = 20; // Space for labels
            const maxVal = Math.max(...values, 1);
            const barWidth = (w - paddingX * 2) / values.length;
            ctx.clearRect(0, 0, w, h);
            
            ctx.font = "12px 'Plus Jakarta Sans', sans-serif";
            ctx.textAlign = "center";
            ctx.textBaseline = "top";

            values.forEach((val, i) => {
                const barH = h - paddingY * 2;
                const height = (barH * val) / maxVal;
                const x = paddingX + i * barWidth + barWidth * 0.1;
                const y = barH + paddingY - height - 5;
                const width = barWidth * 0.8;
                
                // Draw Bar
                ctx.fillStyle = "#fff";
                ctx.beginPath();
                ctx.moveTo(x, y + 3);
                ctx.lineTo(x, y + height);
                ctx.lineTo(x + width, y + height);
                ctx.lineTo(x + width, y + 3);
                ctx.quadraticCurveTo(x + width, y, x + width - 3, y);
                ctx.lineTo(x + 3, y);
                ctx.quadraticCurveTo(x, y, x, y + 3);
                ctx.fill();

                // Draw Label
                ctx.fillStyle = "rgba(255,255,255,0.7)";
                ctx.fillText(labels[i], x + width / 2, h - paddingY + 5);
            });
        }

        function drawRadarChart(canvas, labels, datasets) {
            const ctx = setupCanvas(canvas);
            const w = canvas.getBoundingClientRect().width;
            const h = canvas.getBoundingClientRect().height;
            const cx = w / 2;
            const cy = h / 2;
            const radius = Math.min(w, h) * 0.28;
            ctx.clearRect(0, 0, w, h);
            ctx.strokeStyle = "rgba(255,255,255,0.1)";
            ctx.fillStyle = "#fff";
            ctx.font = "11px 'Plus Jakarta Sans', sans-serif";

            const steps = 4;
            for (let i = 1; i <= steps; i++) {
                ctx.beginPath();
                const r = (radius / steps) * i;
                for (let a = 0; a < labels.length; a++) {
                    const angle = (Math.PI * 2 * a) / labels.length - Math.PI / 2;
                    const x = cx + r * Math.cos(angle);
                    const y = cy + r * Math.sin(angle);
                    if (a === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                }
                ctx.closePath();
                ctx.stroke();
            }

            labels.forEach((label, i) => {
                const angle = (Math.PI * 2 * i) / labels.length - Math.PI / 2;
                const x = cx + (radius + 16) * Math.cos(angle);
                const y = cy + (radius + 16) * Math.sin(angle);
                ctx.fillStyle = "#fff";
                ctx.textAlign = "center";
                ctx.fillText(label, x, y);
            });

            datasets.forEach((dataset) => {
                ctx.beginPath();
                dataset.values.forEach((val, i) => {
                    const angle = (Math.PI * 2 * i) / labels.length - Math.PI / 2;
                    const r = (val / 100) * radius;
                    const x = cx + r * Math.cos(angle);
                    const y = cy + r * Math.sin(angle);
                    if (i === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                });
                ctx.closePath();
                ctx.strokeStyle = dataset.color;
                ctx.lineWidth = 2;
                ctx.stroke();
                ctx.fillStyle = dataset.color.replace(")", ", 0.2)").replace("rgb", "rgba");
                ctx.globalAlpha = 0.2;
                ctx.fill();
                ctx.globalAlpha = 1;
            });
        }

        document.getElementById('introTotal').innerText = stats.total.toLocaleString('pl-PL').replace(/,/g, ' ');
        drawHorizontalBars(document.getElementById('chartVersus'), stats.users, stats.msgs, ['#2E3DE3', '#FF0080']);
        const winnerIndex = stats.msgs[1] > stats.msgs[0] ? 1 : 0;
        document.getElementById('winnerName').innerText = stats.users[winnerIndex] || "n/a";
        document.getElementById('winnerPct').innerText = Math.round((stats.msgs[winnerIndex] / stats.total) * 100) + "%";

        drawBarChart(document.getElementById('chartTime'), stats.hours);
        document.getElementById('peakHour').innerText = stats.peakHour;

        if(document.getElementById('chartWeekdays')) {
            drawVerticalBarChart(document.getElementById('chartWeekdays'), ['Pn', 'Wt', '?r', 'Cz', 'Pt', 'So', 'Nd'], stats.weekdays);
            document.getElementById('favDay').innerText = stats.favDay;
        }

        document.getElementById('nightPct').innerText = stats.nightPct;
        document.getElementById('nightKingName').innerText = stats.nightWinner.name;
        document.getElementById('nightKingCount').innerText = stats.nightWinner.count + " msg";

        document.getElementById('lastSeenName').innerText = stats.lastSeen.name;
        document.getElementById('lsBar1').style.width = stats.lastSeen.pct1 + "%";
        document.getElementById('lsBar2').style.width = stats.lastSeen.pct2 + "%";
        document.getElementById('lsLabel1').innerText = stats.users[0] || "A";
        document.getElementById('lsLabel2').innerText = stats.users[1] || "B";

        document.getElementById('fastReplyWinner').innerText = stats.fastReplyWinner;
        document.getElementById('fastReplyPct').innerText = stats.fastReplyPct.toFixed(0);
        document.getElementById('fastReplyBar').style.width = Math.min(stats.fastReplyPct, 100) + "%";
        document.getElementById('avgTime1').innerText = stats.avgTime[0];
        document.getElementById('avgTime2').innerText = stats.avgTime[1];

        if(document.getElementById('yapMaster')) {
            document.getElementById('yapMaster').innerText = stats.yapMaster;
            document.getElementById('alName1').innerText = stats.users[0] || "A";
            document.getElementById('alName2').innerText = stats.users[1] || "B";
            document.getElementById('avgLenVal1').innerText = stats.avgLen[0];
            document.getElementById('avgLenVal2').innerText = stats.avgLen[1];
            
            document.getElementById('starterKing').innerText = stats.starterKing;
            document.getElementById('starterVal1').innerText = stats.starters[0];
            document.getElementById('starterVal2').innerText = stats.starters[1];
        }

        if(document.getElementById('vocabPhrase1')) {
            document.getElementById('vocabPhrase1').innerText = stats.topPhrases[0].text;
            document.getElementById('vocabCount1').innerText = stats.topPhrases[0].count;
            document.getElementById('vocabPhrase2').innerText = stats.topPhrases[1].text;
            document.getElementById('vocabCount2').innerText = stats.topPhrases[1].count;
            document.getElementById('vocabPhrase3').innerText = stats.topPhrases[2].text;
            document.getElementById('vocabCount3').innerText = stats.topPhrases[2].count;
        }

        document.getElementById('emo1').innerText = stats.emojis[0];
        document.getElementById('emo2').innerText = stats.emojis[1];
        document.getElementById('emo3').innerText = stats.emojis[2];
        document.getElementById('favEmojiName').innerText = stats.favEmojiName;

        document.getElementById('mediaPhoto').innerText = stats.media.photo;
        document.getElementById('mediaVoice').innerText = stats.media.voice;
        document.getElementById('mediaLink').innerText = stats.media.link;
        document.getElementById('mediaKing').innerText = stats.mediaKing;

        drawRadarChart(document.getElementById('chartRadar'), stats.vibeLabels, [
            { label: stats.users[0], values: stats.vibeData1, color: '#2E3DE3' },
            { label: stats.users[1], values: stats.vibeData2, color: '#FF0080' }
        ]);
        document.getElementById('vibeMain').innerText = stats.vibeMain;
        const vibeUser1 = document.getElementById('vibeUser1');
        if (vibeUser1) vibeUser1.innerText = stats.users[0] || "A";
        const vibeUser2 = document.getElementById('vibeUser2');
        if (vibeUser2) vibeUser2.innerText = stats.users[1] || "B";

        function createBackground() {
            const container = document.getElementById('bgFloating');
            if(!container) return;
            
            // Emoji z czatu + dymki
            const emojiList = stats.emojis.length > 0 ? stats.emojis.map(e => e) : ['\u{1F499}', '\u{1F44B}', '\u{1F602}', '\u{1F525}'];
            const elements = [...emojiList, ...emojiList, 'bubble', 'bubble', 'typing'];
            
            // Generujemy 18 elementow
            for(let i=0; i<18; i++) {
                const elType = elements[Math.floor(Math.random() * elements.length)];
                const div = document.createElement('div');
                div.className = 'bg-el';
                
                // Random position
                div.style.left = Math.floor(Math.random() * 90) + 5 + '%';
                // Random duration (15s - 30s)
                const duration = 15 + Math.random() * 15;
                div.style.animationDuration = duration + 's';
                // Random delay (-20s to 0s so they are already on screen)
                div.style.animationDelay = -Math.random() * 20 + 's';
                
                if (elType === 'bubble' || elType === 'typing') {
                    div.className += ' bg-bubble';
                    if(Math.random() > 0.5) div.className += ' right';
                    
                    if (elType === 'typing') {
                        div.innerHTML = '<div class="dot"></div><div class="dot"></div><div class="dot"></div>';
                    } else {
                        // Empty bubble or simple line
                        div.style.width = (30 + Math.random() * 30) + 'px';
                        div.style.height = '18px';
                    }
                } else {
                    div.className += ' bg-emoji';
                    div.innerText = elType;
                    div.style.fontSize = (1.5 + Math.random()) + 'rem';
                }
                
                container.appendChild(div);
            }
        }
        
        createBackground();
        showSlide(0);

        // --- DOWNLOAD LOGIC ---
        let selectedType = null;
        const modal = document.getElementById('downloadModal');
        const btnConfirm = document.getElementById('btnConfirmDl');
        const slideGrid = document.getElementById('slideGrid');

        window.openDownloadModal = function() {
            modal.classList.add('active');
            populateSlideGrid();
        };

        window.closeDownloadModal = function() {
            modal.classList.remove('active');
        };

        window.selectDownloadType = function(type) {
            selectedType = type;
            document.querySelectorAll('.opt-card').forEach(c => c.classList.remove('selected'));
            document.getElementById('opt' + type.charAt(0).toUpperCase() + type.slice(1)).classList.add('selected');
            
            const jpgSelector = document.getElementById('jpgSelector');
            if (type === 'jpg') jpgSelector.classList.add('active');
            else jpgSelector.classList.remove('active');
            
            btnConfirm.disabled = false;
        };

        function populateSlideGrid() {
            if (slideGrid.children.length > 0) return;
            const slideNames = [
                "Start", "Bitwa na s?owa", "Zegar", "Rutyna", "Nocne Marki", 
                "Last Seen", "Refleks", "Styl Rozmowy", "S?ownik", "Top Emoji", 
                "Multimedia", "Vibe Check", "Koniec"
            ];
            slides.forEach((_, i) => {
                const item = document.createElement('div');
                item.className = 'grid-item';
                item.innerHTML = `
                    <input type="checkbox" id="slide_${i}" checked>
                    <label for="slide_${i}">${slideNames[i] || 'Slajd ' + (i+1)}</label>
                `;
                item.onclick = (e) => {
                    if (e.target.tagName !== 'INPUT') {
                        const cb = item.querySelector('input');
                        cb.checked = !cb.checked;
                    }
                };
                slideGrid.appendChild(item);
            });
        }

        window.toggleAllSlides = function(e) {
            e.stopPropagation();
            const cbs = slideGrid.querySelectorAll('input');
            const allChecked = Array.from(cbs).every(cb => cb.checked);
            cbs.forEach(cb => cb.checked = !allChecked);
        };

        window.startDownload = async function() {
            btnConfirm.disabled = true;
            btnConfirm.innerText = "Przetwarzanie...";
            
            try {
                if (selectedType === 'html') {
                    downloadHtml();
                } else {
                    await downloadJpgs();
                }
            } catch (err) {
                console.error(err);
                alert("Blad podczas pobierania.");
            } finally {
                btnConfirm.disabled = false;
                btnConfirm.innerText = "Pobierz teraz";
                closeDownloadModal();
            }
        };

        function downloadHtml() {
            // Create a clone to modify for the download
            const docClone = document.documentElement.cloneNode(true);
            
            // 1. Remove the download button and secondary button (Select other chat)
            docClone.querySelectorAll('button').forEach(btn => {
                if (btn.innerText.includes('Pobierz') || btn.innerText.includes('Wybierz inny')) {
                    btn.remove();
                }
            });
            
            // 2. Remove the download modal
            const dlModal = docClone.querySelector('#downloadModal');
            if (dlModal) dlModal.remove();

            // 3. Reset slides: remove 'active' from all and add to first
            docClone.querySelectorAll('.slide').forEach((s, i) => {
                s.classList.toggle('active', i === 0);
            });
            
            // 4. Reset progress bars
            docClone.querySelectorAll('.progress-bar').forEach((b, i) => {
                b.classList.remove('active', 'filled');
                if (i === 0) b.classList.add('active');
            });

            // 5. Ensure it starts at slide 0 on load
            const script = docClone.querySelector('script:last-of-type');
            if (script) {
                // We add a listener to ensure everything is loaded before showing slide 0
                script.innerHTML += "
window.addEventListener('load', () => { currentIdx = 0; showSlide(0); });";
            }

            const htmlContent = '<!DOCTYPE html>
' + docClone.outerHTML;
            const blob = new Blob([htmlContent], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `messenger_wrapped_${stats.users.join('_')}.html`;
            a.click();
        }

        async function downloadJpgs() {
            const selectedSlides = [];
            slideGrid.querySelectorAll('input').forEach((cb, i) => {
                if (cb.checked) selectedSlides.push(i);
            });

            if (selectedSlides.length === 0) {
                alert("Wybierz przynajmniej jeden slajd.");
                return;
            }

            const zip = new JSZip();
            const frame = document.querySelector('.app-frame');
            
            // Temporary hide navigation and tap zones for clean capture
            const nav = document.getElementById('navHeader');
            const tl = document.getElementById('btnPrev');
            const tr = document.getElementById('btnNext');
            nav.style.opacity = '0';
            tl.style.display = 'none';
            tr.style.display = 'none';

            // Store current index to restore later
            const originalIdx = currentIdx;

            for (const idx of selectedSlides) {
                showSlide(idx);
                // Wait for animations/charts to settle
                await new Promise(r => setTimeout(r, 600)); 
                
                const canvas = await html2canvas(frame, {
                    backgroundColor: '#000',
                    scale: 2, // High quality
                    useCORS: true,
                    logging: false
                });
                
                const dataUrl = canvas.toDataURL('image/jpeg', 0.9);
                const base64Data = dataUrl.replace(/^data:image\/jpeg;base64,/, "");
                zip.file(`slide_${idx + 1}.jpg`, base64Data, { base64: true });
            }

            // Restore UI
            nav.style.opacity = '1';
            tl.style.display = 'block';
            tr.style.display = 'block';
            showSlide(originalIdx);

            const content = await zip.generateAsync({ type: 'blob' });
            const url = URL.createObjectURL(content);
            const a = document.createElement('a');
            a.href = url;
            a.download = `messenger_wrapped_images.zip`;
            a.click();
        }
    </script>
</body>
</html>
