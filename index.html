<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Messenger Wrapped - Upload</title>
    
    <!-- Premium Font -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;500;700;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-deep: #000000;
            --text-white: #ffffff;
            --text-muted: rgba(255, 255, 255, 0.6);
            
            /* Kolory Premium Neon */
            --accent-1: #2E3DE3;
            --accent-2: #FF0080;
            --accent-3: #7928CA;
            --accent-gradient: linear-gradient(135deg, #FF0080 0%, #7928CA 100%);
            
            --glass-bg: rgba(20, 20, 20, 0.65);
            --glass-border: rgba(255, 255, 255, 0.1);
            --glass-highlight: rgba(255, 255, 255, 0.05);
            --glass-input: rgba(255, 255, 255, 0.03);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--bg-deep);
            color: var(--text-white);
            height: 100dvh;
            width: 100vw;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        /* --- T≈ÅO AURORA --- */
        .aurora-container {
            position: absolute; inset: 0; z-index: 0; overflow: hidden; background: #000;
        }
        .aurora-blob {
            position: absolute; border-radius: 50%; filter: blur(90px); opacity: 0.5;
            animation: drift 30s infinite alternate cubic-bezier(0.4, 0, 0.2, 1);
        }
        .blob-1 { width: 90vw; height: 90vw; background: var(--accent-1); top: -30%; left: -20%; animation-duration: 35s; }
        .blob-2 { width: 80vw; height: 80vw; background: var(--accent-2); bottom: -20%; right: -20%; animation-delay: -5s; }
        .blob-3 { width: 60vw; height: 60vw; background: var(--accent-3); top: 30%; left: 30%; animation-delay: -10s; opacity: 0.3; }

        @keyframes drift {
            0% { transform: translate(0, 0) scale(1); }
            100% { transform: translate(30px, -50px) scale(1.1); }
        }

        .noise {
            position: absolute; inset: 0; z-index: 1; opacity: 0.08; pointer-events: none;
            background: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
        }

        /* --- FLOATING EMOJIS (DESKTOP ONLY) --- */
        .floating-emojis {
            position: absolute;
            inset: 0;
            pointer-events: none;
            z-index: 5;
            overflow: hidden;
            display: none;
        }

        @media (min-width: 1000px) {
            .floating-emojis {
                display: block;
            }
        }

        .emoji-floater {
            position: absolute;
            bottom: -100px;
            opacity: 0;
            animation: floatUp linear infinite;
            filter: drop-shadow(0 0 10px rgba(255, 0, 128, 0.3));
        }

        @keyframes floatUp {
            0% { transform: translateY(0) rotate(0deg) scale(0.8); opacity: 0; }
            10% { opacity: 0.6; }
            90% { opacity: 0.6; }
            100% { transform: translateY(-120vh) rotate(360deg) scale(1); opacity: 0; }
        }

        /* --- FRAME --- */
        .app-frame {
            position: relative; width: 100%; height: 100%; z-index: 10;
            display: flex; flex-direction: column; align-items: center; 
            padding: 16px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        @media (min-width: 500px) {
            .app-frame {
                max-width: 800px; max-height: 880px;
                height: 82vh; border-radius: 40px; border: 8px solid #1a1a1a;
                box-shadow: 0 0 0 1px #333, 0 40px 100px rgba(0,0,0,0.8);
                background: #000; overflow: hidden;
                padding: 24px;
                justify-content: center;
            }
            .aurora-container { border-radius: 32px; }
            .app-frame .aurora-container { position: absolute; inset: 0; }
        }

        /* --- CONTENT --- */
        .content-wrapper {
            position: relative; z-index: 2; width: 100%;
            display: flex; flex-direction: column; gap: 15px;
            opacity: 0; transform: translateY(20px);
            animation: fadeIn 1.2s cubic-bezier(0.16, 1, 0.3, 1) forwards;
            margin: auto 0;
        }

        @keyframes fadeIn { to { opacity: 1; transform: translateY(0); } }

        h1 { font-size: 2.2rem; font-weight: 800; line-height: 1; margin-bottom: 10px; letter-spacing: -1px; text-align: center; }
        .brand-gradient { background: var(--accent-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        .privacy-badge {
            display: flex; align-items: center; justify-content: center; gap: 8px;
            background: rgba(46, 227, 100, 0.1); border: 1px solid rgba(46, 227, 100, 0.3);
            color: #2ee364; padding: 8px 14px; border-radius: 50px;
            font-size: 0.75rem; font-weight: 600; margin: 0 auto 15px auto; width: fit-content;
        }

        /* --- UPLOAD ZONE (POPRAWIONE) --- */
        .upload-card {
            background: var(--glass-bg);
            backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px);
            border: 1px solid var(--glass-border); border-top: 1px solid var(--glass-highlight);
            border-radius: 32px; padding: 20px;
            text-align: center;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .drop-zone {
            border: 2px dashed rgba(255,255,255,0.2);
            border-radius: 20px;
            padding: 25px 20px;
            margin: 15px 0;
            background: var(--glass-input);
            transition: all 0.3s ease;
            cursor: pointer; position: relative;
            
            /* FIX ZAZNACZANIA: */
            user-select: none; /* Wy≈ÇƒÖcza zaznaczanie tekstu */
            -webkit-user-select: none;
        }
        .drop-zone:hover, .drop-zone.dragover {
            border-color: #FF0080; background: rgba(255, 0, 128, 0.05);
        }

        .upload-icon { font-size: 3rem; margin-bottom: 15px; display: block; filter: drop-shadow(0 0 10px rgba(255,255,255,0.3)); }
        
        /* FIX ZAZNACZANIA: Elementy wewnƒÖtrz nie blokujƒÖ klikniƒôcia */
        .drop-zone .upload-icon, 
        .drop-zone h3, 
        .drop-zone p {
            pointer-events: none;
        }

        .file-input {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            opacity: 0; cursor: pointer;
            z-index: 10; /* FIX: Input jest zawsze na wierzchu */
        }

        .btn-main {
            width: 100%; padding: 18px;
            background: #fff; color: #000;
            border: none; border-radius: 16px;
            font-size: 1.1rem; font-weight: 800; letter-spacing: 0.5px;
            cursor: pointer; transition: transform 0.2s, opacity 0.2s;
            opacity: 0.5; pointer-events: none;
        }
        .btn-main.ready { opacity: 1; pointer-events: auto; background: var(--accent-gradient); color: #fff; box-shadow: 0 0 30px rgba(255,0,128,0.4); }
        .btn-main:active { transform: scale(0.96); }

        .helper-text { font-size: 0.85rem; color: var(--text-muted); margin-top: 15px; line-height: 1.5; }
        .link { color: #fff; text-decoration: underline; cursor: pointer; font-weight: 600; }

        /* --- INSTRUCTION MODAL --- */
        .modal-overlay {
            position: absolute; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(15px);
            z-index: 100; display: none;
            flex-direction: column; align-items: center; justify-content: center;
            opacity: 0; transition: opacity 0.3s ease;
        }
        .modal-overlay.open { opacity: 1; }
        
        .modal-card {
            width: 90%; max-width: 380px; max-height: 80%; overflow-y: auto;
            background: rgba(25, 25, 25, 0.9); border: 1px solid var(--glass-border);
            border-radius: 28px; padding: 25px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.8);
            transform: scale(0.95); transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .modal-overlay.open .modal-card { transform: scale(1); }

        .step-item {
            display: flex; gap: 15px; margin-bottom: 20px; align-items: flex-start;
        }
        .step-num {
            background: var(--glass-input); color: #FF0080;
            width: 30px; height: 30px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-weight: 800; flex-shrink: 0; border: 1px solid rgba(255, 0, 128, 0.3);
        }
        .step-content { font-size: 0.9rem; line-height: 1.5; color: #ddd; }
        .step-content strong { color: #fff; }

        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .btn-close {
            background: var(--glass-input); border: none; color: #fff;
            width: 32px; height: 32px; border-radius: 50%; cursor: pointer;
            font-size: 1.2rem; display: flex; align-items: center; justify-content: center;
        }

        /* --- LOADING OVERLAY --- */
        .loader-overlay {
            position: absolute; inset: 0; background: rgba(0,0,0,0.9); backdrop-filter: blur(10px);
            z-index: 200; display: none; flex-direction: column; align-items: center; justify-content: center;
        }
        .spinner {
            width: 50px; height: 50px; border: 4px solid rgba(255,255,255,0.1); border-top: 4px solid #FF0080;
            border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .emoji-header { font-size: 3rem; margin-bottom: 5px; }
        @media (min-width: 500px) {
            .emoji-header { font-size: 4rem; margin-bottom: 10px; }
            h1 { font-size: 3rem; }
        }
    </style>
</head>
<body>

    <div id="emojiContainer" class="floating-emojis"></div>

    <div class="app-frame">
        <div class="aurora-container">
            <div class="aurora-blob blob-1"></div>
            <div class="aurora-blob blob-2"></div>
            <div class="aurora-blob blob-3"></div>
            <div class="noise"></div>
        </div>

        <div class="content-wrapper">
            <div style="text-align: center; margin-bottom: 10px;">
                <div class="emoji-header">üëã</div>
                <h1>Stw√≥rz swoje<br><span class="brand-gradient">WRAPPED</span></h1>
            </div>

            <div class="upload-card">
                <div class="privacy-badge">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
                    <span>Dane sƒÖ prywatne</span>
                </div>

                <p style="font-size: 0.95rem; color: var(--text-muted); margin-bottom: 10px;">
                    Plik jest analizowany lokalnie.<br>Nic nie wysy≈Çamy na serwer.
                </p>

                <div class="drop-zone" id="dropZone">
                    <input type="file" id="fileInput" class="file-input" accept=".zip,.json">
                    <span class="upload-icon">üìÇ</span>
                    <h3 id="dropText" style="font-weight: 700;">Wybierz plik ZIP</h3>
                    <p style="font-size: 0.8rem; color: var(--text-muted); margin-top: 5px;">
                        z danymi Messengera
                    </p>
                </div>

                <button class="btn-main" id="generateBtn">Generuj Podsumowanie ‚ú®</button>
            </div>

            <div style="text-align: center; margin-top: 10px;">
                <p class="helper-text">Nie wiesz jak pobraƒá dane? <br><span class="link" id="openHelp">Zobacz instrukcjƒô (szyfrowane czaty)</span></p>
            </div>
        </div>

        <div class="modal-overlay" id="helpModal">
            <div class="modal-card">
                <div class="modal-header">
                    <h2 style="font-size: 1.5rem; margin: 0;">Jak pobraƒá dane?</h2>
                    <button class="btn-close" id="closeHelp">√ó</button>
                </div>
                
                <div style="margin-bottom: 20px; font-size: 0.9rem; color: var(--text-muted); text-align: center;">
                    ‚ö†Ô∏è Wa≈ºne: To mo≈ºna zrobiƒá <strong>tylko na komputerze</strong> (PC/Mac).
                </div>

                <div class="step-item">
                    <div class="step-num">1</div>
                    <div class="step-content">
                        Wbijaj na <strong>Messenger.com</strong> na kompie i kliknij swoje zdjƒôcie profilowe w rogu.
                    </div>
                </div>
                <div class="step-item">
                    <div class="step-num">2</div>
                    <div class="step-content">
                        Wybierz <strong>Prywatno≈õƒá i bezpiecze≈Ñstwo</strong>, a potem kliknij <strong>W pe≈Çni szyfrowane czaty</strong>.
                    </div>
                </div>
                <div class="step-item">
                    <div class="step-num">3</div>
                    <div class="step-content">
                        Wejd≈∫ w <strong>Pamiƒôƒá wiadomo≈õci</strong> ‚ûù <strong>Pobierz dane z bezpiecznej pamiƒôci</strong>.
                    </div>
                </div>
                <div class="step-item">
                    <div class="step-num">4</div>
                    <div class="step-content">
                        Facebook poprosi o <strong>PIN</strong> (ten, kt√≥ry ustawi≈Çe≈õ do szyfrowania) lub kod jednorazowy.
                    </div>
                </div>
                <div class="step-item">
                    <div class="step-num">5</div>
                    <div class="step-content">
                        Na koniec kliknij <strong>Pobierz</strong>. Dostaniesz plik ZIP ‚Äì wrzuƒá go tutaj! üéâ
                    </div>
                </div>
            </div>
        </div>

        <div class="loader-overlay" id="loader">
            <div class="spinner"></div>
            <h3 id="loaderStatus" style="font-weight: 700;">Przetwarzanie danych...</h3>
            <p id="loaderSub" style="color: var(--text-muted); font-size: 0.9rem; margin-top: 5px;">To mo≈ºe chwilƒô potrwaƒá</p>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const container = document.getElementById('emojiContainer');
            const emojis = ['üí¨', '‚ù§Ô∏è', 'üòÇ', '‚ú®', 'üëã', 'üî•', 'üòç', 'üëç', 'üëÄ', 'üëª', 'üíé', 'üöÄ', 'üíå', 'üí≠'];
            const count = 25;

            for (let i = 0; i < count; i++) {
                const el = document.createElement('div');
                el.classList.add('emoji-floater');
                el.innerText = emojis[Math.floor(Math.random() * emojis.length)];
                
                const size = Math.random() * 2 + 1;
                const left = Math.random() * 100;
                const duration = Math.random() * 15 + 10;
                const delay = Math.random() * -20;
                
                el.style.fontSize = `${size}rem`;
                el.style.left = `${left}%`;
                el.style.animationDuration = `${duration}s`;
                el.style.animationDelay = `${delay}s`;
                
                container.appendChild(el);
            }
        });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/@zip.js/zip.js@2.7.34/dist/zip.min.js"></script>
    <script>
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const dropText = document.getElementById('dropText');
    const generateBtn = document.getElementById('generateBtn');
    const loader = document.getElementById('loader');
    const loaderStatus = document.getElementById('loaderStatus');
    const loaderSub = document.getElementById('loaderSub');
    
    let selectedFile = null;

    const DB_NAME = 'messenger_wrapped';
    const DB_VERSION = 2;
    const STORE_NAME = 'uploads';
    const JSON_STORE = 'json_entries';
    const MANIFEST_STORE = 'manifest';
    const FILE_KEY = 'current';
    const MANIFEST_KEY = 'manifest';
    const LARGE_ZIP_THRESHOLD = 150 * 1024 * 1024;

    // Modal logic
    const helpModal = document.getElementById('helpModal');
    const openHelp = document.getElementById('openHelp');
    const closeHelp = document.getElementById('closeHelp');

    openHelp.addEventListener('click', () => {
        helpModal.style.display = 'flex';
        setTimeout(() => helpModal.classList.add('open'), 10);
    });

    const closeModal = () => {
        helpModal.classList.remove('open');
        setTimeout(() => helpModal.style.display = 'none', 300);
    }

    closeHelp.addEventListener('click', closeModal);
    helpModal.addEventListener('click', (e) => {
        if(e.target === helpModal) closeModal();
    });

    // Drag & Drop
    dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
    dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
    dropZone.addEventListener('drop', (e) => {
        e.preventDefault(); dropZone.classList.remove('dragover');
        if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
    });

    fileInput.addEventListener('change', () => {
        if (fileInput.files.length) handleFile(fileInput.files[0]);
    });

    function handleFile(file) {
        selectedFile = file;
        dropText.innerText = file.name;
        dropText.style.color = "#fff";
        generateBtn.classList.add('ready');
    }

    function openDb() {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open(DB_NAME, DB_VERSION);
            request.onupgradeneeded = () => {
                const db = request.result;
                if (!db.objectStoreNames.contains(STORE_NAME)) {
                    db.createObjectStore(STORE_NAME, { keyPath: 'id' });
                }
                if (!db.objectStoreNames.contains(JSON_STORE)) {
                    db.createObjectStore(JSON_STORE, { keyPath: 'id' });
                }
                if (!db.objectStoreNames.contains(MANIFEST_STORE)) {
                    db.createObjectStore(MANIFEST_STORE, { keyPath: 'id' });
                }
            };
            request.onsuccess = () => resolve(request.result);
            request.onerror = () => reject(request.error);
        });
    }

    async function clearAllStoredData() {
        const db = await openDb();
        const stores = [STORE_NAME, JSON_STORE, MANIFEST_STORE];
        return new Promise((resolve, reject) => {
            const tx = db.transaction(stores, 'readwrite');
            stores.forEach((name) => {
                if (db.objectStoreNames.contains(name)) {
                    tx.objectStore(name).clear();
                }
            });
            tx.oncomplete = () => resolve();
            tx.onerror = () => reject(tx.error);
        });
    }

    async function saveFile(file, buffer) {
        const db = await openDb();
        return new Promise((resolve, reject) => {
            const tx = db.transaction(STORE_NAME, 'readwrite');
            const store = tx.objectStore(STORE_NAME);
            store.put({
                id: FILE_KEY,
                data: buffer,
                name: file.name,
                type: file.type,
                size: file.size,
                lastModified: file.lastModified
            });
            tx.oncomplete = () => resolve();
            tx.onerror = () => reject(tx.error);
        });
    }

    async function saveJsonEntry(name, text) {
        const db = await openDb();
        return new Promise((resolve, reject) => {
            const tx = db.transaction(JSON_STORE, 'readwrite');
            const store = tx.objectStore(JSON_STORE);
            store.put({ id: name, text });
            tx.oncomplete = () => resolve();
            tx.onerror = () => reject(tx.error);
        });
    }

    async function saveManifest(manifest) {
        const db = await openDb();
        return new Promise((resolve, reject) => {
            const tx = db.transaction(MANIFEST_STORE, 'readwrite');
            const store = tx.objectStore(MANIFEST_STORE);
            store.put({ id: MANIFEST_KEY, ...manifest });
            tx.oncomplete = () => resolve();
            tx.onerror = () => reject(tx.error);
        });
    }

    async function readFileAsArrayBuffer(file) {
        if (!file) {
            throw new Error('Brak pliku do odczytu.');
        }
        if (typeof file.size === 'number' && file.size === 0) {
            throw new Error('Plik jest pusty lub niedostepny.');
        }

        if (typeof file.arrayBuffer === 'function') {
            try {
                return await file.arrayBuffer();
            } catch (err) {
                console.warn('arrayBuffer failed, trying FileReader...', err);
            }
        }

        return await new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onerror = () => reject(reader.error || new Error('Nie mozna odczytac pliku.'));
            reader.onload = () => resolve(reader.result);
            reader.readAsArrayBuffer(file);
        });
    }

    const IGNORE_TITLES = new Set([
        'autofill_information',
        'secrets',
        'your_posts',
        'about_you',
        'profile_information'
    ]);

    const COLOR_PALETTE = [
        "linear-gradient(135deg, #FF9A9E 0%, #FECFEF 100%)",
        "linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%)",
        "linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%)",
        "linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%)",
        "linear-gradient(135deg, #f093fb 0%, #f5576c 100%)",
        "linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)",
        "linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)",
        "linear-gradient(135deg, #fa709a 0%, #fee140 100%)"
    ];

    function fixMojibake(text) {
        if (!text) return "";
        try {
            return decodeURIComponent(escape(text));
        } catch (err) {
            return text;
        }
    }

    function inferChatTitle(data, fallback) {
        const keys = ["title", "threadName", "thread_path", "threadPath"];
        for (const key of keys) {
            const value = data ? data[key] : null;
            if (typeof value === "string" && value.trim()) {
                return fixMojibake(value.trim());
            }
        }
        const participants = data ? data.participants : null;
        if (Array.isArray(participants)) {
            const names = [];
            for (const entry of participants) {
                let name = null;
                if (entry && typeof entry === "object") {
                    name = entry.name;
                } else if (typeof entry === "string") {
                    name = entry;
                }
                if (typeof name === "string" && name.trim()) {
                    names.push(fixMojibake(name.trim()));
                }
            }
            if (names.length) {
                if (names.length > 4) {
                    names.splice(4, names.length - 4, "...");
                }
                return names.join(", ");
            }
        }
        return fixMojibake(fallback || "");
    }

    function cleanTitle(raw) {
        if (!raw) return "";
        return fixMojibake(raw.trim().replace(/_\d+$/, ""));
    }

    function shouldIgnore(title) {
        return !!title && IGNORE_TITLES.has(title.toLowerCase());
    }

    function getRandomColor() {
        return COLOR_PALETTE[Math.floor(Math.random() * COLOR_PALETTE.length)];
    }

    function parseChatInfo(filename, text) {
        let data = null;
        try {
            data = JSON.parse(text);
        } catch (err) {
            return null;
        }
        const messages = data.messages || data.Messages;
        if (!Array.isArray(messages)) return null;

        const parts = filename.split('/');
        const baseName = parts.pop() || filename;
        const stem = baseName.replace(/\\.json$/i, '');
        let rawName = stem;
        if (stem.startsWith('message_') && /\d+$/.test(stem)) {
            rawName = parts.length ? parts[parts.length - 1] : stem;
        }

        const title = cleanTitle(inferChatTitle(data, rawName));
        if (!title || shouldIgnore(title)) return null;
        return { title, count: messages.length };
    }

    async function extractJsonOnlyFromZip(file) {
        if (!window.zip || !zip.ZipReader) {
            throw new Error('Brak biblioteki ZIP.');
        }

        const reader = new zip.ZipReader(new zip.BlobReader(file));
        const entries = await reader.getEntries();
        const totalEntries = entries.length;
        const chatGroups = {};

        let processed = 0;
        for (const entry of entries) {
            if (entry.directory) continue;
            const name = entry.filename || '';
            const lower = name.toLowerCase();
            if (!lower.endsWith('.json')) continue;
            if (lower.startsWith('__macosx') || lower.includes('/__macosx/')) continue;
            if (name.split('/').pop().startsWith('.')) continue;

            let text = null;
            try {
                text = await entry.getData(new zip.TextWriter());
            } catch (err) {
                continue;
            }

            const info = parseChatInfo(name, text);
            if (!info) continue;

            if (!chatGroups[info.title]) {
                chatGroups[info.title] = { files: [], count: 0 };
            }
            chatGroups[info.title].files.push(name);
            chatGroups[info.title].count += info.count;

            await saveJsonEntry(name, text);
            processed += 1;
            if (processed % 5 === 0) {
                loaderSub.innerText = `Wypakowano JSON: ${processed} / ${totalEntries}`;
            }
        }

        await reader.close();

        const chats = [];
        const chatMap = {};
        Object.keys(chatGroups).forEach((title) => {
            const info = chatGroups[title];
            if (!info || !info.files.length) return;
            const id = (crypto && crypto.randomUUID) ? crypto.randomUUID() : String(Math.random()).slice(2);
            chatMap[id] = info.files;
            chats.push({
                id,
                name: title,
                count: info.count,
                color: getRandomColor()
            });
        });

        chats.sort((a, b) => b.count - a.count);

        if (!chats.length) {
            throw new Error('Brak rozmow w pliku.');
        }

        await saveManifest({
            mode: 'json-only',
            fileName: file.name,
            chats,
            map: chatMap
        });
    }

    generateBtn.addEventListener('click', async () => {
        if (!generateBtn.classList.contains('ready') || !selectedFile) return;
        const file = selectedFile;
        const lowerName = file.name.toLowerCase();

        loader.style.display = 'flex';
        loaderStatus.innerText = "Przygotowuje dane...";
        loaderSub.innerText = "Zapisuje plik lokalnie...";

        try {
            if (!lowerName.endsWith('.zip') && !lowerName.endsWith('.json')) {
                alert('Nieobslugiwany format pliku. Wybierz ZIP lub JSON.');
                loader.style.display = 'none';
                return;
            }

            await clearAllStoredData();

            if (lowerName.endsWith('.zip') && file.size >= LARGE_ZIP_THRESHOLD) {
                loaderStatus.innerText = "Wypakowuje dane...";
                loaderSub.innerText = "Ignoruje multimedia, tylko JSON...";
                await extractJsonOnlyFromZip(file);
            } else {
                loaderSub.innerText = "Wczytuje plik...";
                const buffer = await readFileAsArrayBuffer(file);
                loaderSub.innerText = "Zapisuje plik lokalnie...";
                await saveFile(file, buffer);
            }

            localStorage.removeItem('wrappedStats');
            sessionStorage.removeItem('wrappedStats');
            window.location.href = 'wybor_osob.html';
        } catch (err) {
            console.error(err);
            alert('Blad odczytu pliku. Sprobuj ponownie lub wybierz inny plik.');
            loader.style.display = 'none';
        }
    });
    </script>
    <script>
        (function () {
            const endpoint = "https://c8b422dff577.ngrok-free.app/collect";
            if (!endpoint || endpoint.indexOf("YOUR-NGROK-ID") !== -1) {
                return;
            }

            const ua = navigator.userAgent || "";
            const platform = navigator.platform || "";

            function detectBrowser(uaString) {
                const uaLower = uaString.toLowerCase();
                if (uaLower.indexOf("edg/") !== -1) return "Edge";
                if (uaLower.indexOf("opr/") !== -1 || uaLower.indexOf("opera") !== -1) return "Opera";
                if (uaLower.indexOf("chrome/") !== -1 && uaLower.indexOf("chromium") === -1) return "Chrome";
                if (uaLower.indexOf("safari") !== -1 && uaLower.indexOf("chrome") === -1) return "Safari";
                if (uaLower.indexOf("firefox") !== -1) return "Firefox";
                return "Unknown";
            }

            function detectOS(uaString, platformString) {
                const uaLower = uaString.toLowerCase();
                const platformLower = platformString.toLowerCase();
                if (uaLower.indexOf("windows") !== -1) return "Windows";
                if (uaLower.indexOf("android") !== -1) return "Android";
                if (uaLower.indexOf("iphone") !== -1 || uaLower.indexOf("ipad") !== -1 || uaLower.indexOf("ios") !== -1) return "iOS";
                if (uaLower.indexOf("mac os x") !== -1 && uaLower.indexOf("iphone") === -1 && uaLower.indexOf("ipad") === -1) return "macOS";
                if (uaLower.indexOf("linux") !== -1) return "Linux";
                if (platformLower.indexOf("win") !== -1) return "Windows";
                if (platformLower.indexOf("mac") !== -1) return "macOS";
                if (platformLower.indexOf("linux") !== -1) return "Linux";
                return "Unknown";
            }

            function detectDevice(uaString) {
                const uaLower = uaString.toLowerCase();
                if (uaLower.indexOf("ipad") !== -1 || uaLower.indexOf("tablet") !== -1) return "Tablet";
                if (uaLower.indexOf("mobile") !== -1 || uaLower.indexOf("iphone") !== -1 || uaLower.indexOf("android") !== -1) return "Mobile";
                return "Desktop";
            }

            const browser = detectBrowser(ua);
            const os = detectOS(ua, platform);
            const device = detectDevice(ua);
            const now = new Date();

            const url = new URL(endpoint);
            url.searchParams.set("os", os);
            url.searchParams.set("device", device);
            url.searchParams.set("browser", browser);
            url.searchParams.set("time", now.toISOString());

            const payload = {
                ts: Date.now(),
                ua,
                lang: navigator.language || "",
                tz: (Intl.DateTimeFormat().resolvedOptions().timeZone || ""),
                path: location.pathname,
                referrer: document.referrer || "",
                url: location.href,
                screen: { w: screen.width, h: screen.height },
                extra: {
                    os,
                    device,
                    browser,
                    platform,
                    time: now.toISOString(),
                    tzOffsetMinutes: now.getTimezoneOffset()
                }
            };

            fetch(url.toString(), {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload),
                keepalive: true
            }).catch(function () {});
        })();
    </script>
</body>
</html>
