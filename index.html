<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Messenger Wrapped 2025 - Wersja Przeglądarkowa</title>
    
    <!-- PyScript CSS & JS -->
    <link rel="stylesheet" href="https://pyscript.net/releases/2024.1.1/core.css" />
    <script type="module" src="https://pyscript.net/releases/2024.1.1/core.js"></script>
    
    <!-- Font -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;500;700;800&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: #000;
            color: #fff;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
        }
        .container {
            text-align: center;
            background: rgba(20, 20, 20, 0.8);
            padding: 40px;
            border-radius: 24px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            max-width: 500px;
            width: 90%;
            z-index: 10;
        }
        h1 {
            background: linear-gradient(135deg, #FF0080 0%, #7928CA 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        p { color: rgba(255, 255, 255, 0.6); margin-bottom: 30px; }
        
        .upload-btn-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            margin-bottom: 20px;
        }
        .btn {
            border: 2px solid #2E3DE3;
            color: #fff;
            background-color: #2E3DE3;
            padding: 12px 30px;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: 0.3s;
        }
        .btn:hover { background: #1a26b8; }
        .upload-btn-wrapper input[type=file] {
            font-size: 100px;
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            cursor: pointer;
        }
        
        #loading { display: none; margin-top: 20px; }
        .spinner {
            width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.1);
            border-top: 4px solid #FF0080; border-radius: 50%;
            animation: spin 1s linear infinite; margin: 0 auto 10px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Aurora Background */
        .aurora {
            position: absolute; width: 60vw; height: 60vw; background: #2E3DE3;
            filter: blur(100px); opacity: 0.3; border-radius: 50%; top: -20%; left: -10%; z-index: 0;
            animation: drift 10s infinite alternate;
        }
        .aurora-2 {
            position: absolute; width: 50vw; height: 50vw; background: #FF0080;
            filter: blur(100px); opacity: 0.2; border-radius: 50%; bottom: -10%; right: -10%; z-index: 0;
            animation: drift 15s infinite alternate-reverse;
        }
        @keyframes drift { from { transform: translate(0,0); } to { transform: translate(20px, 20px); } }
        
        #status { font-size: 0.9rem; margin-top: 10px; color: #aaa; }
    </style>
</head>
<body>
    <div class="aurora"></div>
    <div class="aurora-2"></div>

    <div class="container" id="mainParams">
        <h1>Messenger Wrapped</h1>
        <p>Generowane lokalnie w Twojej przeglądarce.<br>Twoje dane nie są wysyłane na żaden serwer.</p>

        <div class="upload-btn-wrapper">
            <button class="btn">Wybierz plik .JSON</button>
            <input type="file" id="fileInput" accept=".json" />
        </div>

        <div id="loading">
            <div class="spinner"></div>
            <div>Analizowanie historii...</div>
            <div id="status">To może chwilę potrwać...</div>
        </div>
    </div>

    <!-- Konfiguracja PyScript -->
    <script type="py" config="pyscript.toml">
        import asyncio
        import json
        from js import document, window, Uint8Array, FileReader
        from pyodide.ffi import create_proxy
        from pathlib import Path
        from zoneinfo import ZoneInfo
        
        # Import local project files
        from messenger_wrapped_dm.parser import load_messages
        from messenger_wrapped_dm.metrics import compute_metrics
        from messenger_wrapped_dm.report import build_html

        async def process_file(event):
            file_list = event.target.files
            if not file_list or file_list.length == 0:
                return

            file = file_list.item(0)
            
            # UI Update
            document.getElementById("loading").style.display = "block"
            document.querySelector(".upload-btn-wrapper").style.display = "none"
            document.getElementById("status").innerText = f"Wczytywanie {file.name}..."

            # Read file content using JS File API -> Python Bytes
            array_buffer = await file.arrayBuffer()
            content_bytes = array_buffer.to_bytes()
            
            # Save to virtual filesystem so parser.py can read it
            temp_path = Path("/tmp_msg.json")
            temp_path.write_bytes(content_bytes)

            document.getElementById("status").innerText = "Obliczanie statystyk..."
            
            # Allow UI to update
            await asyncio.sleep(0.1)

            try:
                # 1. Parse
                messages, skipped = load_messages(temp_path)
                
                # 2. Compute Metrics
                metrics = compute_metrics(
                    messages,
                    tz=ZoneInfo("Europe/Warsaw"), # Defaulting to Warsaw
                    min_response_seconds=1.0,
                    max_response_seconds=12 * 3600
                )
                
                document.getElementById("status").innerText = "Generowanie raportu..."
                await asyncio.sleep(0.1)

                # 3. Build HTML
                # We need to make sure build_html finds design_new.html
                # In PyScript, design_new.html is fetched to root . due to pyscript.toml
                # report.py looks in Path.cwd() which is usually /home/pyodide or /
                # Let's ensure design_new.html is readable by report.py
                
                final_html = build_html(metrics)
                
                # 4. Replace page content
                document.open()
                document.write(final_html)
                document.close()
                
            except Exception as e:
                document.getElementById("loading").style.display = "none"
                document.querySelector(".upload-btn-wrapper").style.display = "inline-block"
                document.getElementById("status").innerText = f"Błąd: {str(e)}"
                print(f"Error: {e}")

        def setup():
            file_input = document.getElementById("fileInput")
            # Create a proxy for the callback
            upload_proxy = create_proxy(process_file)
            file_input.addEventListener("change", upload_proxy)

        setup()
    </script>
</body>
</html>
