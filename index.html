<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Messenger Wrapped 2025</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;500;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- PyScript -->
    <link rel="stylesheet" href="https://pyscript.net/releases/2024.1.1/core.css" />
    <script type="module" src="https://pyscript.net/releases/2024.1.1/core.js"></script>
    <script type="py" src="logic_v3.py" config="pyscript.toml"></script>

    <style>
        :root {
            --bg-deep: #000000;
            --text-white: #ffffff;
            --text-muted: rgba(255, 255, 255, 0.6);
            --accent-1: #2E3DE3;
            --accent-2: #FF0080;
            --accent-3: #7928CA;
            --accent-gradient: linear-gradient(135deg, #FF0080 0%, #7928CA 100%);
            --glass-bg: rgba(20, 20, 20, 0.65);
            --glass-border: rgba(255, 255, 255, 0.1);
            --glass-highlight: rgba(255, 255, 255, 0.05);
            --glass-input: rgba(255, 255, 255, 0.03);
            --item-hover: rgba(255, 255, 255, 0.12);
            --item-selected: rgba(46, 61, 227, 0.3);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--bg-deep);
            color: var(--text-white);
            height: 100dvh;
            width: 100vw;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* --- T≈ÅO AURORA --- */
        .aurora-container {
            position: absolute; inset: 0; z-index: 0; overflow: hidden; background: #000;
        }
        .aurora-blob {
            position: absolute; border-radius: 50%; filter: blur(90px); opacity: 0.5;
            animation: drift 20s infinite alternate cubic-bezier(0.4, 0, 0.2, 1);
        }
        .blob-1 { width: 90vw; height: 90vw; background: var(--accent-1); top: -30%; left: -20%; animation-duration: 25s; }
        .blob-2 { width: 80vw; height: 80vw; background: var(--accent-2); bottom: -20%; right: -20%; animation-delay: -5s; }
        .blob-3 { width: 60vw; height: 60vw; background: var(--accent-3); top: 30%; left: 30%; animation-delay: -10s; opacity: 0.3; }

        @keyframes drift {
            0% { transform: translate(0, 0) scale(1); }
            100% { transform: translate(30px, -50px) scale(1.1); }
        }

        .noise {
            position: absolute; inset: 0; z-index: 1; opacity: 0.08; pointer-events: none;
            background: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
        }

        /* --- FRAME --- */
        .app-frame {
            position: relative; width: 100%; height: 100%; z-index: 10;
            display: flex; flex-direction: column; 
            padding: 16px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        @media (min-width: 500px) {
            .app-frame {
                max-width: 800px; max-height: 880px;
                height: 82vh; border-radius: 40px; border: 8px solid #1a1a1a;
                box-shadow: 0 0 0 1px #333, 0 40px 100px rgba(0,0,0,0.8);
                background: #000; overflow: hidden;
                padding: 24px;
            }
            .app-frame.wrapped-mode {
                max-width: 480px; max-height: 860px; height: 85vh;
            }
            .aurora-container { border-radius: 32px; }
            .app-frame .aurora-container { position: absolute; inset: 0; }
        }

        /* --- CONTENT UPLOAD --- */
        .content-wrapper {
            position: relative; z-index: 2; width: 100%;
            display: flex; flex-direction: column; gap: 15px;
            margin: auto 0;
            animation: fadeIn 0.8s forwards;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .emoji-header { font-size: 3rem; margin-bottom: 5px; text-align: center; }
        h1 { font-size: 2.2rem; font-weight: 800; line-height: 1; margin-bottom: 10px; text-align: center; }
        @media (min-width: 500px) {
            .emoji-header { font-size: 4rem; margin-bottom: 10px; }
            h1 { font-size: 3rem; }
        }

        .brand-gradient { background: var(--accent-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        .upload-card {
            background: var(--glass-bg); backdrop-filter: blur(30px);
            border: 1px solid var(--glass-border); border-radius: 32px; padding: 20px;
            text-align: center;
        }
        .drop-zone {
            border: 2px dashed rgba(255,255,255,0.2); border-radius: 20px; padding: 25px 20px;
            margin: 15px 0; background: var(--glass-input); cursor: pointer; position: relative;
        }
        .btn-main {
            width: 100%; padding: 18px; background: #fff; color: #000;
            border: none; border-radius: 16px; font-weight: 800;
            cursor: pointer; opacity: 0.5; pointer-events: none; transition: 0.2s;
        }
        .btn-main.ready { opacity: 1; pointer-events: auto; background: var(--accent-gradient); color: #fff; }

        /* --- LIST VIEW --- */
        .chat-list-container { flex: 1; overflow-y: auto; margin-bottom: 20px; padding-right: 5px; z-index: 20; }
        .chat-item {
            display: flex; align-items: center; gap: 15px; padding: 12px 16px; margin-bottom: 8px;
            background: var(--glass-input); border-radius: 18px; cursor: pointer; transition: 0.2s;
            border: 1px solid transparent;
        }
        .chat-item.selected { background: var(--item-selected); border-color: var(--accent-1); }
        .avatar { width: 48px; height: 48px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; flex-shrink: 0; }
        .search-input {
            width: 100%; padding: 14px 14px 14px 45px; background: var(--glass-input);
            border: 1px solid var(--glass-border); border-radius: 16px; color: #fff;
            margin-bottom: 20px;
        }

        /* --- WRAPPED VIEW --- */
        .slide {
            position: absolute; inset: 0; padding: 70px 16px 30px;
            display: flex; flex-direction: column; justify-content: center;
            opacity: 0; pointer-events: none; transition: opacity 0.6s;
        }
        .slide.active { opacity: 1; pointer-events: auto; }
        .nav-header { position: absolute; top: 0; left: 0; width: 100%; padding: 20px 12px; z-index: 20; display: flex; gap: 4px; }
        .progress-bar { flex: 1; height: 3px; background: rgba(255,255,255,0.2); border-radius: 4px; overflow: hidden; }
        .progress-fill { height: 100%; width: 0%; background: #fff; transition: width 0.1s linear; }
        .progress-bar.filled .progress-fill { width: 100%; }
        .progress-bar.active .progress-fill { width: 100%; }
        
        .glass-card {
            background: var(--glass-bg); backdrop-filter: blur(25px);
            border: 1px solid var(--glass-border); border-radius: 28px; padding: 24px; margin-top: 15px;
        }
        .floating-layer { position: absolute; inset: 0; overflow: hidden; pointer-events: none; z-index: 1; }
        .bg-el { position: absolute; animation: floatBG linear infinite; }
        @keyframes floatBG { 0% { transform: translateY(100vh); opacity: 0; } 10% { opacity: 0.5; } 90% { opacity: 0.5; } 100% { transform: translateY(-100px); opacity: 0; } }
        
        /* Floating Background Styles */
        .bg-emoji { font-size: 2rem; }
        .bg-bubble { border-radius: 12px; background: rgba(255,255,255,0.1); }
        .bg-bubble.right { border-radius: 12px 12px 0 12px; }
        .bg-bubble.left { border-radius: 12px 12px 12px 0; }
        .bg-bubble .dot { width: 4px; height: 4px; background: #fff; border-radius: 50%; display: inline-block; margin: 0 1px; }

        /* Helpers */
        .hidden { display: none !important; }
        .loader-overlay {
            position: absolute; inset: 0; background: rgba(0,0,0,0.9); backdrop-filter: blur(10px);
            z-index: 200; display: none; flex-direction: column; align-items: center; justify-content: center;
        }
        .spinner {
            width: 50px; height: 50px; border: 4px solid rgba(255,255,255,0.1); border-top: 4px solid #FF0080;
            border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Wrapped Charts/Elements */
        .huge-stat { font-size: 4rem; font-weight: 800; background: linear-gradient(to right, #fff, #b4b4b4); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .chart-wrapper { height: 220px; width: 100%; position: relative; margin: 20px 0; }
        .podium-container { display: flex; justify-content: center; align-items: flex-end; gap: 10px; height: 250px; margin: 20px 0 40px; }
        .podium-column { display: flex; flex-direction: column; align-items: center; justify-content: flex-end; width: 80px; }
        .podium-bar { width: 100%; border-radius: 12px 12px 0 0; background: rgba(255,255,255,0.1); display: flex; align-items: flex-end; justify-content: center; padding-bottom: 10px; transform: scaleY(0); transition: 1s; }
        .slide.active .podium-bar { transform: scaleY(1); }
        .podium-emoji { font-size: 3.5rem; margin-bottom: 10px; opacity: 0; transform: translateY(20px); transition: 0.6s; }
        .slide.active .podium-emoji { opacity: 1; transform: translateY(0); }
        .bar-2 { height: 120px; background: rgba(46,61,227,0.3); border-color: var(--accent-1); }
        .bar-1 { height: 160px; background: rgba(255,0,128,0.3); border-color: var(--accent-2); }
        .bar-3 { height: 90px; background: rgba(255,255,255,0.1); }
        .media-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 10px; }
        .media-item { background: rgba(255,255,255,0.05); border-radius: 16px; padding: 15px 10px; text-align: center; }

        .tap-zone { position: absolute; top: 0; bottom: 0; width: 40%; z-index: 50; cursor: pointer; }
        .tap-left { left: 0; } .tap-right { right: 0; }
    </style>
</head>
<body>

    <div class="app-frame" id="appFrame">
        <!-- Background -->
        <div class="aurora-container">
            <div class="aurora-blob blob-1"></div>
            <div class="aurora-blob blob-2"></div>
            <div class="aurora-blob blob-3"></div>
            <div class="noise"></div>
        </div>
        
        <!-- LOADER -->
        <div class="loader-overlay" id="loader">
            <div class="spinner"></div>
            <h3 id="loaderText" style="font-weight: 700;">Przetwarzanie...</h3>
        </div>

        <!-- VIEW 1: UPLOAD -->
        <div id="view-upload" class="content-wrapper">
            <div style="text-align: center; margin-bottom: 10px;">
                <div class="emoji-header">üëã</div>
                <h1>Stw√≥rz swoje<br><span class="brand-gradient">WRAPPED</span></h1>
            </div>

            <div class="upload-card">
                <div class="drop-zone" id="dropZone">
                    <input type="file" id="fileInput" class="file-input" accept=".zip,.json" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer;">
                    <span style="font-size: 3rem; display: block; margin-bottom: 10px;">üìÇ</span>
                    <h3 id="dropText" style="font-weight: 700;">Wybierz plik ZIP</h3>
                    <p style="font-size: 0.8rem; color: var(--text-muted);">z danymi Messengera</p>
                </div>
                <button class="btn-main" id="generateBtn">Analizuj Plik ‚ú®</button>
            </div>
            
            <p style="text-align: center; font-size: 0.8rem; color: var(--text-muted); margin-top: 20px;">
                Dzia≈Ça w 100% w przeglƒÖdarce.<br>Dane nie sƒÖ nigdzie wysy≈Çane.
            </p>
        </div>

        <!-- VIEW 2: LIST -->
        <div id="view-select" class="content-wrapper hidden" style="height: 100%; justify-content: flex-start;">
            <div style="text-align: center; margin-bottom: 10px;">
                <h2>Wybierz rozmowƒô</h2>
                <p style="color: var(--text-muted); font-size: 0.9rem;">Znaleziono: <span id="chatCount">0</span></p>
            </div>
            
            <input type="text" class="search-input" id="searchInput" placeholder="Szukaj...">
            
            <div class="chat-list-container" id="chatList">
                <!-- Items injected by JS/Python -->
            </div>
            
            <div style="text-align: center; margin-top: auto; padding-top: 10px;">
                <button class="btn-main" id="nextBtn">Generuj Wrapped üöÄ</button>
            </div>
        </div>

        <!-- VIEW 3: WRAPPED -->
        <div id="view-wrapped" class="hidden" style="width: 100%; height: 100%;">
            <div class="floating-layer" id="bgFloating"></div>
            <div class="nav-header" id="navHeader"></div>
            <div class="tap-zone tap-left" id="btnPrev"></div>
            <div class="tap-zone tap-right" id="btnNext"></div>

            <!-- Slides injected statically but values updated dynamically -->
            <section class="slide active">
                <div>
                    <h2 style="color: var(--text-muted); font-size: 1.2rem;">Cze≈õƒá!</h2>
                    <h1>MESSENGER<br><span class="brand-gradient">WRAPPED</span><br>2025</h1>
                </div>
                <div class="glass-card">
                    <p style="font-size: 1.1rem; color: #fff; opacity: 0.9;">Ten rok by≈Ç pe≈Çen powiadomie≈Ñ.</p>
                    <div class="huge-stat" id="introTotal">0</div>
                    <span style="font-size: 0.75rem; font-weight: 700; letter-spacing: 1.5px; text-transform: uppercase; color: var(--text-muted);">Wiadomo≈õci ≈ÇƒÖcznie</span>
                </div>
            </section>

            <section class="slide">
                <h1>Bitwa na<br>s≈Çowa</h1>
                <div class="chart-wrapper" style="height: 200px;"><canvas id="chartVersus"></canvas></div>
                <div class="glass-card" style="text-align: center; border-color: var(--accent-1);">
                    <p>Zwyciƒôzca</p>
                    <h3 id="winnerName" class="brand-gradient" style="font-size: 2.5rem; margin: 5px 0;">-</h3>
                    <p>Napisa≈Ç(a) <strong id="winnerPct">0%</strong> wiadomo≈õci.</p>
                </div>
            </section>

            <section class="slide">
                <h1>Zegar<br>Biologiczny</h1>
                <div class="chart-wrapper" style="height: 250px;"><canvas id="chartTime"></canvas></div>
                <div class="glass-card" style="display:flex; align-items:center; gap:15px;">
                    <div style="font-size: 2rem;">‚è∞</div>
                    <div><div style="font-size:0.75rem;">Ulubiona pora</div><div id="peakHour" style="font-size: 1.5rem; font-weight:700;">-</div></div>
                </div>
            </section>
            
            <section class="slide">
                <h1>Rutyna<br>Tygodnia</h1>
                <div class="chart-wrapper" style="height: 250px;"><canvas id="chartWeekdays"></canvas></div>
                <div class="glass-card" style="text-align: center;">
                    <p>Ulubiony dzie≈Ñ:</p>
                    <h2 id="favDay" style="color: var(--accent-3);">-</h2>
                </div>
            </section>

            <section class="slide">
                <h1>Nocne<br>Polaki üåö</h1>
                <div class="glass-card" style="text-align: center;">
                    <div class="huge-stat" id="nightPct">0%</div>
                    <p>Wiadomo≈õci w nocy (00-05)</p>
                    <hr style="margin: 20px 0; border:0; border-top:1px solid rgba(255,255,255,0.1);">
                    <div id="nightKingName" style="color: var(--accent-2); font-weight:700; font-size:1.2rem;">-</div>
                    <div id="nightKingCount">-</div>
                </div>
            </section>

            <section class="slide">
                <h1>Last Seen<br>Champion</h1>
                <div class="glass-card" style="text-align: center; padding: 40px 20px;">
                    <div style="font-size: 4rem; margin-bottom: 10px;">üò¥</div>
                    <h2 id="lastSeenName">User</h2>
                    <p>Najczƒô≈õciej ko≈Ñczy dzie≈Ñ</p>
                    <div style="margin-top: 30px; height: 12px; background: rgba(255,255,255,0.1); border-radius: 4px; display:flex; overflow:hidden;">
                        <div id="lsBar1" style="width: 50%; background: var(--accent-1);"></div>
                        <div id="lsBar2" style="width: 50%; background: var(--accent-2);"></div>
                    </div>
                    <div style="display:flex; justify-content:space-between; margin-top:5px; opacity:0.6;">
                        <span id="lsLabel1">A</span><span id="lsLabel2">B</span>
                    </div>
                </div>
            </section>

            <section class="slide">
                <h1>Szybcy i<br>W≈õciekli</h1>
                <div class="glass-card">
                    <p><strong id="fastReplyWinner" style="color:#fff;">-</strong> odpisuje szybciej!</p>
                    <div style="height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; margin-top: 10px; overflow:hidden;">
                        <div id="fastReplyBar" style="width: 0%; height:100%; background: var(--accent-1);"></div>
                    </div>
                    <div style="font-size:0.8rem; margin-top:5px;"><span id="fastReplyPct">0</span>% b≈Çyskawicznych odpowiedzi</div>
                    <hr style="margin: 20px 0; border:0; border-top:1px dashed rgba(255,255,255,0.15);">
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; text-align:center;">
                        <div><div>Tw√≥j czas</div><div id="avgTime1" style="font-weight:700;">-</div></div>
                        <div><div>Jej czas</div><div id="avgTime2" style="font-weight:700;">-</div></div>
                    </div>
                </div>
            </section>
            
            <section class="slide">
                <h1>Styl<br>Rozmowy</h1>
                <div class="glass-card">
                    <p><strong id="yapMaster" style="color:#fff;">-</strong> pisze esejami.</p>
                    <div style="display:flex; justify-content:space-between; margin-top:15px; text-align:center;">
                        <div><div id="alName1">A</div><div id="avgLenVal1" style="font-weight:700; font-size:1.5rem;">0</div></div>
                        <div><div id="alName2">B</div><div id="avgLenVal2" style="font-weight:700; font-size:1.5rem;">0</div></div>
                    </div>
                    <hr style="margin: 20px 0; border:0; border-top:1px dashed rgba(255,255,255,0.15);">
                    <div>
                        <p>Kto zaczyna?</p>
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <div id="starterKing" style="font-weight:700; font-size:1.3rem;">-</div>
                            <div style="text-align:right;"><span id="starterVal1">0</span> vs <span id="starterVal2">0</span></div>
                        </div>
                    </div>
                </div>
            </section>
            
            <section class="slide">
                <h1>Ulubione<br>Zwroty</h1>
                <div class="glass-card">
                    <div style="display: flex; flex-direction: column; gap: 15px;">
                        <div style="display: flex; justify-content: space-between;">
                            <div>1. "<span id="vocabPhrase1">...</span>"</div>
                            <div id="vocabCount1" style="color: var(--accent-1); font-weight:bold;">0</div>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <div>2. "<span id="vocabPhrase2">...</span>"</div>
                            <div id="vocabCount2" style="color: var(--accent-2); font-weight:bold;">0</div>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <div>3. "<span id="vocabPhrase3">...</span>"</div>
                            <div id="vocabCount3" style="color: var(--accent-3); font-weight:bold;">0</div>
                        </div>
                    </div>
                </div>
            </section>

            <section class="slide">
                <h1>Top Emoji</h1>
                <div class="podium-container">
                    <div class="podium-column"><div class="podium-emoji pe-2" id="emo2">ü•à</div><div class="podium-bar bar-2">2</div></div>
                    <div class="podium-column"><div class="podium-emoji pe-1" id="emo1">ü•á</div><div class="podium-bar bar-1">1</div></div>
                    <div class="podium-column"><div class="podium-emoji pe-3" id="emo3">ü•â</div><div class="podium-bar bar-3">3</div></div>
                </div>
                <div class="glass-card" style="text-align: center;">
                    <p>Najczƒô≈õciej u≈ºywana:</p>
                    <h2 id="favEmojiName" style="color: var(--accent-2);">-</h2>
                </div>
            </section>

            <section class="slide">
                <h1>Multimedia</h1>
                <div class="glass-card">
                    <div class="media-grid">
                        <div class="media-item"><span style="font-size:1.5rem;">üì∏</span><div id="mediaPhoto" style="font-weight:700;">0</div></div>
                        <div class="media-item"><span style="font-size:1.5rem;">üé§</span><div id="mediaVoice" style="font-weight:700;">0</div></div>
                        <div class="media-item"><span style="font-size:1.5rem;">üîó</span><div id="mediaLink" style="font-weight:700;">0</div></div>
                    </div>
                    <p style="text-align:center; margin-top:15px;"><strong id="mediaKing">-</strong> wys≈Ça≈Ç(a) wiƒôcej spamu.</p>
                </div>
            </section>

            <section class="slide">
                <h1>Vibe Check ‚ú®</h1>
                <div class="chart-wrapper" style="height: 300px;"><canvas id="chartRadar"></canvas></div>
                <div style="display: flex; justify-content: center; gap: 20px; font-size: 0.8rem; margin-top: 10px;">
                    <div style="color: var(--accent-1);">‚óè <span id="vibeUser1">A</span></div>
                    <div style="color: var(--accent-2);">‚óè <span id="vibeUser2">B</span></div>
                </div>
                <div class="glass-card" style="padding: 15px; margin-top: 20px; text-align: center;">
                    <p>Relacja to g≈Ç√≥wnie <strong id="vibeMain" style="color: var(--accent-3);">-</strong>.</p>
                </div>
            </section>

            <section class="slide">
                <div style="text-align: center;">
                    <h1 style="font-size: 4rem;">2025</h1>
                    <p style="color: var(--text-muted); font-size: 1.1rem;">Dziƒôki za ka≈ºdƒÖ wiadomo≈õƒá.</p>
                </div>
                <div style="text-align: center; margin-top: 30px; width: 100%;">
                    <button class="btn-main" onclick="location.reload()" style="opacity:1; pointer-events:auto; border-radius:100px;">Jeszcze raz ‚Ü∫</button>
                </div>
            </section>
        </div>
    </div>

    <!-- JS Helper Functions -->
    <script>
        // -- UI STATE MANAGEMENT --
        function switchView(viewId) {
            document.querySelectorAll('.content-wrapper, #view-wrapped, #view-upload').forEach(el => el.classList.add('hidden'));
            const target = document.getElementById(viewId);
            if(target) {
                target.classList.remove('hidden');
                target.style.display = (viewId === 'view-select') ? 'flex' : (viewId === 'view-wrapped' ? 'block' : 'flex');
            }
            
            const frame = document.getElementById('appFrame');
            if(viewId === 'view-wrapped') {
                frame.classList.add('wrapped-mode');
                // Trigger animations
                setTimeout(() => showSlide(0), 100);
            } else {
                frame.classList.remove('wrapped-mode');
            }
        }

        // -- SLIDES LOGIC --
        const slides = document.querySelectorAll('.slide');
        const navHeader = document.getElementById('navHeader');
        let currentIdx = 0;

        // Init dots
        slides.forEach((_, i) => {
            const bar = document.createElement('div');
            bar.className = 'progress-bar';
            bar.innerHTML = '<div class="progress-fill"></div>';
            navHeader.appendChild(bar);
        });
        const bars = document.querySelectorAll('.progress-bar');

        function showSlide(index) {
            if (index < 0) index = 0;
            if (index >= slides.length) index = slides.length - 1;
            currentIdx = index;
            
            const bgLayer = document.getElementById('bgFloating');
            if(bgLayer) {
                if(index === 0) bgLayer.classList.remove('hidden');
                else bgLayer.classList.add('hidden');
            }

            slides.forEach((s, i) => s.classList.toggle('active', i === index));
            bars.forEach((b, i) => {
                b.classList.remove('active', 'filled');
                if (i < index) b.classList.add('filled');
                if (i === index) b.classList.add('active');
            });
        }

        document.getElementById('btnNext').addEventListener('click', () => showSlide(currentIdx + 1));
        document.getElementById('btnPrev').addEventListener('click', () => showSlide(currentIdx - 1));
        document.addEventListener('keydown', e => {
            if(e.key === "ArrowRight") showSlide(currentIdx + 1);
            if(e.key === "ArrowLeft") showSlide(currentIdx - 1);
        });

        // -- CHART HELPERS (From original design_new.html logic) --
        function setupCanvas(canvas) {
            const parent = canvas.parentElement;
            const rect = parent ? parent.getBoundingClientRect() : canvas.getBoundingClientRect();
            const scale = window.devicePixelRatio || 1;
            canvas.width = rect.width * scale;
            canvas.height = rect.height * scale;
            canvas.style.width = rect.width + "px";
            canvas.style.height = rect.height + "px";
            const ctx = canvas.getContext('2d');
            ctx.setTransform(scale, 0, 0, scale, 0, 0);
            return ctx;
        }

        function drawHorizontalBars(canvas, labels, values, colors) {
            const ctx = setupCanvas(canvas);
            const w = canvas.getBoundingClientRect().width;
            const h = canvas.getBoundingClientRect().height;
            const paddingX = 20; const topPadding = 12; const bottomPadding = 28;
            const maxVal = Math.max(...values, 1);
            const barHeight = (h - topPadding - bottomPadding) / values.length;
            ctx.clearRect(0, 0, w, h);
            ctx.font = "16px 'Plus Jakarta Sans', sans-serif"; ctx.textAlign = "left"; ctx.textBaseline = "middle";
            values.forEach((val, i) => {
                const y = topPadding + i * barHeight + barHeight * 0.2;
                const height = barHeight * 0.6;
                const width = ((w - paddingX * 2) * val) / maxVal;
                ctx.fillStyle = colors[i % colors.length];
                ctx.beginPath();
                ctx.roundRect(paddingX, y, width, height, height/2);
                ctx.fill();
                ctx.fillStyle = "#fff";
                ctx.fillText(labels[i], paddingX, y + height + 14);
            });
        }

        function drawBarChart(canvas, values) {
             const ctx = setupCanvas(canvas);
             const w = canvas.getBoundingClientRect().width;
             const h = canvas.getBoundingClientRect().height;
             const padding = 14;
             const maxVal = Math.max(...values, 1);
             const barWidth = (w - padding * 2) / values.length;
             ctx.clearRect(0, 0, w, h);
             values.forEach((val, i) => {
                 const height = ((h - padding * 2) * val) / maxVal;
                 const x = padding + i * barWidth + barWidth * 0.1;
                 const y = h - padding - height;
                 const width = barWidth * 0.8;
                 ctx.fillStyle = "#fff";
                 ctx.beginPath(); ctx.roundRect(x, y, width, height, 3); ctx.fill();
             });
        }
        
        function drawVerticalBarChart(canvas, labels, values) {
            const ctx = setupCanvas(canvas);
            const w = canvas.getBoundingClientRect().width; const h = canvas.getBoundingClientRect().height;
            const paddingX = 14; const paddingY = 20;
            const maxVal = Math.max(...values, 1);
            const barWidth = (w - paddingX * 2) / values.length;
            ctx.clearRect(0, 0, w, h);
            ctx.font = "12px 'Plus Jakarta Sans', sans-serif"; ctx.textAlign = "center"; ctx.textBaseline = "top";
            values.forEach((val, i) => {
                const barH = h - paddingY * 2;
                const height = (barH * val) / maxVal;
                const x = paddingX + i * barWidth + barWidth * 0.1;
                const y = barH + paddingY - height - 5;
                const width = barWidth * 0.8;
                ctx.fillStyle = "#fff";
                ctx.beginPath(); ctx.roundRect(x, y, width, height, 3); ctx.fill();
                ctx.fillStyle = "rgba(255,255,255,0.7)";
                ctx.fillText(labels[i], x + width / 2, h - paddingY + 5);
            });
        }

        function drawRadarChart(canvas, labels, datasets) {
            const ctx = setupCanvas(canvas);
            const w = canvas.getBoundingClientRect().width; const h = canvas.getBoundingClientRect().height;
            const cx = w / 2; const cy = h / 2;
            const radius = Math.min(w, h) * 0.28;
            ctx.clearRect(0, 0, w, h);
            ctx.strokeStyle = "rgba(255,255,255,0.1)"; ctx.fillStyle = "#fff"; ctx.font = "11px 'Plus Jakarta Sans', sans-serif";
            for (let i = 1; i <= 4; i++) {
                ctx.beginPath();
                const r = (radius / 4) * i;
                for (let a = 0; a < labels.length; a++) {
                    const angle = (Math.PI * 2 * a) / labels.length - Math.PI / 2;
                    const x = cx + r * Math.cos(angle); const y = cy + r * Math.sin(angle);
                    if (a === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
                }
                ctx.closePath(); ctx.stroke();
            }
            labels.forEach((label, i) => {
                const angle = (Math.PI * 2 * i) / labels.length - Math.PI / 2;
                const x = cx + (radius + 16) * Math.cos(angle); const y = cy + (radius + 16) * Math.sin(angle);
                ctx.fillStyle = "#fff"; ctx.textAlign = "center"; ctx.fillText(label, x, y);
            });
            datasets.forEach((dataset) => {
                ctx.beginPath();
                dataset.values.forEach((val, i) => {
                    const angle = (Math.PI * 2 * i) / labels.length - Math.PI / 2;
                    const r = (val / 100) * radius;
                    const x = cx + r * Math.cos(angle); const y = cy + r * Math.sin(angle);
                    if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
                });
                ctx.closePath();
                ctx.strokeStyle = dataset.color; ctx.lineWidth = 2; ctx.stroke();
                ctx.fillStyle = dataset.color.replace(")", ", 0.2)").replace("rgb", "rgba").replace("#", "rgba("); 
                // fix hex to rgba if needed, but Chart.js usually handles colors. Custom implementation here needs hex conversion or just opacity
                ctx.globalAlpha = 0.2; ctx.fill(); ctx.globalAlpha = 1;
            });
        }

        window.renderStats = function(stats) {
            document.getElementById('introTotal').innerText = stats.total.toLocaleString('pl-PL').replace(/,/g, ' ');
            drawHorizontalBars(document.getElementById('chartVersus'), stats.users, stats.msgs, ['#2E3DE3', '#FF0080']);
            const winnerIndex = stats.msgs[1] > stats.msgs[0] ? 1 : 0;
            document.getElementById('winnerName').innerText = stats.users[winnerIndex] || "n/a";
            document.getElementById('winnerPct').innerText = Math.round((stats.msgs[winnerIndex] / stats.total) * 100) + "%";

            drawBarChart(document.getElementById('chartTime'), stats.hours);
            document.getElementById('peakHour').innerText = stats.peakHour;

            if(document.getElementById('chartWeekdays')) {
                drawVerticalBarChart(document.getElementById('chartWeekdays'), ['Pn', 'Wt', '≈ör', 'Cz', 'Pt', 'So', 'Nd'], stats.weekdays);
                document.getElementById('favDay').innerText = stats.favDay;
            }

            document.getElementById('nightPct').innerText = stats.nightPct;
            document.getElementById('nightKingName').innerText = stats.nightWinner.name;
            document.getElementById('nightKingCount').innerText = stats.nightWinner.count + " msg";

            document.getElementById('lastSeenName').innerText = stats.lastSeen.name;
            document.getElementById('lsBar1').style.width = stats.lastSeen.pct1 + "%";
            document.getElementById('lsBar2').style.width = stats.lastSeen.pct2 + "%";
            document.getElementById('lsLabel1').innerText = stats.users[0] || "A";
            document.getElementById('lsLabel2').innerText = stats.users[1] || "B";

            document.getElementById('fastReplyWinner').innerText = stats.fastReplyWinner;
            document.getElementById('fastReplyPct').innerText = stats.fastReplyPct.toFixed(0);
            document.getElementById('fastReplyBar').style.width = Math.min(stats.fastReplyPct, 100) + "%";
            document.getElementById('avgTime1').innerText = stats.avgTime[0];
            document.getElementById('avgTime2').innerText = stats.avgTime[1];

            if(document.getElementById('yapMaster')) {
                document.getElementById('yapMaster').innerText = stats.yapMaster;
                document.getElementById('alName1').innerText = stats.users[0] || "A";
                document.getElementById('alName2').innerText = stats.users[1] || "B";
                document.getElementById('avgLenVal1').innerText = stats.avgLen[0];
                document.getElementById('avgLenVal2').innerText = stats.avgLen[1];
                document.getElementById('starterKing').innerText = stats.starterKing;
                document.getElementById('starterVal1').innerText = stats.starters[0];
                document.getElementById('starterVal2').innerText = stats.starters[1];
            }

            if(document.getElementById('vocabPhrase1')) {
                document.getElementById('vocabPhrase1').innerText = stats.topPhrases[0].text;
                document.getElementById('vocabCount1').innerText = stats.topPhrases[0].count;
                document.getElementById('vocabPhrase2').innerText = stats.topPhrases[1].text;
                document.getElementById('vocabCount2').innerText = stats.topPhrases[1].count;
                document.getElementById('vocabPhrase3').innerText = stats.topPhrases[2].text;
                document.getElementById('vocabCount3').innerText = stats.topPhrases[2].count;
            }

            document.getElementById('emo1').innerText = stats.emojis[0];
            document.getElementById('emo2').innerText = stats.emojis[1];
            document.getElementById('emo3').innerText = stats.emojis[2];
            document.getElementById('favEmojiName').innerText = stats.favEmojiName;

            document.getElementById('mediaPhoto').innerText = stats.media.photo;
            document.getElementById('mediaVoice').innerText = stats.media.voice;
            document.getElementById('mediaLink').innerText = stats.media.link;
            document.getElementById('mediaKing').innerText = stats.mediaKing;

            drawRadarChart(document.getElementById('chartRadar'), stats.vibeLabels, [
                { label: stats.users[0], values: stats.vibeData1, color: '#2E3DE3' },
                { label: stats.users[1], values: stats.vibeData2, color: '#FF0080' }
            ]);
            document.getElementById('vibeMain').innerText = stats.vibeMain;
            const vibeUser1 = document.getElementById('vibeUser1');
            if (vibeUser1) vibeUser1.innerText = stats.users[0] || "A";
            const vibeUser2 = document.getElementById('vibeUser2');
            if (vibeUser2) vibeUser2.innerText = stats.users[1] || "B";
            
            // Generate Floating Background
            const bgContainer = document.getElementById('bgFloating');
            bgContainer.innerHTML = ''; // Clear previous
            const emojiList = stats.emojis.length > 0 ? stats.emojis.map(e => e) : ['üíô', 'üëã', 'üòÇ', 'üî•'];
            const elements = [...emojiList, ...emojiList, 'bubble', 'bubble', 'typing'];
            for(let i=0; i<18; i++) {
                const elType = elements[Math.floor(Math.random() * elements.length)];
                const div = document.createElement('div');
                div.className = 'bg-el';
                div.style.left = Math.floor(Math.random() * 90) + 5 + '%';
                const duration = 15 + Math.random() * 15;
                div.style.animationDuration = duration + 's';
                div.style.animationDelay = -Math.random() * 20 + 's';
                
                if (elType === 'bubble' || elType === 'typing') {
                    div.className += ' bg-bubble'; // need css for bubbles
                    div.style.background = 'rgba(255,255,255,0.1)'; div.style.borderRadius = '10px';
                    if(Math.random() > 0.5) div.style.borderRadius = '10px 10px 0 10px'; else div.style.borderRadius = '10px 10px 10px 0';
                    div.style.width = (30 + Math.random() * 30) + 'px'; div.style.height = '18px';
                    if (elType === 'typing') div.innerHTML = '<span style="display:flex; gap:2px; justify-content:center; align-items:center; height:100%;"><span style="width:3px; height:3px; background:#fff; border-radius:50%;"></span><span style="width:3px; height:3px; background:#fff; border-radius:50%;"></span><span style="width:3px; height:3px; background:#fff; border-radius:50%;"></span></span>';
                } else {
                    div.innerText = elType;
                    div.style.fontSize = (1.5 + Math.random()) + 'rem';
                }
                bgContainer.appendChild(div);
            }
        }
    </script>
</body>
</html>
