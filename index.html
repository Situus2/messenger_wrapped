<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Messenger Wrapped 2025</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;500;700;800&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://pyscript.net/releases/2024.1.1/core.css" />
    <script type="module" src="https://pyscript.net/releases/2024.1.1/core.js"></script>
    <script type="py" src="engine_v4.py" config="pyscript.toml"></script>

    <style>
        :root {
            --bg-deep: #000000;
            --text-white: #ffffff;
            --text-muted: rgba(255, 255, 255, 0.6);
            --accent-1: #2E3DE3;
            --accent-2: #FF0080;
            --accent-3: #7928CA;
            --accent-gradient: linear-gradient(135deg, #FF0080 0%, #7928CA 100%);
            --glass-bg: rgba(20, 20, 20, 0.65);
            --glass-border: rgba(255, 255, 255, 0.1);
            --glass-highlight: rgba(255, 255, 255, 0.05);
            --glass-input: rgba(255, 255, 255, 0.03);
            --item-hover: rgba(255, 255, 255, 0.12);
            --item-selected: rgba(46, 61, 227, 0.3);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--bg-deep);
            color: var(--text-white);
            height: 100dvh;
            width: 100vw;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .aurora-container { position: absolute; inset: 0; z-index: 0; overflow: hidden; background: #000; }
        .aurora-blob { position: absolute; border-radius: 50%; filter: blur(90px); opacity: 0.5; animation: drift 20s infinite alternate; }
        .blob-1 { width: 90vw; height: 90vw; background: var(--accent-1); top: -30%; left: -20%; }
        .blob-2 { width: 80vw; height: 80vw; background: var(--accent-2); bottom: -20%; right: -20%; }
        .blob-3 { width: 60vw; height: 60vw; background: var(--accent-3); top: 30%; left: 30%; opacity: 0.3; }
        @keyframes drift { from { transform: translate(0,0); } to { transform: translate(30px, -50px); } }
        .noise { position: absolute; inset: 0; z-index: 1; opacity: 0.08; pointer-events: none; background: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E"); }

        .app-frame {
            position: relative; width: 100%; height: 100%; z-index: 10;
            display: flex; flex-direction: column; padding: 16px;
            overflow-y: auto; -webkit-overflow-scrolling: touch;
        }
        @media (min-width: 500px) {
            .app-frame { max-width: 800px; max-height: 880px; height: 82vh; border-radius: 40px; border: 8px solid #1a1a1a; box-shadow: 0 40px 100px rgba(0,0,0,0.8); background: #000; overflow: hidden; padding: 24px; }
            .app-frame.wrapped-mode { max-width: 480px; max-height: 860px; height: 85vh; }
            .aurora-container { border-radius: 32px; }
            .app-frame .aurora-container { position: absolute; inset: 0; }
        }

        .content-wrapper { position: relative; z-index: 2; width: 100%; display: flex; flex-direction: column; gap: 15px; margin: auto 0; animation: fadeIn 0.8s forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .brand-gradient { background: var(--accent-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        .upload-card { background: var(--glass-bg); backdrop-filter: blur(30px); border: 1px solid var(--glass-border); border-radius: 32px; padding: 20px; text-align: center; }
        
        /* NOWY STYL DROP ZONE: To teraz fizyczny label dla ukrytego inputa */
        .drop-zone {
            display: block; border: 2px dashed rgba(255,255,255,0.2); border-radius: 20px; padding: 25px 20px;
            margin: 15px 0; background: var(--glass-input); cursor: pointer; transition: 0.3s;
            position: relative;
        }
        .drop-zone:hover { border-color: var(--accent-2); background: rgba(255,255,255,0.05); }
        .drop-zone input[type="file"] { position: absolute; inset: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; }

        .btn-main {
            width: 100%; padding: 18px; background: #fff; color: #000; border: none; border-radius: 16px; font-weight: 800;
            cursor: pointer; opacity: 0.5; pointer-events: none; transition: 0.2s;
        }
        .btn-main.ready { opacity: 1; pointer-events: auto; background: var(--accent-gradient); color: #fff; }

        .chat-list-container { flex: 1; overflow-y: auto; margin-bottom: 20px; z-index: 20; }
        .chat-item { display: flex; align-items: center; gap: 15px; padding: 12px 16px; margin-bottom: 8px; background: var(--glass-input); border-radius: 18px; cursor: pointer; transition: 0.2s; border: 1px solid transparent; }
        .chat-item:active { transform: scale(0.98); background: var(--item-selected); }
        .avatar { width: 48px; height: 48px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; flex-shrink: 0; }
        .search-input { width: 100%; padding: 14px 14px 14px 20px; background: var(--glass-input); border: 1px solid var(--glass-border); border-radius: 16px; color: #fff; margin-bottom: 20px; outline: none; }

        .slide { position: absolute; inset: 0; padding: 70px 16px 30px; display: flex; flex-direction: column; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.6s; }
        .slide.active { opacity: 1; pointer-events: auto; }
        .nav-header { position: absolute; top: 0; left: 0; width: 100%; padding: 20px 12px; z-index: 20; display: flex; gap: 4px; }
        .progress-bar { flex: 1; height: 3px; background: rgba(255,255,255,0.2); border-radius: 4px; overflow: hidden; }
        .progress-fill { height: 100%; width: 0%; background: #fff; transition: width 0.1s linear; }
        .progress-bar.filled .progress-fill { width: 100%; }
        .progress-bar.active .progress-fill { width: 100%; }
        .glass-card { background: var(--glass-bg); backdrop-filter: blur(25px); border: 1px solid var(--glass-border); border-radius: 28px; padding: 24px; margin-top: 15px; }
        
        .floating-layer { position: absolute; inset: 0; overflow: hidden; pointer-events: none; z-index: 1; }
        .bg-el { position: absolute; animation: floatBG linear infinite; }
        @keyframes floatBG { 0% { transform: translateY(100vh); opacity: 0; } 10% { opacity: 0.5; } 100% { transform: translateY(-100px); opacity: 0; } }
        
        .hidden { display: none !important; }
        .loader-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.9); backdrop-filter: blur(10px); z-index: 200; display: none; flex-direction: column; align-items: center; justify-content: center; }
        .spinner { width: 50px; height: 50px; border: 4px solid rgba(255,255,255,0.1); border-top: 4px solid #FF0080; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .huge-stat { font-size: 4rem; font-weight: 800; background: linear-gradient(to right, #fff, #b4b4b4); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .chart-wrapper { height: 220px; width: 100%; position: relative; margin: 20px 0; }
        .podium-container { display: flex; justify-content: center; align-items: flex-end; gap: 10px; height: 250px; margin: 20px 0 40px; }
        .podium-column { display: flex; flex-direction: column; align-items: center; justify-content: flex-end; width: 80px; }
        .podium-bar { width: 100%; border-radius: 12px 12px 0 0; background: rgba(255,255,255,0.1); display: flex; align-items: flex-end; justify-content: center; padding-bottom: 10px; transform: scaleY(0); transition: 1s; }
        .slide.active .podium-bar { transform: scaleY(1); }
        .podium-emoji { font-size: 3.5rem; margin-bottom: 10px; opacity: 0; transform: translateY(20px); transition: 0.6s; }
        .slide.active .podium-emoji { opacity: 1; transform: translateY(0); }
        .bar-2 { height: 120px; background: rgba(46,61,227,0.3); border-color: var(--accent-1); }
        .bar-1 { height: 160px; background: rgba(255,0,128,0.3); border-color: var(--accent-2); }
        .bar-3 { height: 90px; background: rgba(255,255,255,0.1); }
        .media-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 10px; }
        .media-item { background: rgba(255,255,255,0.05); border-radius: 16px; padding: 15px 10px; text-align: center; }

        .tap-zone { position: absolute; top: 0; bottom: 0; width: 40%; z-index: 50; cursor: pointer; }
        .tap-left { left: 0; } .tap-right { right: 0; }

        #pyscript-loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 1000; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.5s; }
    </style>
</head>
<body>

    <div id="pyscript-loader">
        <div class="spinner"></div>
        <p style="color: #fff; font-weight: 700; margin-top: 10px;">Inicjowanie silnika analizy...</p>
    </div>

    <div class="app-frame" id="appFrame">
        <div class="aurora-container">
            <div class="aurora-blob blob-1"></div>
            <div class="aurora-blob blob-2"></div>
            <div class="aurora-blob blob-3"></div>
            <div class="noise"></div>
        </div>
        
        <div class="loader-overlay" id="loader">
            <div class="spinner"></div>
            <h3 id="loaderText" style="font-weight: 700; text-align: center; padding: 0 20px;">Przetwarzanie...</h3>
        </div>

        <!-- VIEW 1: UPLOAD -->
        <div id="view-upload" class="content-wrapper">
            <div style="text-align: center; margin-bottom: 10px;">
                <div style="font-size: 4rem; margin-bottom: 10px;">üëã</div>
                <h1>Stw√≥rz swoje<br><span class="brand-gradient">WRAPPED</span></h1>
            </div>

            <div class="upload-card">
                <label class="drop-zone" id="dropZone">
                    <!-- Input jest teraz przezroczystƒÖ warstwƒÖ na wierzchu ca≈Çego pola -->
                    <input type="file" id="fileInput" accept=".zip">
                    <span style="font-size: 3rem; display: block; margin-bottom: 10px;">üìÇ</span>
                    <h3 id="dropText" style="font-weight: 700;">Wybierz plik ZIP</h3>
                    <p style="font-size: 0.8rem; color: var(--text-muted);">z danymi Messengera</p>
                </label>
                <!-- Przycisk jest teraz tylko wizualny, bo label/input obs≈Çuguje klikniƒôcie -->
                <button class="btn-main" id="generateBtn">Analizuj Plik ‚ú®</button>
            </div>
            
            <p style="text-align: center; font-size: 0.8rem; color: var(--text-muted); margin-top: 20px;">
                Dzia≈Ça w 100% w przeglƒÖdarce.<br>Dane nie sƒÖ nigdzie wysy≈Çane.
            </p>
        </div>

        <!-- VIEW 2: LIST -->
        <div id="view-select" class="content-wrapper hidden" style="height: 100%; justify-content: flex-start;">
            <div style="text-align: center; margin-bottom: 10px;">
                <h2>Wybierz rozmowƒô</h2>
                <p style="color: var(--text-muted); font-size: 0.9rem;">Znaleziono: <span id="chatCount">0</span></p>
            </div>
            <input type="text" class="search-input" id="searchInput" placeholder="Szukaj imienia...">
            <div class="chat-list-container" id="chatList"></div>
        </div>

        <!-- VIEW 3: WRAPPED -->
        <div id="view-wrapped" class="hidden" style="width: 100%; height: 100%;">
            <div class="floating-layer" id="bgFloating"></div>
            <div class="nav-header" id="navHeader"></div>
            <div class="tap-zone tap-left" id="btnPrev"></div>
            <div class="tap-zone tap-right" id="btnNext"></div>

            <section class="slide active">
                <div><h2 style="color: var(--text-muted); font-size: 1.2rem;">Cze≈õƒá!</h2><h1>MESSENGER<br><span class="brand-gradient">WRAPPED</span><br>2025</h1></div>
                <div class="glass-card"><p style="font-size: 1.1rem; color: #fff; opacity: 0.9;">Ten rok by≈Ç pe≈Çen powiadomie≈Ñ.</p><div class="huge-stat" id="introTotal">0</div><span style="font-size: 0.75rem; font-weight: 700; letter-spacing: 1.5px; text-transform: uppercase; color: var(--text-muted);">Wiadomo≈õci ≈ÇƒÖcznie</span></div>
            </section>
            
            <!-- Slides injected statically... (zachowujƒô komplet slajd√≥w) -->
            <section class="slide"><h1>Bitwa na<br>s≈Çowa</h1><div class="chart-wrapper"><canvas id="chartVersus"></canvas></div><div class="glass-card" style="text-align:center;"><p>Zwyciƒôzca</p><h3 id="winnerName" class="brand-gradient" style="font-size:2.5rem;">-</h3><p>Napisa≈Ç(a) <strong id="winnerPct">0%</strong> wiadomo≈õci.</p></div></section>
            <section class="slide"><h1>Zegar<br>Biologiczny</h1><div class="chart-wrapper"><canvas id="chartTime"></canvas></div><div class="glass-card" style="display:flex;align-items:center;gap:15px;"><div>‚è∞</div><div><div style="font-size:0.75rem;">Ulubiona pora</div><div id="peakHour" style="font-size:1.5rem;font-weight:700;">-</div></div></div></section>
            <section class="slide"><h1>Rutyna<br>Tygodnia</h1><div class="chart-wrapper"><canvas id="chartWeekdays"></canvas></div><div class="glass-card" style="text-align:center;"><p>Ulubiony dzie≈Ñ:</p><h2 id="favDay" style="color:var(--accent-3);">-</h2></div></section>
            <section class="slide"><h1>Nocne<br>Polaki üåö</h1><div class="glass-card" style="text-align:center;"><div class="huge-stat" id="nightPct">0%</div><p>Wiadomo≈õci w nocy (00-05)</p><hr style="margin:20px 0;border:0;border-top:1px solid rgba(255,255,255,0.1);"><div id="nightKingName" style="color:var(--accent-2);font-weight:700;">-</div><div id="nightKingCount">-</div></div></section>
            <section class="slide"><h1>Last Seen<br>Champion</h1><div class="glass-card" style="text-align:center;"><div style="font-size:4rem;">üò¥</div><h2 id="lastSeenName">-</h2><p>Ko≈Ñczy dzie≈Ñ</p><div style="margin-top:30px;height:12px;background:rgba(255,255,255,0.1);border-radius:4px;display:flex;overflow:hidden;"><div id="lsBar1" style="width:50%;background:var(--accent-1);"></div><div id="lsBar2" style="width:50%;background:var(--accent-2);"></div></div><div style="display:flex;justify-content:space-between;margin-top:5px;opacity:0.6;"><span id="lsLabel1">A</span><span id="lsLabel2">B</span></div></div></section>
            <section class="slide"><h1>Szybcy i<br>W≈õciekli</h1><div class="glass-card"><p><strong id="fastReplyWinner">-</strong> odpisuje szybciej!</p><div style="height:8px;background:rgba(255,255,255,0.1);border-radius:4px;margin-top:10px;overflow:hidden;"><div id="fastReplyBar" style="width:0%;height:100%;background:var(--accent-1);"></div></div><div style="font-size:0.8rem;margin-top:5px;"><span id="fastReplyPct">0</span>% b≈Çyskawicznych reakcji</div><hr style="margin: 20px 0; border:0; border-top:1px dashed rgba(255,255,255,0.15);"><div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;text-align:center;"><div><div>Tw√≥j czas</div><div id="avgTime1" style="font-weight:700;">-</div></div><div><div>Jej czas</div><div id="avgTime2" style="font-weight:700;">-</div></div></div></div></section>
            <section class="slide"><h1>Styl<br>Rozmowy</h1><div class="glass-card"><p><strong id="yapMaster">-</strong> pisze esejami.</p><div style="display:flex;justify-content:space-between;margin-top:15px;text-align:center;"><div><div id="alName1">A</div><div id="avgLenVal1" style="font-weight:700;font-size:1.5rem;">0</div></div><div><div id="alName2">B</div><div id="avgLenVal2" style="font-weight:700;font-size:1.5rem;">0</div></div></div><hr style="margin: 20px 0; border:0; border-top:1px dashed rgba(255,255,255,0.15);"><div><p>Kto zaczyna?</p><div style="display:flex;justify-content:space-between;align-items:center;"><div id="starterKing" style="font-weight:700;font-size:1.3rem;">-</div><div><span id="starterVal1">0</span> vs <span id="starterVal2">0</span></div></div></div></div></section>
            <section class="slide"><h1>Ulubione<br>Zwroty</h1><div class="glass-card"><div style="display:flex;flex-direction:column;gap:15px;"><div>1. "<span id="vocabPhrase1">...</span>" <span id="vocabCount1" style="color:var(--accent-1);font-weight:bold;float:right;">0</span></div><div>2. "<span id="vocabPhrase2">...</span>" <span id="vocabCount2" style="color:var(--accent-2);font-weight:bold;float:right;">0</span></div><div>3. "<span id="vocabPhrase3">...</span>" <span id="vocabCount3" style="color:var(--accent-3);font-weight:bold;float:right;">0</span></div></div></div></section>
            <section class="slide"><h1>Top Emoji</h1><div class="podium-container"><div class="podium-column"><div class="podium-emoji pe-2" id="emo2">ü•à</div><div class="podium-bar bar-2">2</div></div><div class="podium-column"><div class="podium-emoji pe-1" id="emo1">ü•á</div><div class="podium-bar bar-1">1</div></div><div class="podium-column"><div class="podium-emoji pe-3" id="emo3">ü•â</div><div class="podium-bar bar-3">3</div></div></div><div class="glass-card" style="text-align:center;"><p>Najczƒô≈õciej u≈ºywana:</p><h2 id="favEmojiName" style="color:var(--accent-2);">-</h2></div></section>
            <section class="slide"><h1>Multimedia</h1><div class="glass-card"><div class="media-grid"><div class="media-item">üì∏<div id="mediaPhoto" style="font-weight:700;">0</div></div><div class="media-item">üé§<div id="mediaVoice" style="font-weight:700;">0</div></div><div class="media-item">üîó<div id="mediaLink" style="font-weight:700;">0</div></div></div><p style="text-align:center;margin-top:15px;"><strong id="mediaKing">-</strong> wys≈Ça≈Ç(a) wiƒôcej spamu.</p></div></section>
            <section class="slide"><h1>Vibe Check ‚ú®</h1><div class="chart-wrapper"><canvas id="chartRadar"></canvas></div><div style="display:flex;justify-content:center;gap:20px;font-size:0.8rem;margin-top:10px;"><div style="color:var(--accent-1);">‚óè <span id="vibeUser1">A</span></div><div style="color:var(--accent-2);">‚óè <span id="vibeUser2">B</span></div></div><div class="glass-card" style="padding:15px;margin-top:20px;text-align:center;"><p>Wasza relacja to g≈Ç√≥wnie <strong id="vibeMain" style="color:var(--accent-3);">-</strong>.</p></div></section>
            <section class="slide"><div style="text-align:center;"><h1 style="font-size:4rem;">2025</h1><p style="color:var(--text-muted);font-size:1.1rem;">Dziƒôki za ka≈ºdƒÖ wiadomo≈õƒá.</p></div><div style="text-align:center;margin-top:30px;width:100%;"><button class="btn-main" onclick="location.reload()" style="opacity:1;pointer-events:auto;border-radius:100px;">Jeszcze raz ‚Ü∫</button></div></section>
        </div>
    </div>

    <script>
        const fileInput = document.getElementById('fileInput');
        const generateBtn = document.getElementById('generateBtn');

        // G≈Å√ìWNA LOGIKA ODCZYTU (JS)
        fileInput.onchange = async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            document.getElementById('dropText').innerText = file.name;
            document.getElementById('loader').style.display = 'flex';
            document.getElementById('loaderText').innerText = "Wczytywanie (Szybka Metoda)...";

            const reader = new FileReader();
            reader.onload = (event) => {
                const uint8Array = new Uint8Array(event.target.result);
                if (window.receiveZipBytes) {
                    window.receiveZipBytes(uint8Array, file.name);
                } else {
                    alert("Silnik Python nie jest jeszcze gotowy. Poczekaj chwilƒô.");
                    document.getElementById('loader').style.display = 'none';
                }
            };
            reader.onerror = () => {
                alert("B≈ÇƒÖd odczytu pliku przez przeglƒÖdarkƒô.");
                document.getElementById('loader').style.display = 'none';
            };
            reader.readAsArrayBuffer(file);
        };

        // UI HELPERS
        function switchView(viewId) {
            document.querySelectorAll('.content-wrapper, #view-wrapped').forEach(el => el.classList.add('hidden'));
            const target = document.getElementById(viewId);
            if(target) {
                target.classList.remove('hidden');
                target.style.display = (viewId === 'view-wrapped') ? 'block' : 'flex';
            }
            if(viewId === 'view-wrapped') {
                document.getElementById('appFrame').classList.add('wrapped-mode');
                setTimeout(() => showSlide(0), 100);
            }
        }

        window.addEventListener('py:ready', () => {
            document.getElementById('pyscript-loader').style.opacity = '0';
            setTimeout(() => document.getElementById('pyscript-loader').remove(), 500);
            generateBtn.classList.add('ready');
        });

        // WYKRESY I SLAJDY (skopiowane z dzia≈ÇajƒÖcej wersji)
        function setupCanvas(canvas) {
            const rect = canvas.parentElement.getBoundingClientRect();
            const scale = window.devicePixelRatio || 1;
            canvas.width = rect.width * scale; canvas.height = rect.height * scale;
            canvas.style.width = rect.width + "px"; canvas.style.height = rect.height + "px";
            const ctx = canvas.getContext('2d'); ctx.setTransform(scale, 0, 0, scale, 0, 0);
            return ctx;
        }

        function drawHorizontalBars(canvas, labels, values, colors) {
            const ctx = setupCanvas(canvas); const w = canvas.offsetWidth, h = canvas.offsetHeight;
            const maxVal = Math.max(...values, 1); const barH = (h - 40) / values.length;
            ctx.clearRect(0, 0, w, h); ctx.font = "bold 14px 'Plus Jakarta Sans'"; ctx.textAlign = "left";
            values.forEach((val, i) => {
                const y = 10 + i * (barH + 10), width = ((w - 40) * val) / maxVal;
                ctx.fillStyle = colors[i % colors.length]; ctx.beginPath(); ctx.roundRect(20, y, width, barH * 0.6, 8); ctx.fill();
                ctx.fillStyle = "#fff"; ctx.fillText(labels[i], 20, y + barH * 0.6 + 15);
            });
        }

        function drawBarChart(canvas, values) {
            const ctx = setupCanvas(canvas); const w = canvas.offsetWidth, h = canvas.offsetHeight;
            const maxVal = Math.max(...values, 1); const barW = (w - 20) / values.length;
            ctx.clearRect(0, 0, w, h);
            values.forEach((val, i) => {
                const height = (h * 0.8 * val) / maxVal;
                ctx.fillStyle = "rgba(255,255,255,0.8)"; ctx.beginPath(); ctx.roundRect(10 + i * barW, h - height, barW * 0.8, height, 4); ctx.fill();
            });
        }

        function drawVerticalBarChart(canvas, labels, values) {
            const ctx = setupCanvas(canvas); const w = canvas.offsetWidth, h = canvas.offsetHeight;
            const maxVal = Math.max(...values, 1); const barW = (w - 30) / values.length;
            ctx.clearRect(0, 0, w, h); ctx.font = "10px sans-serif"; ctx.textAlign = "center";
            values.forEach((val, i) => {
                const height = ((h - 30) * val) / maxVal;
                ctx.fillStyle = "#fff"; ctx.beginPath(); ctx.roundRect(15 + i * barW, h - 20 - height, barW * 0.7, height, 3); ctx.fill();
                ctx.fillStyle = "rgba(255,255,255,0.5)"; ctx.fillText(labels[i], 15 + i * barW + barW * 0.35, h - 5);
            });
        }

        function drawRadarChart(canvas, labels, datasets) {
            const ctx = setupCanvas(canvas); const w = canvas.offsetWidth, h = canvas.offsetHeight;
            const cx = w/2, cy = h/2, radius = Math.min(w, h) * 0.3;
            ctx.clearRect(0, 0, w, h); ctx.strokeStyle = "rgba(255,255,255,0.1)";
            for(let i=1; i<=4; i++) { ctx.beginPath(); for(let a=0; a<labels.length; a++) { const angle = (Math.PI*2*a)/labels.length - Math.PI/2; const x = cx + (radius/4*i)*Math.cos(angle), y = cy + (radius/4*i)*Math.sin(angle); if(a===0) ctx.moveTo(x, y); else ctx.lineTo(x, y); } ctx.closePath(); ctx.stroke(); }
            datasets.forEach(ds => {
                ctx.beginPath(); ds.values.forEach((v, i) => { const angle = (Math.PI*2*i)/labels.length - Math.PI/2; const r = (v/100) * radius; const x = cx + r*Math.cos(angle), y = cy + r*Math.sin(angle); if(i===0) ctx.moveTo(x, y); else ctx.lineTo(x, y); }); ctx.closePath();
                ctx.strokeStyle = ds.color; ctx.lineWidth = 2; ctx.stroke();
                const r = parseInt(ds.color.slice(1,3),16), g=parseInt(ds.color.slice(3,5),16), b=parseInt(ds.color.slice(5,7),16);
                ctx.fillStyle = `rgba(${r},${g},${b},0.2)`; ctx.fill();
            });
        }

        window.renderStats = (stats) => {
            document.getElementById('introTotal').innerText = stats.total.toLocaleString('pl-PL');
            drawHorizontalBars(document.getElementById('chartVersus'), stats.users, stats.msgs, ['#2E3DE3', '#FF0080']);
            const winIdx = stats.msgs[1] > stats.msgs[0] ? 1 : 0;
            document.getElementById('winnerName').innerText = stats.users[winIdx] || "User";
            document.getElementById('winnerPct').innerText = Math.round((stats.msgs[winIdx]/stats.total)*100) + "%";
            drawBarChart(document.getElementById('chartTime'), stats.hours);
            document.getElementById('peakHour').innerText = stats.peakHour;
            drawVerticalBarChart(document.getElementById('chartWeekdays'), ['Pn','Wt','Sr','Cz','Pt','So','Nd'], stats.weekdays);
            document.getElementById('favDay').innerText = stats.favDay;
            document.getElementById('nightPct').innerText = stats.nightPct;
            document.getElementById('nightKingName').innerText = stats.nightWinner.name;
            document.getElementById('nightKingCount').innerText = stats.nightWinner.count + " msg";
            document.getElementById('lastSeenName').innerText = stats.lastSeen.name;
            document.getElementById('lsBar1').style.width = stats.lastSeen.pct1 + "%";
            document.getElementById('lsBar2').style.width = stats.lastSeen.pct2 + "%";
            document.getElementById('lsLabel1').innerText = stats.users[0] || "A";
            document.getElementById('lsLabel2').innerText = stats.users[1] || "B";
            document.getElementById('fastReplyWinner').innerText = stats.fastReplyWinner;
            document.getElementById('fastReplyPct').innerText = stats.fastReplyPct.toFixed(0);
            document.getElementById('fastReplyBar').style.width = Math.min(stats.fastReplyPct, 100) + "%";
            document.getElementById('avgTime1').innerText = stats.avgTime[0];
            document.getElementById('avgTime2').innerText = stats.avgTime[1];
            if(document.getElementById('yapMaster')) {
                document.getElementById('yapMaster').innerText = stats.yapMaster;
                document.getElementById('alName1').innerText = stats.users[0] || "A";
                document.getElementById('alName2').innerText = stats.users[1] || "B";
                document.getElementById('avgLenVal1').innerText = stats.avgLen[0];
                document.getElementById('avgLenVal2').innerText = stats.avgLen[1];
                document.getElementById('starterKing').innerText = stats.starterKing;
                document.getElementById('starterVal1').innerText = stats.starters[0];
                document.getElementById('starterVal2').innerText = stats.starters[1];
            }
            document.getElementById('vocabPhrase1').innerText = stats.topPhrases[0].text;
            document.getElementById('vocabCount1').innerText = stats.topPhrases[0].count;
            document.getElementById('vocabPhrase2').innerText = stats.topPhrases[1].text;
            document.getElementById('vocabCount2').innerText = stats.topPhrases[1].count;
            document.getElementById('vocabPhrase3').innerText = stats.topPhrases[2].text;
            document.getElementById('vocabCount3').innerText = stats.topPhrases[2].count;
            document.getElementById('emo1').innerText = stats.emojis[0];
            document.getElementById('emo2').innerText = stats.emojis[1];
            document.getElementById('emo3').innerText = stats.emojis[2];
            document.getElementById('favEmojiName').innerText = stats.favEmojiName;
            document.getElementById('mediaPhoto').innerText = stats.media.photo;
            document.getElementById('mediaVoice').innerText = stats.media.voice;
            document.getElementById('mediaLink').innerText = stats.media.link;
            document.getElementById('mediaKing').innerText = stats.mediaKing;
            drawRadarChart(document.getElementById('chartRadar'), ["Humor","Wsparcie","Plotki","Milosc","Dramy"], [ { color: '#2E3DE3', values: stats.vibeData1 }, { color: '#FF0080', values: stats.vibeData2 } ]);
            document.getElementById('vibeMain').innerText = stats.vibeMain;
            if(document.getElementById('vibeUser1')) document.getElementById('vibeUser1').innerText = stats.users[0] || "A";
            if(document.getElementById('vibeUser2')) document.getElementById('vibeUser2').innerText = stats.users[1] || "B";
            
            const bg = document.getElementById('bgFloating'); bg.innerHTML = '';
            const emos = stats.emojis.length ? stats.emojis : ['üî•','‚ú®'];
            for(let i=0; i<15; i++) {
                const div = document.createElement('div'); div.className = 'bg-el bg-emoji';
                div.innerText = emos[i % emos.length]; div.style.left = Math.random()*90 + '%';
                div.style.animationDuration = 10 + Math.random()*15 + 's'; div.style.animationDelay = -Math.random()*20 + 's';
                bg.appendChild(div);
            }
        };

        let currentIdx = 0;
        const slides_el = document.querySelectorAll('.slide');
        const navHeader = document.getElementById('navHeader');
        slides_el.forEach(() => { const bar = document.createElement('div'); bar.className = 'progress-bar'; bar.innerHTML = '<div class="progress-fill"></div>'; navHeader.appendChild(bar); });

        function showSlide(index) {
            let idx = Math.max(0, Math.min(index, slides_el.length - 1));
            currentIdx = idx;
            const bgLayer = document.getElementById('bgFloating');
            if(bgLayer) bgLayer.classList.toggle('hidden', idx !== 0);
            slides_el.forEach((s, i) => s.classList.toggle('active', i === idx));
            const bars_el = document.querySelectorAll('.progress-bar');
            bars_el.forEach((b, i) => { b.classList.remove('active', 'filled'); if (i < idx) b.classList.add('filled'); if (i === idx) b.classList.add('active'); });
        }
        document.getElementById('btnNext').onclick = () => showSlide(currentIdx + 1);
        document.getElementById('btnPrev').onclick = () => showSlide(currentIdx - 1);
    </script>
</body>
</html>
