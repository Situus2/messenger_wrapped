<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Messenger Wrapped 2025 (Local)</title>
    
    <!-- Fonts & Libs -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;500;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@zip.js/zip.js@2.7.34/dist/zip.min.js"></script>

    <style>
        /* =========================================
           SHARED STYLES
           ========================================= */
        :root {
            --bg-deep: #000000;
            --text-white: #ffffff;
            --text-muted: rgba(255, 255, 255, 0.6);
            
            /* Kolory Premium Neon */
            --accent-1: #2E3DE3;
            --accent-2: #FF0080;
            --accent-3: #7928CA;
            --accent-gradient: linear-gradient(135deg, #FF0080 0%, #7928CA 100%);
            
            --glass-bg: rgba(20, 20, 20, 0.65);
            --glass-border: rgba(255, 255, 255, 0.1);
            --glass-highlight: rgba(255, 255, 255, 0.05);
            --glass-input: rgba(255, 255, 255, 0.03);
            --item-hover: rgba(255, 255, 255, 0.12);
            --item-selected: rgba(46, 61, 227, 0.3);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--bg-deep);
            color: var(--text-white);
            height: 100dvh;
            width: 100vw;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* --- BACKGROUND --- */
        .aurora-container {
            position: absolute; inset: 0; z-index: 0; overflow: hidden; background: #000;
        }
        .aurora-blob {
            position: absolute; border-radius: 50%; filter: blur(80px); opacity: 0.5;
            animation: drift 20s infinite alternate cubic-bezier(0.4, 0, 0.2, 1);
        }
        .blob-1 { width: 90vw; height: 90vw; background: var(--accent-1); top: -20%; left: -20%; animation-duration: 25s; }
        .blob-2 { width: 80vw; height: 80vw; background: var(--accent-2); bottom: -10%; right: -10%; animation-delay: -5s; }
        .blob-3 { width: 60vw; height: 60vw; background: var(--accent-3); top: 30%; left: 30%; animation-delay: -10s; opacity: 0.4; }

        .noise {
            position: absolute; inset: 0; z-index: 1; opacity: 0.08; pointer-events: none;
            background: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
        }
        @keyframes drift {
            0% { transform: translate(0, 0) scale(1); }
            100% { transform: translate(30px, -50px) scale(1.1); }
        }

        /* --- FLOATING DECO --- */
        .floating-layer {
            position: absolute; inset: 0; overflow: hidden; pointer-events: none; z-index: 1;
            transition: opacity 0.5s;
        }
        .floating-layer.hidden { opacity: 0; }
        
        .bg-el {
            position: absolute; opacity: 0; 
            animation: floatBG linear infinite;
        }
        .bg-emoji { font-size: 2.5rem; filter: blur(1px); opacity: 0.12 !important; }
        .bg-bubble {
            background: rgba(255,255,255,0.06); border-radius: 16px; border-bottom-left-radius: 4px;
            padding: 8px 14px; display: flex; align-items: center; justify-content: center; gap: 4px;
            width: fit-content; filter: blur(0.5px); opacity: 0.15 !important;
            border: 1px solid rgba(255,255,255,0.05);
        }
        .bg-bubble.right { border-radius: 16px; border-bottom-right-radius: 4px; background: rgba(46, 61, 227, 0.15); }
        .dot { 
            width: 5px; height: 5px; background: rgba(255,255,255,0.5); border-radius: 50%; 
            animation: dotBounce 1.4s infinite ease-in-out both; 
        }
        .dot:nth-child(1) { animation-delay: -0.32s; }
        .dot:nth-child(2) { animation-delay: -0.16s; }
        
        @keyframes floatBG { 
            0% { transform: translateY(100vh) rotate(0deg) scale(0.8); opacity: 0; } 
            10% { opacity: 0.15; }
            90% { opacity: 0.15; }
            100% { transform: translateY(-20vh) rotate(20deg) scale(1); opacity: 0; } 
        }
        @keyframes dotBounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }

        .title-deco {
            position: absolute; pointer-events: none; opacity: 0.08; z-index: 0;
            filter: blur(2px);
        }
        .deco-1 { top: 15%; left: 5%; width: 120px; transform: rotate(-15deg); }
        .deco-2 { bottom: 20%; right: -10%; width: 180px; transform: rotate(10deg); }
        .deco-3 { top: 40%; right: 10%; width: 60px; opacity: 0.15; }

        /* --- FRAME --- */
        .app-frame {
            position: relative; width: 100%; height: 100%; z-index: 10;
            display: flex; flex-direction: column; 
            align-items: center; 
            padding: 24px;
            transition: all 0.6s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        
        @media (min-width: 500px) {
            .app-frame {
                max-width: 720px; max-height: 900px;
                height: 85vh; border-radius: 40px; border: 8px solid #1a1a1a;
                box-shadow: 0 0 0 1px #333, 0 40px 100px rgba(0,0,0,0.8);
                background: #000; overflow: hidden;
            }
            .app-frame.mode-wrapped {
                max-width: 420px !important;
                height: 90vh !important;
            }
            .aurora-container { border-radius: 32px; }
            .app-frame .aurora-container { position: absolute; inset: 0; }
        }

        /* --- VIEW CONTAINERS --- */
        .view-container {
            width: 100%; height: 100%;
            display: flex; flex-direction: column;
            opacity: 1; transition: opacity 0.5s ease;
        }
        .view-container.hidden {
            display: none !important;
            opacity: 0;
        }

        /* =========================================
           HOME VIEW STYLES
           ========================================= */
        .home-content {
            display: flex; flex-direction: column; gap: 20px; width: 100%; height: 100%;
            justify-content: center;
            animation: fadeIn 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }
        h1 { font-size: 2.5rem; font-weight: 800; line-height: 1.05; letter-spacing: -1px; margin-bottom: 20px; text-align: center; }
        h2 { font-size: 1.8rem; font-weight: 700; margin-bottom: 10px; }
        
        .brand-gradient { background: var(--accent-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        .upload-card {
            background: var(--glass-bg);
            backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px);
            border: 1px solid var(--glass-border); border-top: 1px solid var(--glass-highlight);
            border-radius: 32px; padding: 30px; text-align: center;
        }
        .drop-zone {
            border: 2px dashed rgba(255,255,255,0.2);
            border-radius: 20px; padding: 40px 20px; margin: 20px 0;
            background: var(--glass-input); transition: all 0.3s ease;
            cursor: pointer; position: relative;
        }
        .drop-zone:hover, .drop-zone.dragover { border-color: #FF0080; background: rgba(255, 0, 128, 0.05); }
        .file-input { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            opacity: 0; cursor: pointer; z-index: 100;
        }
        .btn-main {
            width: 100%; padding: 18px; background: #fff; color: #000;
            border: none; border-radius: 16px; font-size: 1.1rem; font-weight: 800;
            cursor: pointer; transition: transform 0.2s, opacity 0.2s;
            opacity: 0.5; pointer-events: none;
        }
        .btn-main.ready { opacity: 1; pointer-events: auto; background: var(--accent-gradient); color: #fff; box-shadow: 0 0 30px rgba(255,0,128,0.4); }
        .btn-main:active { transform: scale(0.96); }

        /* =========================================
           LIST VIEW STYLES
           ========================================= */
        .header-section { margin-bottom: 20px; text-align: center; position: relative; z-index: 20; }
        .search-input {
            width: 100%; padding: 14px 14px 14px 45px;
            background: rgba(255,255,255,0.08); border: 1px solid var(--glass-border);
            border-radius: 16px; color: #fff; font-size: 1rem; outline: none;
        }
        .chat-list-container {
            flex: 1; overflow-y: auto; margin-bottom: 20px; padding-right: 5px; position: relative; z-index: 20;
            scrollbar-width: thin; scrollbar-color: rgba(255,255,255,0.2) transparent;
        }
        .chat-item {
            display: flex; align-items: center; gap: 15px; padding: 12px 16px; margin-bottom: 8px;
            background: var(--glass-input); border: 1px solid transparent; border-radius: 18px;
            cursor: pointer; transition: all 0.2s ease; opacity: 0; animation: fadeInItem 0.5s forwards;
        }
        .chat-item:hover { background: var(--item-hover); transform: translateX(2px); }
        .chat-item.selected { background: var(--item-selected); border-color: var(--accent-1); }
        .avatar {
            width: 48px; height: 48px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-weight: 700; color: #fff; flex-shrink: 0;
        }
        .chat-info { flex: 1; min-width: 0; }
        .chat-name { font-weight: 700; color: #fff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .chat-meta { font-size: 0.8rem; color: var(--text-muted); }
        .btn-next {
            width: 100%; padding: 18px; background: var(--accent-gradient); color: #fff;
            border: none; border-radius: 100px; font-size: 1.1rem; font-weight: 800; cursor: pointer;
            box-shadow: 0 0 30px rgba(255, 0, 128, 0.3); opacity: 0.5; pointer-events: none; filter: grayscale(0.8);
            transition: all 0.3s;
        }
        .btn-next.active { opacity: 1; pointer-events: auto; filter: grayscale(0); }

        /* Exit Animation Classes */
        .app-frame.exit-active .header-section,
        .app-frame.exit-active .chat-list-container,
        .app-frame.exit-active .footer-section {
            opacity: 0; filter: blur(15px); transform: scale(0.95) translateY(30px);
            transition: all 1.2s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .app-frame.exit-active .header-section { transition-delay: 0ms; }
        .app-frame.exit-active .chat-list-container { transition-delay: 100ms; }
        .app-frame.exit-active .footer-section { transition-delay: 200ms; }

        .reveal-sparkle {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0) rotate(-45deg);
            font-size: 6rem; z-index: 300; opacity: 0; pointer-events: none;
            transition: all 1s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .reveal-sparkle.active { transform: translate(-50%, -50%) scale(1) rotate(0deg); opacity: 1; }
        .reveal-sparkle.hidden { display: none; }

        /* =========================================
           WRAPPED VIEW STYLES (UPDATED)
           ========================================= */
        .nav-header { position: absolute; top: 0; left: 0; width: 100%; padding: 20px 12px; z-index: 20; display: flex; gap: 4px; }
        .progress-bar { flex: 1; height: 3px; background: rgba(255,255,255,0.2); border-radius: 4px; overflow: hidden; }
        .progress-fill { height: 100%; width: 0%; background: #fff; border-radius: 4px; transition: width 0.1s linear; }
        .progress-bar.filled .progress-fill { width: 100%; }
        .progress-bar.active .progress-fill { width: 100%; }

        .slide {
            position: absolute; inset: 0; padding: 90px 24px 40px;
            display: flex; flex-direction: column; justify-content: center;
            opacity: 0; pointer-events: none; transition: opacity 0.6s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .slide.active { opacity: 1; pointer-events: auto; }
        .anim-item { opacity: 0; transform: translateY(30px); transition: all 0.8s cubic-bezier(0.16, 1, 0.3, 1); }
        .slide.active .anim-item { opacity: 1; transform: translateY(0); }
        .d-1 { transition-delay: 0.05s; } .d-2 { transition-delay: 0.15s; } .d-3 { transition-delay: 0.25s; }
        
        .huge-stat { 
            font-size: 4rem; font-weight: 800; letter-spacing: -2px; line-height: 1; margin: 15px 0 5px 0; 
            background: linear-gradient(to right, #fff, #b4b4b4); -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .label { font-size: 0.75rem; font-weight: 700; letter-spacing: 1.5px; text-transform: uppercase; color: var(--text-muted); margin-bottom: 8px; display: block; }
        .sub-text { font-size: 0.8rem; color: var(--text-muted); }
        
        /* Glass Card Refined */
        .glass-card {
            background: var(--glass-bg);
            backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px);
            border: 1px solid var(--glass-border); border-top: 1px solid var(--glass-highlight);
            border-radius: 28px; padding: 24px; margin-top: 15px;
            box-shadow: 0 20px 50px -10px rgba(0,0,0,0.6);
            position: relative; overflow: hidden;
        }
        .stat-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.08); }
        .stat-row:last-child { border-bottom: none; }
        .row-icon { font-size: 1.4rem; margin-right: 15px; width: 30px; text-align: center; }
        .row-content { flex: 1; }
        .row-value { font-weight: 700; font-size: 1.1rem; }

        .chart-wrapper { height: 220px; width: 100%; position: relative; margin: 20px 0; }
        .bar-bg { background: rgba(255,255,255,0.1); height: 8px; border-radius: 4px; overflow: hidden; display: flex; margin-top: 10px; }
        .bar-fill-1 { background: var(--accent-1); height: 100%; }
        .bar-fill-2 { background: var(--accent-2); height: 100%; }
        
        /* Media Grid */
        .media-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 10px; }
        .media-item { 
            background: rgba(255,255,255,0.05); border-radius: 16px; padding: 15px 10px; 
            text-align: center; border: 1px solid rgba(255,255,255,0.05);
        }
        .media-icon { font-size: 1.5rem; margin-bottom: 5px; display: block; }

        /* Podium */
        .podium-container {
            display: flex; justify-content: center; align-items: flex-end; gap: 10px;
            height: 250px; margin: 20px 0 40px; position: relative;
        }
        .podium-column {
            display: flex; flex-direction: column; align-items: center; justify-content: flex-end;
            width: 80px; position: relative;
        }
        .podium-bar {
            width: 100%; border-radius: 12px 12px 0 0;
            background: linear-gradient(to bottom, rgba(255,255,255,0.15), rgba(255,255,255,0.05));
            border: 1px solid rgba(255,255,255,0.2); border-bottom: none;
            display: flex; align-items: flex-end; justify-content: center;
            padding-bottom: 10px; font-weight: 800; font-size: 1.5rem; color: rgba(255,255,255,0.3);
            transform-origin: bottom; transform: scaleY(0);
        }
        .slide.active .podium-bar {
            animation: growUp 1s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }
        .bar-2 { height: 120px; animation-delay: 0.2s !important; background: linear-gradient(to bottom, rgba(46, 61, 227, 0.3), rgba(46, 61, 227, 0.1)); border-color: var(--accent-1); }
        .bar-1 { height: 160px; animation-delay: 0.4s !important; background: linear-gradient(to bottom, rgba(255, 0, 128, 0.3), rgba(255, 0, 128, 0.1)); border-color: var(--accent-2); box-shadow: 0 0 30px rgba(255,0,128,0.2); }
        .bar-3 { height: 90px; animation-delay: 0.6s !important; background: linear-gradient(to bottom, rgba(255,255,255,0.1), rgba(255,255,255,0.02)); }
        
        .podium-emoji {
            font-size: 3.5rem; margin-bottom: 10px; opacity: 0; transform: translateY(20px);
            filter: drop-shadow(0 10px 20px rgba(0,0,0,0.5));
        }
        .slide.active .podium-emoji {
            animation: popIn 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }
        .pe-2 { animation-delay: 0.8s !important; }
        .pe-1 { animation-delay: 1.0s !important; font-size: 4.5rem; margin-bottom: 15px; }
        .pe-3 { animation-delay: 1.2s !important; }

        @keyframes growUp { 0% { transform: scaleY(0); } 100% { transform: scaleY(1); } }
        @keyframes popIn { 0% { opacity: 0; transform: translateY(20px) scale(0.5); } 100% { opacity: 1; transform: translateY(0) scale(1); } }

        .tap-zone { position: absolute; top: 0; bottom: 0; width: 40%; z-index: 50; cursor: pointer; }
        .tap-left { left: 0; } .tap-right { right: 0; }

        .btn-replay {
            margin-top: 10px; padding: 16px 32px; background: #fff; color: #000;
            border: none; border-radius: 100px; font-weight: 800; cursor: pointer;
            transition: transform 0.2s; width: 100%;
        }
        .btn-secondary {
            background: transparent; color: #fff; border: 1px solid rgba(255,255,255,0.3); margin-top: 10px;
        }

        /* --- UTILS --- */
        @keyframes fadeIn { to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeInItem { 0% { opacity: 0; transform: translateY(15px); } 100% { opacity: 1; transform: translateY(0); } }

        .loader-overlay {
            position: absolute; inset: 0; background: rgba(0,0,0,0.9); backdrop-filter: blur(10px);
            z-index: 200; display: none; flex-direction: column; align-items: center; justify-content: center;
        }
        .spinner {
            width: 50px; height: 50px; border: 4px solid rgba(255,255,255,0.1); border-top: 4px solid #FF0080;
            border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .privacy-badge {
            display: flex; align-items: center; justify-content: center; gap: 8px;
            background: rgba(46, 227, 100, 0.1); border: 1px solid rgba(46, 227, 100, 0.3);
            color: #2ee364; padding: 10px 16px; border-radius: 50px;
            font-size: 0.8rem; font-weight: 600; margin: 0 auto 20px auto; width: fit-content;
        }

    </style>
</head>
<body>

    <div class="app-frame" id="appFrame">
        <!-- BACKGROUND LAYER -->
        <div class="aurora-container">
            <div class="aurora-blob blob-1"></div>
            <div class="aurora-blob blob-2"></div>
            <div class="aurora-blob blob-3"></div>
            <div class="noise"></div>
        </div>

        <!-- FLOATING LAYER (FOR WRAPPED INTRO) -->
        <div class="floating-layer hidden" id="bgFloating"></div>

        <!-- SPARKLE EFFECT -->
        <div class="reveal-sparkle" id="revealSparkle">‚ú®</div>

        <!-- VIEW 1: HOME (UPLOAD) -->
        <div class="view-container" id="viewHome">
            <div class="home-content">
                <div style="text-align: center; margin-bottom: 10px;">
                    <div style="font-size: 4rem; margin-bottom: 10px;">üëã</div>
                    <h1>Stw√≥rz swoje<br><span class="brand-gradient">WRAPPED</span></h1>
                </div>

                <div class="upload-card">
                    <div class="privacy-badge">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
                        <span>Dane sƒÖ prywatne</span>
                    </div>
                    <p style="font-size: 0.95rem; color: var(--text-muted); margin-bottom: 10px;">
                        Plik jest analizowany w Twojej przeglƒÖdarce.<br>Nic nie jest wysy≈Çane.
                    </p>

                    <div class="drop-zone" id="dropZone">
                        <input type="file" id="fileInput" class="file-input" accept=".zip">
                        <span style="font-size: 3rem; display:block; margin-bottom:15px;">üìÇ</span>
                        <h3 id="dropText" style="font-weight: 700;">Wybierz plik ZIP</h3>
                        <p style="font-size: 0.8rem; color: var(--text-muted); margin-top: 5px;">z danymi Messengera</p>
                    </div>

                    <button class="btn-main" id="btnUpload">Analizuj Plik ‚ú®</button>
                </div>
            </div>
        </div>

        <!-- VIEW 2: LIST (SELECT) -->
        <div class="view-container hidden" id="viewList">
            <div class="header-section">
                <h2>Wybierz rozmowƒô</h2>
                <p style="color:var(--text-muted); font-size:0.9rem; margin-bottom:20px;">Znaleziono <span id="chatCount">0</span> czat√≥w</p>
                
                <div style="position: relative; width: 100%;">
                    <span style="position: absolute; left: 14px; top: 50%; transform: translateY(-50%); opacity: 0.7;">üîç</span>
                    <input type="text" class="search-input" id="searchInput" placeholder="Szukaj imienia i nazwiska...">
                </div>
            </div>

            <div class="chat-list-container" id="chatList">
                <!-- Items injected here -->
            </div>

            <div class="footer-section">
                <button class="btn-next" id="btnGenerate">Generuj Wrapped üöÄ</button>
            </div>
        </div>

        <!-- VIEW 3: WRAPPED (SLIDES) -->
        <div class="view-container hidden" id="viewWrapped" style="position:relative;">
            <!-- Interface -->
            <div class="nav-header" id="navHeader"></div>
            <div class="tap-zone tap-left" id="btnPrevSlide"></div>
            <div class="tap-zone tap-right" id="btnNextSlide"></div>

            <!-- 1. INTRO -->
            <section class="slide active">
                <svg class="title-deco deco-1" viewBox="0 0 100 100" fill="white"><path d="M50 0C22.4 0 0 20 0 45C0 59.4 6.2 72.2 16.4 81.3C15.9 84.4 14.7 91.9 10.6 96.6C16.8 95.8 28.5 91.8 34.3 87.2C39.2 88.9 44.5 90 50 90C77.6 90 100 70 100 45C100 20 77.6 0 50 0Z" /></svg>
                <div class="title-deco deco-3" style="font-size: 3rem;">üëã</div>
                <div class="anim-item d-1">
                    <h2 style="color: var(--text-muted); font-size: 1.2rem;">Cze≈õƒá!</h2>
                    <h1>MESSENGER<br><span class="brand-gradient">WRAPPED</span><br>2025</h1>
                </div>
                <div class="anim-item d-2 glass-card">
                    <p style="font-size: 1.1rem; color: #fff; opacity: 0.9;">Ten rok by≈Ç pe≈Çen powiadomie≈Ñ.</p>
                    <div class="huge-stat" id="resTotal">0</div>
                    <div class="label" style="margin-top: 0;">Wiadomo≈õci ≈ÇƒÖcznie</div>
                </div>
            </section>

            <!-- 2. VERSUS -->
            <section class="slide">
                <div class="anim-item d-1">
                    <span class="label">Rywalizacja</span>
                    <h1>Bitwa na<br>s≈Çowa</h1>
                </div>
                <div class="anim-item d-2 chart-wrapper" style="height: 200px;">
                    <canvas id="chartVersus"></canvas>
                </div>
                <div class="anim-item d-3 glass-card" style="text-align: center; border-color: var(--accent-1);">
                    <p class="sub-text">Zwyciƒôzca</p>
                    <h3 id="resWinnerName" class="brand-gradient" style="font-size: 2.5rem; margin: 5px 0;">User</h3>
                    <p class="sub-text">Napisa≈Ç(a) <strong style="color:#fff" id="resWinnerPct">0%</strong> wiadomo≈õci.</p>
                </div>
            </section>

            <!-- 3. TIME -->
            <section class="slide">
                <div class="anim-item d-1">
                    <span class="label">Aktywno≈õƒá</span>
                    <h1>Zegar<br>Biologiczny</h1>
                </div>
                <div class="anim-item d-2 chart-wrapper" style="height: 250px;">
                    <canvas id="chartTime"></canvas>
                </div>
                <div class="anim-item d-3 glass-card" style="display:flex; align-items:center; gap:15px;">
                    <div style="font-size: 2rem; background: rgba(255,255,255,0.1); width: 60px; height: 60px; border-radius: 50%; display: flex; align-items:center; justify-content:center;">‚è∞</div>
                    <div>
                        <div class="label" style="margin:0">Ulubiona pora</div>
                        <div class="row-value" id="resPeakHour" style="font-size: 1.5rem;">20:00 - 21:00</div>
                    </div>
                </div>
            </section>

            <!-- 3.5. DNI TYGODNIA -->
            <section class="slide">
                <div class="anim-item d-1">
                    <span class="label">Kalendarz</span>
                    <h1>Rutyna<br>Tygodnia</h1>
                </div>
                <div class="anim-item d-2 chart-wrapper" style="height: 250px;">
                    <canvas id="chartWeekdays"></canvas>
                </div>
                <div class="anim-item d-3 glass-card" style="text-align: center;">
                    <p class="sub-text">Ulubiony dzie≈Ñ:</p>
                    <h2 id="resFavDay" style="color: var(--accent-3);">PiƒÖtek</h2>
                </div>
            </section>

            <!-- 4. NIGHT -->
            <section class="slide">
                <div class="anim-item d-1">
                    <span class="label">00:00 - 05:00</span>
                    <h1>Nocne<br>Polaki üåö</h1>
                </div>
                <div class="anim-item d-2 glass-card">
                    <div style="text-align: center; margin-bottom: 20px;">
                        <div class="huge-stat" style="font-size: 4.5rem;" id="resNightPct">0%</div>
                        <p class="sub-text">Wiadomo≈õci wys≈Çanych, gdy miasto spa≈Ço.</p>
                    </div>
                    <hr style="border:0; border-top:1px solid rgba(255,255,255,0.1); margin: 20px 0;">
                    <div class="stat-row">
                        <span class="row-icon">ü¶â</span>
                        <div class="row-content">
                            <div class="row-value" id="resNightKing" style="color: var(--accent-2);">Ty</div>
                            <div class="sub-text">G≈Ç√≥wny Nocny Marek</div>
                        </div>
                        <div style="font-weight:bold; font-size: 1.2rem;" id="resNightCount">0 msg</div>
                    </div>
                </div>
            </section>

            <!-- 5. LAST SEEN -->
            <section class="slide">
                <div class="anim-item d-1">
                    <span class="label">Dobranoc</span>
                    <h1>Last Seen<br>Champion</h1>
                </div>
                <div class="anim-item d-2 glass-card" style="text-align: center; padding: 40px 20px;">
                    <div style="font-size: 4rem; margin-bottom: 10px;">üò¥</div>
                    <h2 id="resLsName" style="font-size: 2.2rem; margin: 0; color: #fff;">User</h2>
                    <p style="margin-top: 10px; font-size: 1rem; color: var(--text-muted);">Najczƒô≈õciej ko≈Ñczy dzie≈Ñ</p>
                    <div class="bar-bg" style="margin-top: 30px; height: 12px;">
                        <div class="bar-fill-1" id="resLsBar1" style="width: 50%"></div>
                        <div class="bar-fill-2" id="resLsBar2" style="width: 50%"></div>
                    </div>
                    <div style="display:flex; justify-content:space-between; font-size:0.75rem; margin-top:5px; opacity:0.6;">
                        <span id="resLsUser1">A</span>
                        <span id="resLsUser2">B</span>
                    </div>
                </div>
            </section>

            <!-- 6. DYNAMICS -->
            <section class="slide">
                <div class="anim-item d-1">
                    <span class="label">Refleks</span>
                    <h1>Szybcy i<br>W≈õciekli</h1>
                </div>
                <div class="anim-item d-2 glass-card">
                    <div style="margin-bottom: 25px;">
                        <span class="label" style="color: var(--accent-1);">Flash Response</span>
                        <p style="font-size: 1rem; margin-bottom: 10px;">
                            <strong style="color: #fff; font-size: 1.2rem;" id="resFastWinner">Ona</strong> odpisuje szybciej!
                        </p>
                        <div class="bar-bg">
                            <div class="bar-fill-1" id="resFastBar" style="width: 75%"></div> 
                        </div>
                        <div class="sub-text" style="margin-top: 5px;"><span id="resFastPct">0</span>% Twoich wiadomo≈õci dostaje b≈ÇyskawicznƒÖ odpowied≈∫.</div>
                    </div>
                    <hr style="border:0; border-top:1px dashed rgba(255,255,255,0.15); margin: 20px 0;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div style="background: rgba(255,255,255,0.05); padding: 10px; border-radius: 12px; text-align: center;">
                            <div class="sub-text">Tw√≥j czas</div>
                            <div style="font-weight: 700; font-size: 1.2rem; color: #fff;" id="resAvg1">0 min</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.05); padding: 10px; border-radius: 12px; text-align: center;">
                            <div class="sub-text">Jej czas</div>
                            <div style="font-weight: 700; font-size: 1.2rem; color: #fff;" id="resAvg2">0 min</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 7. STYL ROZMOWY -->
            <section class="slide">
                <div class="anim-item d-1">
                    <span class="label">Komunikacja</span>
                    <h1>Styl<br>Rozmowy</h1>
                </div>
                <div class="anim-item d-2 glass-card">
                    <!-- Average Length -->
                    <div style="margin-bottom: 25px;">
                        <span class="label" style="color: var(--accent-3);">Gadatliwo≈õƒá</span>
                        <p style="font-size: 1rem; margin-bottom: 10px;">
                            <strong style="color: #fff; font-size: 1.2rem;" id="resYapMaster">User</strong> pisze esejami.
                        </p>
                        <div style="display: flex; justify-content: space-between; margin-top: 15px;">
                            <div style="text-align: center;">
                                <div class="sub-text" id="resAlName1">Ty</div>
                                <div style="font-weight: 700; font-size: 1.5rem;" id="resAvgLen1">0</div>
                                <div class="sub-text" style="font-size: 0.7rem;">s≈Ç√≥w/msg</div>
                            </div>
                            <div style="text-align: center;">
                                <div class="sub-text" id="resAlName2">Ona</div>
                                <div style="font-weight: 700; font-size: 1.5rem;" id="resAvgLen2">0</div>
                                <div class="sub-text" style="font-size: 0.7rem;">s≈Ç√≥w/msg</div>
                            </div>
                        </div>
                    </div>

                    <hr style="border:0; border-top:1px dashed rgba(255,255,255,0.15); margin: 20px 0;">

                    <!-- Starters -->
                    <div>
                        <span class="label" style="color: var(--accent-1);">Inicjatywa</span>
                        <div style="display: flex; align-items: center; justify-content: space-between;">
                            <div>
                                <p class="sub-text">Kto zaczyna?</p>
                                <div style="font-weight: 700; font-size: 1.3rem; margin-top: 5px;" id="resStarterKing">Ty</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 0.9rem;"><span id="resStarterVal1">0</span> vs <span id="resStarterVal2">0</span></div>
                                <div class="sub-text">rozpoczƒôtych rozm√≥w</div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 8. SLOWNIK -->
            <section class="slide">
                <div class="anim-item d-1">
                    <span class="label">S≈Çownik</span>
                    <h1>Ulubione<br>Zwroty</h1>
                </div>
                <div class="anim-item d-2 glass-card">
                    <p class="sub-text" style="margin-bottom: 20px;">Wasze najczƒôstsze powiedzonka:</p>
                    
                    <div style="display: flex; flex-direction: column; gap: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px;">
                            <div style="font-weight: 700; font-size: 1.2rem; color: #fff;">1. "<span id="resVocab1">...</span>"</div>
                            <div style="font-size: 0.9rem; color: var(--accent-1); font-weight: bold;" id="resVocabCount1">0</div>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px;">
                            <div style="font-weight: 700; font-size: 1.1rem; color: rgba(255,255,255,0.9);">2. "<span id="resVocab2">...</span>"</div>
                            <div style="font-size: 0.9rem; color: var(--accent-2); font-weight: bold;" id="resVocabCount2">0</div>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="font-weight: 700; font-size: 1rem; color: rgba(255,255,255,0.8);">3. "<span id="resVocab3">...</span>"</div>
                            <div style="font-size: 0.9rem; color: var(--accent-3); font-weight: bold;" id="resVocabCount3">0</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 9. EMOJI (PODIUM) -->
            <section class="slide">
                <div class="anim-item d-1">
                    <span class="label">Bez s≈Ç√≥w</span>
                    <h1>Top Emoji</h1>
                </div>
                <div class="anim-item d-2 podium-container">
                    <!-- 2nd Place -->
                    <div class="podium-column">
                        <div class="podium-emoji pe-2" id="resEmo2">ü•à</div>
                        <div class="podium-bar bar-2">2</div>
                    </div>
                    <!-- 1st Place -->
                    <div class="podium-column">
                        <div class="podium-emoji pe-1" id="resEmo1">ü•á</div>
                        <div class="podium-bar bar-1">1</div>
                    </div>
                    <!-- 3rd Place -->
                    <div class="podium-column">
                        <div class="podium-emoji pe-3" id="resEmo3">ü•â</div>
                        <div class="podium-bar bar-3">3</div>
                    </div>
                </div>
                <div class="anim-item d-3 glass-card" style="text-align: center;">
                    <p class="sub-text">Najczƒô≈õciej u≈ºywana:</p>
                    <h2 id="resFavEmojiName" style="color: var(--accent-2);">Serce</h2>
                </div>
            </section>

            <!-- 10. MEDIA (GRID) -->
            <section class="slide">
                <div class="anim-item d-1">
                    <span class="label">Galeria</span>
                    <h1>Multimedia</h1>
                </div>
                <div class="anim-item d-2 glass-card">
                    <div class="media-grid">
                        <div class="media-item">
                            <span class="media-icon">üì∏</span>
                            <div style="font-weight: 700;" id="resMediaPhoto">0</div>
                            <div style="font-size: 0.7rem; opacity: 0.7;">Foto/Wideo</div>
                        </div>
                        <div class="media-item">
                            <span class="media-icon">üé§</span>
                            <div style="font-weight: 700;" id="resMediaVoice">0</div>
                            <div style="font-size: 0.7rem; opacity: 0.7;">G≈Çosowe</div>
                        </div>
                        <div class="media-item">
                            <span class="media-icon">üîó</span>
                            <div style="font-weight: 700;" id="resMediaLink">0</div>
                            <div style="font-size: 0.7rem; opacity: 0.7;">Linki</div>
                        </div>
                    </div>
                </div>
                <p class="anim-item d-3 sub-text" style="text-align: center; margin-top: 20px;">
                    <span id="resMediaKing" style="color: #fff; font-weight: 700;">Ty</span> wys≈Ça≈Çe≈õ(a≈õ) wiƒôcej spamu.
                </p>
            </section>

            <!-- 11. VIBE -->
            <section class="slide">
                <div class="anim-item d-1">
                    <span class="label">Analiza</span>
                    <h1>Vibe Check ‚ú®</h1>
                </div>
                <div class="anim-item d-2 chart-wrapper" style="height: 300px;">
                    <canvas id="chartRadar"></canvas>
                </div>
                <div class="anim-item d-2" style="display: flex; justify-content: center; gap: 20px; font-size: 0.8rem; margin-top: 10px;">
                    <div style="color: var(--accent-1);">‚óè <span id="resVibeUser1">A</span></div>
                    <div style="color: var(--accent-2);">‚óè <span id="resVibeUser2">B</span></div>
                </div>
                <div class="anim-item d-3 glass-card" style="padding: 15px; margin-top: 20px;">
                    <p style="text-align: center; font-size: 0.95rem; color: #fff;">
                        Wasza relacja to g≈Ç√≥wnie <strong id="resVibeMain" style="color: var(--accent-3);">Humor i Wsparcie</strong>.
                    </p>
                </div>
            </section>

            <!-- 12. OUTRO -->
            <section class="slide">
                <div class="anim-item d-1" style="text-align: center;">
                    <h1 style="font-size: 4rem; margin-bottom: 10px;">2025</h1>
                    <p style="color: var(--text-muted); font-size: 1.1rem;">Dziƒôki za ka≈ºdƒÖ wiadomo≈õƒá.</p>
                </div>
                <div class="anim-item d-2" style="text-align: center; margin-top: 30px; width: 100%;">
                    <button class="btn-replay" id="btnReplay">Jeszcze raz ‚Ü∫</button>
                    <button class="btn-replay btn-secondary" id="btnBack">Wybierz inny czat üë§</button>
                </div>
            </section>
        </div>
        
        <!-- LOADER -->
        <div class="loader-overlay" id="loader">
            <div class="spinner"></div>
            <h3 style="font-weight: 700;" id="loaderText">Analizujƒô...</h3>
        </div>
    </div>

    <!-- MAIN LOGIC -->
    <script>
        console.log("App initialized. Waiting for file...");

        // --- GLOBAL STATE ---
        let zipReader = null; 
        let chatGroups = {}; 
        let slides = [];
        let currentSlideIdx = 0;
        
        // --- DOM ELEMENTS ---
        const viewHome = document.getElementById('viewHome');
        const viewList = document.getElementById('viewList');
        const viewWrapped = document.getElementById('viewWrapped');
        const appFrame = document.getElementById('appFrame');
        const loader = document.getElementById('loader');
        const loaderText = document.getElementById('loaderText');

        // Home
        const fileInput = document.getElementById('fileInput');
        const dropZone = document.getElementById('dropZone');
        const btnUpload = document.getElementById('btnUpload');
        const dropText = document.getElementById('dropText');

        // List
        const chatListEl = document.getElementById('chatList');
        const searchInput = document.getElementById('searchInput');
        const btnGenerate = document.getElementById('btnGenerate');
        const chatCountEl = document.getElementById('chatCount');

        // Wrapped
        const btnPrevSlide = document.getElementById('btnPrevSlide');
        const btnNextSlide = document.getElementById('btnNextSlide');
        const navHeader = document.getElementById('navHeader');
        const bgFloating = document.getElementById('bgFloating');
        const btnReplay = document.getElementById('btnReplay');
        const btnBack = document.getElementById('btnBack');

        // --- HELPER: DECODE TEXT ---
        function fixString(str) {
            if (!str) return "";
            try { return decodeURIComponent(escape(str)); } catch (e) { return str; }
        }
        function getInitials(name) {
            return name.split(' ').map(n => n[0]).join('').substring(0,2).toUpperCase();
        }

        // --- STEP 1: UPLOAD & ZIP PARSE ---
        let currentFile = null;

        function handleFile(file) {
            if(!file) return;
            console.log("Handling file:", file.name);
            dropText.innerText = file.name;
            dropText.style.color = "#fff";
            btnUpload.classList.add('ready');
            btnUpload.style.pointerEvents = 'auto';
            btnUpload.style.opacity = '1';
            currentFile = file;
        }

        // Drag & Drop
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault(); dropZone.classList.remove('dragover');
            if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
        });

        // Click Fallback
        dropZone.addEventListener('click', (e) => {
            if(e.target !== fileInput) fileInput.click();
        });

        // Input Change
        fileInput.addEventListener('change', (e) => { 
            if (fileInput.files && fileInput.files.length > 0) {
                handleFile(fileInput.files[0]); 
            }
        });

        // Upload Button
        btnUpload.addEventListener('click', async () => {
            if (!currentFile) { alert("Wybierz plik ZIP!"); return; }
            showLoader("Skanujƒô archiwum ZIP...");
            
            try {
                zipReader = new zip.ZipReader(new zip.BlobReader(currentFile));
                const entries = await zipReader.getEntries();
                chatGroups = {};
                
                for (const entry of entries) {
                    if (entry.directory || !entry.filename.toLowerCase().endsWith('.json') || entry.filename.startsWith('__MACOSX')) continue;

                    const pathParts = entry.filename.split('/');
                    const filename = pathParts[pathParts.length - 1]; 
                    let rawName = filename.replace('.json', '');
                    if (filename.startsWith('message_') && pathParts.length > 1) rawName = pathParts[pathParts.length - 2];

                    let cleanName = fixString(rawName.replace(/_\d+$/, ''));
                    if (['autofill_information', 'secrets', 'your_posts'].includes(cleanName.toLowerCase())) continue;

                    if (!chatGroups[cleanName]) chatGroups[cleanName] = [];
                    chatGroups[cleanName].push(entry);
                }
                
                renderChatList();
                hideLoader();
                switchView('list');

            } catch (e) {
                console.error(e);
                alert("B≈ÇƒÖd: " + e.message);
                hideLoader();
            }
        });

        // --- STEP 2: CHAT LIST ---
        let selectedChatName = null;
        
        function renderChatList(filter = "") {
            chatListEl.innerHTML = "";
            const keys = Object.keys(chatGroups).sort();
            const filtered = keys.filter(k => k.toLowerCase().includes(filter.toLowerCase()));
            chatCountEl.innerText = filtered.length;

            filtered.forEach((name, idx) => {
                const count = chatGroups[name].length; 
                const el = document.createElement('div');
                el.className = `chat-item ${selectedChatName === name ? 'selected' : ''}`;
                el.style.animationDelay = (idx * 0.03) + 's';
                el.onclick = () => {
                    selectedChatName = name;
                    renderChatList(searchInput.value); 
                    btnGenerate.classList.add('active');
                    btnGenerate.innerText = `Generuj dla: ${name} üöÄ`;
                };
                const color = "linear-gradient(135deg, #FF9A9E 0%, #FECFEF 100%)"; 
                el.innerHTML = `
                    <div class="avatar" style="background: ${color}">${getInitials(name)}</div>
                    <div class="chat-info"><div class="chat-name">${name}</div><div class="chat-meta">${count} plik√≥w</div></div>
                    <div class="select-indicator" style="width:20px;height:20px;border-radius:50%;border:2px solid rgba(255,255,255,0.3);${selectedChatName === name ? 'background:#FF0080;border-color:#FF0080' : ''}"></div>
                `;
                chatListEl.appendChild(el);
            });
        }

        searchInput.addEventListener('input', (e) => renderChatList(e.target.value));

        btnGenerate.addEventListener('click', async () => {
            if (!selectedChatName) return;
            appFrame.classList.add('exit-active');
            
            // Sparkle
            const sparkle = document.getElementById('revealSparkle');
            sparkle.classList.remove('hidden');
            setTimeout(() => sparkle.classList.add('active'), 300);

            setTimeout(async () => {
                showLoader("Analizujƒô wiadomo≈õci...");
                await processChat(selectedChatName);
                sparkle.classList.remove('active');
                setTimeout(() => sparkle.classList.add('hidden'), 500);
                appFrame.classList.remove('exit-active');
            }, 1600); 
        });

        // --- STEP 3: PROCESS & METRICS ---
        async function processChat(name) {
            const entries = chatGroups[name];
            let allMessages = [];
            let participants = new Set();
            
            for (const entry of entries) {
                try {
                    const content = await entry.getData(new zip.TextWriter());
                    const json = JSON.parse(content);
                    const msgs = json.messages || json.Messages || [];
                    
                    msgs.forEach(m => {
                        let sender = fixString(m.sender_name || m.senderName || "Unknown");
                        let text = fixString(m.content || m.text || "");
                        let ts = m.timestamp_ms || m.timestamp;
                        if (ts < 10000000000) ts *= 1000;

                        if (text.includes("ustawi≈Ç(a) Tw√≥j pseudonim") || text.includes("zmieni≈Ç(a) nazwƒô grupy") || sender === "Unknown") return;

                        let photos = (m.photos||[]).length;
                        let videos = (m.videos||[]).length;
                        let audio = (m.audio_files||[]).length + (m.audioFiles||[]).length;
                        if (m.media) m.media.forEach(i => {
                            if ((i.uri||"").match(/\.(jpg|png)$/i)) photos++;
                            if ((i.uri||"").match(/\.mp4$/i)) videos++;
                            if ((i.uri||"").match(/\.(mp3|m4a)$/i)) audio++;
                        });

                        allMessages.push({ s: sender, t: text, ts: ts, photos, videos, audio });
                        participants.add(sender);
                    });
                } catch (e) {}
            }

            allMessages.sort((a, b) => a.ts - b.ts);
            
            let users = Array.from(participants).filter(u => u.length > 0);
            if (users.length === 0) users = ["Ty", "Rozm√≥wca"];
            if (users.length === 1) users.push("Ty");

            const stats = computeStats(allMessages, users);
            fillWrappedTemplate(stats);
            hideLoader();
            switchView('wrapped');
        }

        function computeStats(msgs, users) {
            const u1 = users[0];
            const u2 = users[1] || users[0];

            let counts = {}, hours = new Array(24).fill(0), weekdays = new Array(7).fill(0);
            let nightCount = 0, nightKing = {}, lastSeen = { [u1]: 0, [u2]: 0 };
            let replyTimes = { [u1]: [], [u2]: [] }, fastReplies = { [u1]: 0, [u2]: 0 };
            let media = { photos: 0, voice: 0, links: 0 }, mediaBy = {}, emojiCounts = {};
            
            // New metrics
            let wordCounts = { [u1]: 0, [u2]: 0 };
            let starters = { [u1]: 0, [u2]: 0 };
            let vocab = {};
            const stopWords = new Set(["i", "w", "z", "na", "o", "to", "nie", "ale", "≈ºe", "siƒô", "jak", "a", "jest", "co", "za", "do", "po", "no", "tak", "ju≈º", "mam", "ty", "ma", "mi", "ci", "od", "dla"]);

            msgs.forEach((m, i) => {
                counts[m.s] = (counts[m.s] || 0) + 1;
                const date = new Date(m.ts);
                const h = date.getHours();
                hours[h]++;
                weekdays[date.getDay()]++; // 0=Sun, 6=Sat

                if (h >= 0 && h < 5) { nightCount++; nightKing[m.s] = (nightKing[m.s]||0)+1; }
                if (h >= 23) lastSeen[m.s] = (lastSeen[m.s]||0)+1;

                media.photos += m.photos + m.videos;
                media.voice += m.audio;
                if (m.t && m.t.includes('http')) media.links++;
                let mTotal = m.photos + m.videos + m.audio;
                if (mTotal > 0) mediaBy[m.s] = (mediaBy[m.s]||0)+mTotal;

                // Reply Time & Starters
                if (i > 0) {
                    const prev = msgs[i-1];
                    const diffMs = m.ts - prev.ts;
                    const diffMin = diffMs / 60000;
                    
                    if (prev.s !== m.s && diffMs < 12 * 3600 * 1000) {
                        replyTimes[m.s].push(diffMin);
                        if (diffMin < 5) fastReplies[m.s] = (fastReplies[m.s]||0)+1;
                    }
                    
                    // If gap > 2h, it's a new conversation start
                    if (diffMs > 2 * 3600 * 1000) {
                        starters[m.s] = (starters[m.s]||0) + 1;
                    }
                } else {
                    starters[m.s] = (starters[m.s]||0) + 1;
                }

                // Words & Vocab
                if (m.t) {
                    const words = m.t.split(/\s+/).filter(w => w.length > 0);
                    wordCounts[m.s] = (wordCounts[m.s] || 0) + words.length;
                    
                    words.forEach(w => {
                        const clean = w.toLowerCase().replace(/[.,?!]/g, '');
                        if (clean.length > 3 && !stopWords.has(clean)) {
                            vocab[clean] = (vocab[clean] || 0) + 1;
                        }
                    });

                    // Emoji
                    const regex = /\p{Emoji_Presentation}/gu;
                    const matches = m.t.match(regex);
                    if (matches) matches.forEach(e => emojiCounts[e] = (emojiCounts[e]||0)+1);
                }
            });

            // Post-process
            const total = msgs.length;
            const topNight = Object.keys(nightKing).reduce((a, b) => nightKing[a] > nightKing[b] ? a : b, u1);
            const topMedia = Object.keys(mediaBy).reduce((a, b) => mediaBy[a] > mediaBy[b] ? a : b, u1);
            
            const getAvg = (arr) => arr && arr.length ? (arr.reduce((a,b)=>a+b,0)/arr.length).toFixed(0) : 0;
            const avg1 = getAvg(replyTimes[u1]), avg2 = getAvg(replyTimes[u2]);
            const frWinner = (fastReplies[u1]||0) > (fastReplies[u2]||0) ? u1 : u2;
            const frPct = Math.round((Math.max(fastReplies[u1]||0, fastReplies[u2]||0) / (counts[frWinner] || 1)) * 100);

            const sortedEmojis = Object.entries(emojiCounts).sort((a, b) => b[1] - a[1]).slice(0, 3);
            const emojis = sortedEmojis.map(e => e[0]);
            
            const sortedVocab = Object.entries(vocab).sort((a, b) => b[1] - a[1]).slice(0, 3);
            
            const avgLen1 = Math.round((wordCounts[u1]||0) / (counts[u1]||1));
            const avgLen2 = Math.round((wordCounts[u2]||0) / (counts[u2]||1));
            const yapMaster = avgLen1 > avgLen2 ? u1 : u2;
            const starterKing = (starters[u1]||0) > (starters[u2]||0) ? u1 : u2;

            // Weekday stats
            const days = ["Niedziela", "Poniedzia≈Çek", "Wtorek", "≈öroda", "Czwartek", "PiƒÖtek", "Sobota"];
            const maxDayIdx = weekdays.indexOf(Math.max(...weekdays));
            const favDay = days[maxDayIdx];

            return {
                users: [u1, u2], total, msgs: [counts[u1]||0, counts[u2]||0],
                hours, weekdays, favDay,
                peakHour: `${hours.indexOf(Math.max(...hours))}:00`,
                nightPct: Math.round((nightCount/total)*100) + "%", nightWinner: { name: topNight, count: nightKing[topNight] || 0 },
                lastSeen: { name: (lastSeen[u1]||0) > (lastSeen[u2]||0) ? u1 : u2 },
                fastReply: { winner: frWinner, pct: frPct },
                avgTime: [avg1, avg2],
                emojis, media, mediaKing: topMedia,
                style: {
                    yapMaster, avgLen: [avgLen1, avgLen2],
                    starterKing, starters: [starters[u1]||0, starters[u2]||0]
                },
                vocab: sortedVocab
            };
        }

        // --- STEP 4: RENDER WRAPPED ---
        function fillWrappedTemplate(s) {
            const setT = (id, txt) => { const el = document.getElementById(id); if(el) el.innerText = txt; }
            
            setT('resTotal', s.total.toLocaleString());
            
            const winIdx = s.msgs[1] > s.msgs[0] ? 1 : 0;
            setT('resWinnerName', s.users[winIdx]);
            setT('resWinnerPct', Math.round((s.msgs[winIdx]/s.total)*100) + "%");
            initChartVersus(s.users, s.msgs);
            
            setT('resPeakHour', s.peakHour + " - " + (parseInt(s.peakHour)+1) + ":00");
            initChartTime(s.hours);
            
            // Weekdays
            initChartWeekdays(s.weekdays);
            setT('resFavDay', s.favDay);

            setT('resNightPct', s.nightPct);
            setT('resNightKing', s.nightWinner.name);
            setT('resNightCount', s.nightWinner.count + " msg");
            setT('resLsName', s.lastSeen.name);
            setT('resLsUser1', s.users[0]);
            setT('resLsUser2', s.users[1]);

            setT('resFastWinner', s.fastReply.winner);
            setT('resFastPct', s.fastReply.pct);
            document.getElementById('resFastBar').style.width = Math.min(s.fastReply.pct, 100) + "%";
            setT('resAvg1', s.avgTime[0] + " min");
            setT('resAvg2', s.avgTime[1] + " min");

            // Style
            setT('resYapMaster', s.style.yapMaster);
            setT('resAlName1', s.users[0]); setT('resAlName2', s.users[1]);
            setT('resAvgLen1', s.style.avgLen[0]); setT('resAvgLen2', s.style.avgLen[1]);
            setT('resStarterKing', s.style.starterKing);
            setT('resStarterVal1', s.style.starters[0]); setT('resStarterVal2', s.style.starters[1]);

            // Vocab
            if(s.vocab[0]) { setT('resVocab1', s.vocab[0][0]); setT('resVocabCount1', s.vocab[0][1]); }
            if(s.vocab[1]) { setT('resVocab2', s.vocab[1][0]); setT('resVocabCount2', s.vocab[1][1]); }
            if(s.vocab[2]) { setT('resVocab3', s.vocab[2][0]); setT('resVocabCount3', s.vocab[2][1]); }

            setT('resEmo1', s.emojis[0] || ".");
            setT('resEmo2', s.emojis[1] || ".");
            setT('resEmo3', s.emojis[2] || ".");
            setT('resFavEmojiName', s.emojis[0] ? "Ulubiona" : "Brak");
            
            setT('resMediaPhoto', s.media.photos);
            setT('resMediaVoice', s.media.voice);
            setT('resMediaLink', s.media.links);
            setT('resMediaKing', s.mediaKing);
            
            setT('resVibeUser1', s.users[0]);
            setT('resVibeUser2', s.users[1]);
            // Fake vibe data for visual consistency
            initChartRadar(s.users, [80,60,40,70,20], [70,80,30,90,40]);
            
            initFloatingBg(s.emojis);
            slides = document.querySelectorAll('.slide');
            initSlides();
        }

        // Charts
        function initChartVersus(labels, data) {
            new Chart(document.getElementById('chartVersus'), {
                type: 'bar',
                data: { labels: labels, datasets: [{ data: data, backgroundColor: ['#2E3DE3', '#FF0080'], borderRadius: 100, barThickness: 45 }] },
                options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: {display:false} }, scales: { x:{display:false}, y:{display:false} } }
            });
        }
        function initChartTime(data) {
            new Chart(document.getElementById('chartTime'), {
                type: 'bar',
                data: { labels: Array.from({length:24},(_,i)=>i), datasets: [{ data: data, backgroundColor: '#fff', borderRadius: 3 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: {display:false} }, scales: { x:{display:false}, y:{display:false} } }
            });
        }
        function initChartWeekdays(data) {
            new Chart(document.getElementById('chartWeekdays'), {
                type: 'bar',
                data: { labels: ["Nd", "Pn", "Wt", "≈ör", "Cz", "Pt", "Sb"], datasets: [{ data: data, backgroundColor: 'rgba(255,255,255,0.7)', borderRadius: 4 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: {display:false} }, scales: { x:{display:false, grid:{display:false}}, y:{display:false} } }
            });
        }
        function initChartRadar(labels, d1, d2) {
            new Chart(document.getElementById('chartRadar'), {
                type: 'radar',
                data: {
                    labels: ["Humor", "Wsparcie", "Plotki", "Mi≈Ço≈õƒá", "Dramy"],
                    datasets: [
                        { label: labels[0], data: d1, borderColor: '#2E3DE3', backgroundColor: 'rgba(46,61,227,0.2)' },
                        { label: labels[1], data: d2, borderColor: '#FF0080', backgroundColor: 'rgba(255,0,128,0.2)' }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { r: { ticks: {display:false}, grid: {color:'rgba(255,255,255,0.1)'}, pointLabels: {color:'#fff'} } }, plugins: { legend: {display:false} } }
            });
        }

        function initFloatingBg(emojis) {
            const container = document.getElementById('bgFloating');
            container.innerHTML = '';
            const list = emojis.length ? emojis : ['üíô', 'üî•'];
            const types = [...list, ...list, 'bubble', 'bubble', 'typing'];
            for(let i=0; i<18; i++) {
                const type = types[Math.floor(Math.random()*types.length)];
                const el = document.createElement('div');
                el.className = 'bg-el';
                el.style.left = (Math.random()*90 + 5) + '%';
                el.style.animationDuration = (15 + Math.random()*15) + 's';
                el.style.animationDelay = (-Math.random()*20) + 's';
                if(type === 'bubble' || type === 'typing') {
                    el.className += ' bg-bubble';
                    if(Math.random()>0.5) el.className += ' right';
                    if(type === 'typing') el.innerHTML = '<div class="dot"></div><div class="dot"></div><div class="dot"></div>';
                    else { el.style.width = (30+Math.random()*30)+'px'; el.style.height='18px'; }
                } else { el.className += ' bg-emoji'; el.innerText = type; }
                container.appendChild(el);
            }
        }

        // Slides Logic
        function initSlides() {
            currentSlideIdx = 0;
            navHeader.innerHTML = '';
            slides.forEach(() => {
                const b = document.createElement('div'); b.className = 'progress-bar';
                b.innerHTML = '<div class="progress-fill"></div>';
                navHeader.appendChild(b);
            });
            updateSlide();
        }
        function updateSlide() {
            if(currentSlideIdx === 0) bgFloating.classList.remove('hidden');
            else bgFloating.classList.add('hidden');
            slides.forEach((s, i) => s.classList.toggle('active', i === currentSlideIdx));
            const bars = document.querySelectorAll('.progress-bar');
            bars.forEach((b, i) => {
                b.classList.remove('active', 'filled');
                if (i < currentSlideIdx) b.classList.add('filled');
                if (i === currentSlideIdx) b.classList.add('active');
            });
        }
        btnPrevSlide.onclick = () => { if(currentSlideIdx > 0) { currentSlideIdx--; updateSlide(); }};
        btnNextSlide.onclick = () => { if(currentSlideIdx < slides.length-1) { currentSlideIdx++; updateSlide(); }};
        document.addEventListener('keydown', e => {
            if(viewWrapped.classList.contains('hidden')) return;
            if(e.key === "ArrowRight" && currentSlideIdx < slides.length-1) { currentSlideIdx++; updateSlide(); }
            if(e.key === "ArrowLeft" && currentSlideIdx > 0) { currentSlideIdx--; updateSlide(); }
        });

        btnReplay.onclick = () => { currentSlideIdx = 0; updateSlide(); };
        btnBack.onclick = () => {
            appFrame.classList.remove('exit-active');
            switchView('list');
        };

        // --- UTILS ---
        function switchView(name) {
            viewHome.classList.add('hidden');
            viewList.classList.add('hidden');
            viewWrapped.classList.add('hidden');
            appFrame.classList.remove('mode-wrapped');
            if(name === 'home') viewHome.classList.remove('hidden');
            if(name === 'list') viewList.classList.remove('hidden');
            if(name === 'wrapped') { viewWrapped.classList.remove('hidden'); appFrame.classList.add('mode-wrapped'); }
        }
        function showLoader(msg) { loader.style.display = 'flex'; loaderText.innerText = msg; }
        function hideLoader() { loader.style.display = 'none'; }

    </script>
</body>
</html>